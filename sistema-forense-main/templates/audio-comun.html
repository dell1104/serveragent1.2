<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Com√∫n - Transcripci√≥n</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style_modern.css') }}}">
    <link rel="stylesheet" href="{{ url_for('static', filename='forms.css') }}}">
    <style>
        .tab-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .tab-header {
            display: flex;
            background: #f8f9fa;
            border-radius: 10px 10px 0 0;
            overflow: hidden;
            margin-bottom: 0;
        }
        
        .tab-button {
            flex: 1;
            padding: 15px 20px;
            background: #e9ecef;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 500;
            color: #495057;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        
        .tab-button.active {
            background: white;
            color: #2c3e50;
            border-bottom-color: #3498db;
        }
        
        .tab-button:hover:not(.active) {
            background: #dee2e6;
        }
        
        .tab-content {
            background: white;
            border-radius: 0 0 10px 10px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            min-height: 600px;
        }
        
        .tab-panel {
            display: none;
            width: 100%;
        }
        
        .tab-panel.active {
            display: block;
            width: 100%;
        }
        
        .tab-content {
            width: 100%;
            min-height: 400px;
        }
        
        .verificacion-message {
            margin: 20px 0;
        }
        
        .verificacion-message .alert {
            border-radius: 8px;
            padding: 20px;
        }
        
        .verificacion-message h4 {
            margin-top: 0;
            color: #2c3e50;
        }
        
        .verificacion-message ol {
            margin-bottom: 0;
        }
        
        /* Contenedor principal para layout lado a lado */
        .verification-main-container {
            display: flex;
            gap: 15px;
            align-items: flex-start;
            max-width: 100%;
        }
        
        .verification-main-container .playlist-container {
            margin-top: 0;
        }
        
        .verification-area {
            flex: 1;
            min-width: 0;
        }
        
        /* Estilos para Playlist */
        .playlist-container {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #e9ecef;
            width: 280px;
            flex-shrink: 0;
        }
        
        .playlist-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px;
            background: white;
            border-radius: 6px;
            font-size: 12px;
        }
        
        .playlist-controls {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .playlist-controls .btn {
            padding: 4px 8px;
            font-size: 11px;
        }
        
        .playlist-list {
            max-height: 180px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            background: white;
        }
        
        .playlist-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 10px;
            border-bottom: 1px solid #f1f3f4;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 11px;
        }
        
        .playlist-item:hover {
            background-color: #f8f9fa;
        }
        
        .playlist-item.active {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
        }
        
        .playlist-item.verificado {
            background-color: #e8f5e8;
            border-left: 4px solid #4caf50;
        }
        
        .playlist-item.verificado .status-badge {
            background-color: #4caf50;
            color: white;
        }
        
        .status-badge {
            background-color: #ffc107;
            color: #212529;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 500;
        }
        
        .playlist-item-info {
            flex: 1;
        }
        
        .playlist-item-name {
            font-weight: 500;
            margin-bottom: 2px;
        }
        
        .playlist-item-hash {
            font-size: 0.8em;
            color: #6c757d;
            font-family: monospace;
        }
        
        .section-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 5px solid #3498db;
        }
        
        .section-title {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
            font-weight: 600;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #495057;
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-success:hover {
            background: #229954;
        }
        
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        
        .btn-info:hover {
            background: #138496;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-warning:hover {
            background: #e0a800;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .results-container {
            margin-top: 20px;
        }
        
        .result-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .result-item.success {
            border-left: 5px solid #27ae60;
        }
        
        .result-item.error {
            border-left: 5px solid #e74c3c;
        }
        
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-weight: 500;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .file-input-container {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .archivo-info {
            color: #28a745;
            font-weight: bold;
            font-size: 14px;
        }
        
        .verificacion-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 20px;
        }
        
        .audio-player-container, .transcript-editor-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .player-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .keyboard-hint {
            font-size: 10px;
            color: #666;
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: bold;
        }
        
        .expediente-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .expediente-container .form-control {
            flex: 1;
        }
        
        .expediente-selector {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .expediente-selector select {
            flex: 1;
        }
        
        .file-input-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 500;
        }
        
        .badge-info {
            background-color: #17a2b8;
            color: white;
        }
        
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid transparent;
            border-radius: 4px;
        }
        
        .alert-info {
            color: #31708f;
            background-color: #d9edf7;
            border-color: #bce8f1;
        }
        
        .archivos-lista {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            background: #f9f9f9;
        }
        
        .archivo-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin: 5px 0;
            background: white;
            border-radius: 3px;
            border: 1px solid #e0e0e0;
        }
        
        .archivo-item.transcripcion-existe {
            background: #d4edda;
            border-color: #c3e6cb;
        }
        
        .archivo-item.transcripcion-no-existe {
            background: #f8d7da;
            border-color: #f5c6cb;
        }
        
        .speed-control {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .transcript-textarea {
            width: 100%;
            height: 300px;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            resize: vertical;
            background: white;
        }
        
        .editor-controls {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .back-button {
            margin-bottom: 20px;
        }
        
        .text-muted {
            color: #6c757d;
            font-size: 0.875em;
        }
        
        .progress-container {
            display: none;
            margin: 20px 0;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #3498db;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .results-container {
            margin-top: 20px;
        }
        
        .result-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
        }
        
        .result-item.success {
            border-left: 4px solid #27ae60;
        }
        
        .result-item.error {
            border-left: 4px solid #e74c3c;
        }
        
        .file-info {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .transcripcion-text {
            background: white;
            border: 1px solid #bdc3c7;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .hash-info {
            font-family: monospace;
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid transparent;
            border-radius: 5px;
        }
        
        .alert-success {
            color: #155724;
            background-color: #d4edda;
            border-color: #c3e6cb;
        }
        
        .alert-danger {
            color: #721c24;
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }
        
        .alert-info {
            color: #0c5460;
            background-color: #d1ecf1;
            border-color: #bee5eb;
        }
        
        .alert-warning {
            color: #856404;
            background-color: #fff3cd;
            border-color: #ffeaa7;
        }
        
        .btn-back {
            background: #95a5a6;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            text-decoration: none;
            font-size: 1em;
            transition: all 0.3s ease;
        }
        
        .btn-back:hover {
            background: #7f8c8d;
            transform: translateY(-2px);
        }
        
        @media (max-width: 768px) {
            .verificacion-content {
                grid-template-columns: 1fr;
            }
            
            .tab-header {
                flex-direction: column;
            }
            
            .tab-button {
                border-radius: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="tab-container">
            <div class="back-button">
                <a href="{{ url_for('audio_menu') }}" class="btn-back">‚Üê Volver a Audio</a>
            </div>
            
            <div class="tab-header">
                <button class="tab-button active" onclick="showTab('transcripcion')">
                    üéµ Transcripci√≥n
                </button>
                <button class="tab-button" onclick="showTab('verificacion')">
                    ‚úÖ Verificaci√≥n
                </button>
            </div>
            
            <div class="tab-content">
                <!-- Pesta√±a de Transcripci√≥n -->
                <div id="transcripcion" class="tab-panel active">
                    <div class="section-card">
                        <h2 class="section-title">üéµ Transcripci√≥n de Audios</h2>
                        
                        
                        <div class="form-group">
                            <label for="expediente-selector">Expediente Activo:</label>
                            <div class="expediente-selector">
                                <select id="expediente-selector" class="form-control" onchange="establecerRutaPorDefecto()">
                                    <option value="">Seleccionar expediente...</option>
                                </select>
                                <button class="btn btn-secondary" onclick="buscarExpediente()">üîç Buscar</button>
                            </div>
                        </div>
                        
                        <div class="form-group" id="busqueda-manual" style="display: none;">
                            <label for="expediente-manual">N√∫mero de Expediente:</label>
                            <input type="text" id="expediente-manual" class="form-control" placeholder="Ej: P-1234/25">
                            <button class="btn btn-primary" onclick="cargarExpedienteManual()">Cargar Expediente</button>
                        </div>
                        
                        <!-- Informaci√≥n del expediente seleccionado -->
                        <div id="expediente-info" class="alert alert-info" style="display: none;">
                            <h4>üìã Informaci√≥n del Expediente Activo</h4>
                            <p><strong>Expediente:</strong> <span id="expediente-numero"></span></p>
                            <p><strong>N√∫mero de Informe:</strong> <span id="numero-informe"></span></p>
                            <p><strong>Ruta de Destino:</strong> <code>casos_data/<span id="sesion-id"></span>/evidencia_en_proceso/</code></p>
                            <p><em>Los archivos de transcripci√≥n se guardar√°n autom√°ticamente en esta ubicaci√≥n.</em></p>
                        </div>
                        
                        <div class="form-group">
                            <label for="audio-files">Seleccionar archivo(s) de audio:</label>
                            <div class="file-input-container">
                                <input type="file" id="audio-files" class="form-control" accept="audio/*" multiple style="display: none;" onchange="actualizarContadorArchivos()">
                                <button class="btn btn-primary" onclick="document.getElementById('audio-files').click()">
                                    üìÅ Examinar Archivos
                                </button>
                                <span id="contador-archivos" class="badge badge-info" style="display: none;">0 archivos seleccionados</span>
                            </div>
                            <small>Selecciona archivos de audio para transcribir</small>
                        </div>
                        
                        
                        <button class="btn btn-success" onclick="transcribirAudios()">
                            üéµ Transcribir Audios
                        </button>
                        <button class="btn btn-danger" onclick="limpiarResultados()">
                            üóëÔ∏è Limpiar Resultados
                        </button>
                    </div>
                    
                    <!-- Progreso -->
                    <div class="progress-container" id="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill"></div>
                        </div>
                        <p id="progress-text">Procesando...</p>
                    </div>
                    
                    <!-- Resultados -->
                    <div class="results-container" id="results-container">
                        <!-- Los resultados se mostrar√°n aqu√≠ -->
                    </div>
                </div>
                
                <!-- Pesta√±a de Verificaci√≥n -->
                <div id="verificacion" class="tab-panel">
                    <div class="section-card">
                        <h2 class="section-title">‚úÖ Verificaci√≥n de Transcripciones</h2>
                        
                        <!-- Contenedor principal con playlist y reproductor lado a lado -->
                        <div class="verification-main-container">
                            <!-- Playlist de Archivos (lado izquierdo) -->
                            <div id="playlist-container" class="playlist-container" style="display: none;">
                                <h3>üìã Lista de Archivos</h3>
                                <div class="playlist-info">
                                    <span id="playlist-progress">Archivo 1 de 3</span>
                                    <span id="playlist-status" class="status-badge">Pendiente</span>
                                </div>
                                <div class="playlist-controls">
                                    <button class="btn btn-sm" onclick="playlistAnterior()" id="btn-anterior" disabled>‚èÆÔ∏è Anterior</button>
                                    <button class="btn btn-sm" onclick="playlistSiguiente()" id="btn-siguiente">Siguiente ‚è≠Ô∏è</button>
                                    <button class="btn btn-sm btn-success" onclick="marcarComoVerificado()" id="btn-verificado">‚úÖ Verificado</button>
                                </div>
                                <div class="playlist-list" id="playlist-list">
                                    <!-- Se llenar√° din√°micamente -->
                                </div>
                            </div>
                            
                            <!-- √Årea de verificaci√≥n (lado derecho) -->
                            <div class="verification-area">
                                <div class="form-group">
                                    <label for="archivo-verificar">Seleccionar archivo de audio para verificar:</label>
                                    <div class="file-input-container">
                                        <input type="file" id="archivo-verificar" class="form-control" 
                                               accept="audio/*" style="display: none;">
                                        <button class="btn btn-primary" onclick="document.getElementById('archivo-verificar').click()">
                                            üìÅ Seleccionar Archivo de Audio
                                        </button>
                                        <span id="archivo-seleccionado" class="archivo-info"></span>
                                    </div>
                                </div>
                                
                                <!-- Mensaje inicial -->
                                <div id="verificacion-inicial" class="verificacion-message">
                                    <div class="alert alert-info">
                                        <h4>üìã Instrucciones de Verificaci√≥n</h4>
                                        <p><strong>Proceso Autom√°tico:</strong></p>
                                        <ul>
                                            <li>Los archivos se cargan autom√°ticamente en la lista de la izquierda</li>
                                            <li>Navega con los botones "Anterior" y "Siguiente"</li>
                                            <li>Marca como "Verificado" cuando termines de corregir</li>
                                        </ul>
                                        <p><strong>Selecci√≥n Manual:</strong></p>
                                        <ul>
                                            <li>Solo usa "SELECCIONAR ARCHIVO DE AUDIO" si el archivo no aparece en la lista</li>
                                        </ul>
                                        <p><strong>Atajos de Teclado:</strong></p>
                                        <ul>
                                            <li><kbd>ESC</kbd> - Play/Pause | <kbd>F1</kbd> - -1s | <kbd>F2</kbd> - +1s</li>
                                        </ul>
                                    </div>
                                </div>
                                
                                <div class="verificacion-content" id="verificacion-content" style="display: none;">
                                    <!-- Reproductor de Audio -->
                                    <div class="audio-player-container">
                                <h3>üéµ Reproductor de Audio</h3>
                                <audio id="audio-player" controls style="width: 100%; margin-bottom: 10px;">
                                    Tu navegador no soporta el elemento de audio.
                                </audio>
                                <div class="player-controls">
                                    <div class="control-group">
                                        <button class="btn btn-sm" onclick="togglePlayPause()">‚èØÔ∏è Play/Pause</button>
                                        <small class="keyboard-hint">ESC</small>
                                    </div>
                                    <div class="control-group">
                                        <button class="btn btn-sm" onclick="skipBackward()">‚è™ -1s</button>
                                        <small class="keyboard-hint">F1</small>
                                    </div>
                                    <div class="control-group">
                                        <button class="btn btn-sm" onclick="skipForward()">‚è© +1s</button>
                                        <small class="keyboard-hint">F2</small>
                                    </div>
                                    <span class="speed-control">
                                        Velocidad: 
                                        <select id="speed-select" onchange="changeSpeed()">
                                            <option value="0.5">0.5x</option>
                                            <option value="0.75">0.75x</option>
                                            <option value="1" selected>1x</option>
                                            <option value="1.25">1.25x</option>
                                            <option value="1.5">1.5x</option>
                                            <option value="2">2x</option>
                                        </select>
                                    </span>
                                </div>
                            </div>
                            
                            <!-- Editor de Transcripci√≥n -->
                            <div class="transcript-editor-container">
                                <h3>üìù Editor de Transcripci√≥n</h3>
                                <div class="transcript-info">
                                    <strong>Archivo:</strong> <span id="archivo-nombre"></span><br>
                                    <strong>Hash SHA256:</strong> <span id="archivo-hash"></span>
                                </div>
                                <textarea id="transcript-editor" class="transcript-textarea" 
                                          placeholder="La transcripci√≥n aparecer√° aqu√≠..."></textarea>
                                <div class="editor-controls">
                                    <button class="btn btn-success" onclick="guardarTranscripcion()">üíæ Guardar Cambios en TXT</button>
                                    <button class="btn btn-info" onclick="insertarTimestamp()">‚è∞ Insertar Timestamp</button>
                                    <button class="btn btn-warning" onclick="resetearTranscripcion()">üîÑ Resetear</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let resultadosTranscripcion = [];
        let archivoActual = null;
        let transcripcionOriginal = '';
        let archivoSeleccionado = null;
        
        // Variables para playlist
        let playlistArchivos = [];
        let playlistIndexActual = 0;
        let archivosVerificados = new Set();
        
        // Variables para expedientes
        let expedientesDisponibles = [];
        let expedienteActual = null;
        let archivosExpediente = [];


        // Configurar selector de archivos
        function configurarSelectores() {
            // Selector de archivos de audio
            const audioFiles = document.getElementById('audio-files');
            const archivosInfo = document.getElementById('archivos-seleccionados');
            
            if (audioFiles) {
                audioFiles.addEventListener('change', function(e) {
                    const files = Array.from(e.target.files);
                    if (archivosInfo) {
                        if (files.length > 0) {
                            archivosInfo.textContent = `üìÅ ${files.length} archivo(s) seleccionado(s)`;
                        } else {
                            archivosInfo.textContent = '';
                        }
                    }
                });
            }
            
            // Selector de archivo para verificaci√≥n
            const fileInput = document.getElementById('archivo-verificar');
            const archivoInfo = document.getElementById('archivo-seleccionado');
            
            if (fileInput) {
                fileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        archivoSeleccionado = file;
                        if (archivoInfo) archivoInfo.textContent = `üìÅ ${file.name}`;
                        cargarArchivoParaVerificacion(file);
                    } else {
                        archivoSeleccionado = null;
                        if (archivoInfo) archivoInfo.textContent = '';
                        const verificacionContent = document.getElementById('verificacion-content');
                        if (verificacionContent) verificacionContent.style.display = 'none';
                    }
                });
            }
        }









        // Atajos de teclado
        document.addEventListener('keydown', function(e) {
            const verificacionContent = document.getElementById('verificacion-content');
            if (verificacionContent && verificacionContent.style.display !== 'none') {
                if (e.key === 'Escape') {
                    e.preventDefault();
                    togglePlayPause();
                } else if (e.key === 'F1') {
                    e.preventDefault();
                    skipBackward();
                } else if (e.key === 'F2') {
                    e.preventDefault();
                    skipForward();
                } else if (e.ctrlKey && e.key === 'j') {
                    e.preventDefault();
                    insertarTimestamp();
                } else if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    guardarTranscripcion();
                }
            }
        });

        // Funci√≥n para cambiar pesta√±as
        function showTab(tabName) {
            // Ocultar todas las pesta√±as
            const panels = document.querySelectorAll('.tab-panel');
            panels.forEach(panel => panel.classList.remove('active'));
            
            // Desactivar todos los botones
            const buttons = document.querySelectorAll('.tab-button');
            buttons.forEach(button => button.classList.remove('active'));
            
            // Mostrar la pesta√±a seleccionada
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // Funci√≥n para obtener la clave API desde el perfil del usuario
        function obtenerClaveAPI() {
            const clave = '{{ current_user.assemblyai_key or "" }}';
            
            console.log('Clave AssemblyAI obtenida:', clave ? 'Configurada' : 'No configurada');
            console.log('Longitud de la clave:', clave ? clave.length : 0);
            
            if (!clave || clave.trim() === '') {
                mostrarAlerta('No tienes una clave de AssemblyAI configurada. Contacta al administrador.', 'warning');
                return null;
            }
            
            return clave;
        }

        // Funci√≥n para mostrar alertas
        function mostrarAlerta(mensaje, tipo = 'info', permanente = false) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${tipo}`;
            alertDiv.style.whiteSpace = 'pre-line'; // Para mostrar saltos de l√≠nea
            alertDiv.textContent = mensaje;
            document.getElementById('results-container').insertBefore(alertDiv, document.getElementById('results-container').firstChild);
            
            // Solo se elimina autom√°ticamente si no es permanente
            if (!permanente) {
                setTimeout(() => {
                    alertDiv.remove();
                }, 5000);
            }
        }


        // Funci√≥n para actualizar progreso
        function actualizarProgreso(porcentaje, texto) {
            const progressContainer = document.getElementById('progress-container');
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');
            
            if (progressContainer) progressContainer.style.display = 'block';
            if (progressFill) progressFill.style.width = porcentaje + '%';
            if (progressText) progressText.textContent = texto;
        }

        // Funci√≥n para ocultar progreso
        function ocultarProgreso() {
            const progressContainer = document.getElementById('progress-container');
            if (progressContainer) progressContainer.style.display = 'none';
        }

        // Transcribir audios (individual o m√∫ltiples)
        async function transcribirAudios() {
            const fileInput = document.getElementById('audio-files');
            const apiKey = obtenerClaveAPI();
            const expediente = expedienteActual;
            
            if (!fileInput.files.length) {
                mostrarAlerta('Por favor seleccione al menos un archivo de audio', 'danger');
                return;
            }
            
            if (!apiKey) {
                return; // La funci√≥n obtenerClaveAPI ya mostr√≥ el mensaje de error
            }
            
            // Subir archivos
            const archivos = [];
            const totalArchivos = fileInput.files.length;
            
            try {
                actualizarProgreso(10, 'Subiendo archivos...');
                
                for (let i = 0; i < totalArchivos; i++) {
                    const file = fileInput.files[i];
                    console.log(`Subiendo archivo: ${file.name} (${file.size} bytes)`);
                    
                    const formData = new FormData();
                    formData.append('archivo', file);
                    if (expediente) {
                        formData.append('expediente', expediente);
                        formData.append('sesion_id', expediente);
                    }
                    
                    const uploadResponse = await fetch('/api/upload-audio', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (uploadResponse.ok) {
                        const uploadData = await uploadResponse.json();
                        if (uploadData.success) {
                            archivos.push(uploadData.archivo_path);
                            console.log(`Archivo subido exitosamente: ${uploadData.archivo_path}`);
                        } else {
                            console.error(`Error subiendo archivo: ${uploadData.error}`);
                            mostrarAlerta(`Error subiendo ${file.name}: ${uploadData.error}`, 'danger');
                        }
                    } else {
                        console.error(`Error HTTP subiendo archivo: ${uploadResponse.status}`);
                        mostrarAlerta(`Error subiendo ${file.name}: HTTP ${uploadResponse.status}`, 'danger');
                    }
                    
                    // Actualizar progreso de subida
                    const progresoSubida = 10 + (i + 1) / totalArchivos * 20;
                    actualizarProgreso(progresoSubida, `Procesando archivo ${i + 1}/${totalArchivos}...`);
                }
                
                if (archivos.length === 0) {
                    mostrarAlerta('No se pudieron subir los archivos', 'danger');
                    return;
                }
                
                // Transcribir archivos
                actualizarProgreso(30, `Transcribiendo ${archivos.length} archivo(s)...`);
                
                // Obtener el n√∫mero de expediente del caso seleccionado
                let numeroExpediente = expediente;
                if (expediente) {
                    const casoSeleccionado = expedientesDisponibles.find(caso => caso.sesion_id === expediente);
                    if (casoSeleccionado) {
                        numeroExpediente = casoSeleccionado.expediente;
                    }
                }
                
                const response = await fetch('/api/transcribir-lote', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        archivos: archivos,
                        assemblyai_key: apiKey,
                        caso_expediente: numeroExpediente
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    actualizarProgreso(100, 'Transcripci√≥n completada y guardada autom√°ticamente');
                    mostrarResultadosLote(result);
                    resultadosTranscripcion = result.resultados;
                } else {
                    throw new Error(result.error);
                }
                
            } catch (error) {
                mostrarAlerta('Error: ' + error.message, 'danger');
            } finally {
                setTimeout(ocultarProgreso, 2000);
            }
        }

        // Mostrar resultado individual
        function mostrarResultado(resultado, tipo) {
            const container = document.getElementById('results-container');
            const resultDiv = document.createElement('div');
            resultDiv.className = `result-item ${tipo}`;
            
            resultDiv.innerHTML = `
                <div class="file-info">üìÅ ${resultado.archivo}</div>
                <div class="hash-info">üîê SHA256: ${resultado.hash}</div>
                <div class="transcripcion-text">${resultado.transcripcion}</div>
            `;
            
            container.appendChild(resultDiv);
        }

        // Mostrar resultados de transcripci√≥n
        function mostrarResultadosLote(resultado) {
            const container = document.getElementById('results-container');
            
            // Mostrar resumen
            const resumenDiv = document.createElement('div');
            resumenDiv.className = 'alert alert-success';
            resumenDiv.innerHTML = `
                <strong>‚úÖ Transcripci√≥n completada y guardada autom√°ticamente</strong><br>
                üìÅ Archivo √∫nico generado en: <code>evidencia_en_proceso/transcripciones_completas_[timestamp].txt</code><br>
                üìä Procesados: ${resultado.total_procesados} | ‚ùå Errores: ${resultado.total_errores}<br>
                <small>üí° Puedes usar la pesta√±a "Verificaci√≥n" para corregir las transcripciones</small>
            `;
            container.appendChild(resumenDiv);
            
            // Mostrar resultados exitosos
            resultado.resultados.forEach(res => {
                mostrarResultado(res, 'success');
            });
            
            // Mostrar errores
            resultado.errores.forEach(err => {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'result-item error';
                errorDiv.innerHTML = `
                    <div class="file-info">‚ùå ${err.archivo}</div>
                    <div style="color: #e74c3c;">Error: ${err.error}</div>
                `;
                container.appendChild(errorDiv);
            });
            
            // Inicializar playlist si hay resultados exitosos
            if (resultado.resultados.length > 0) {
                inicializarPlaylist(resultado.resultados);
            }
        }

        // Descargar transcripciones
        function descargarTranscripciones() {
            if (resultadosTranscripcion.length === 0) {
                mostrarAlerta('No hay transcripciones para descargar', 'danger');
                return;
            }
            
            let contenido = `TRANSCRIPCIONES DE AUDIOS\n`;
            contenido += `Fecha: ${new Date().toLocaleString()}\n`;
            contenido += `Total de archivos: ${resultadosTranscripcion.length}\n`;
            contenido += `=${'='.repeat(50)}\n\n`;
            
            resultadosTranscripcion.forEach((resultado, index) => {
                contenido += `ARCHIVO ${index + 1}:\n`;
                contenido += `Nombre: ${resultado.archivo}\n`;
                contenido += `Hash SHA256: ${resultado.hash}\n`;
                contenido += `Transcripci√≥n:\n${resultado.transcripcion}\n`;
                contenido += `-${'-'.repeat(50)}\n\n`;
            });
            
            const blob = new Blob([contenido], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `transcripciones_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            mostrarAlerta('Transcripciones descargadas exitosamente', 'success');
        }

        // Limpiar resultados
        function limpiarResultados() {
            document.getElementById('results-container').innerHTML = '';
            resultadosTranscripcion = [];
            mostrarAlerta('Resultados limpiados', 'info');
        }

        // Configurar selector de archivo para verificaci√≥n
        function configurarSelectorVerificacion() {
            const fileInput = document.getElementById('archivo-verificar');
            const archivoInfo = document.getElementById('archivo-seleccionado');
            
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    archivoSeleccionado = file;
                    archivoInfo.textContent = `üìÅ ${file.name}`;
                    cargarArchivoParaVerificacion(file);
                } else {
                    archivoSeleccionado = null;
                    archivoInfo.textContent = '';
                    const verificacionContent = document.getElementById('verificacion-content');
                    if (verificacionContent) verificacionContent.style.display = 'none';
                }
            });
        }

        // Cargar archivo para verificaci√≥n
        async function cargarArchivoParaVerificacion(file, hash, transcripcion) {
            if (!file) return;
            
            try {
                let uploadData;
                
                // Si file es un objeto File (selecci√≥n manual), subirlo al servidor
                if (file instanceof File) {
                    const formData = new FormData();
                    formData.append('archivo', file);
                    
                    const uploadResponse = await fetch('/api/upload-audio', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!uploadResponse.ok) {
                        const errorData = await uploadResponse.json();
                        throw new Error(`Error al subir archivo: ${errorData.error || 'Error desconocido'}`);
                    }
                    
                    uploadData = await uploadResponse.json();
                } else {
                    // Si file es un string (desde playlist), usar datos existentes
                    uploadData = {
                        success: true,
                        filename: file,
                        archivo_path: `/casos_data/${expedienteActual}/archivos_aportados/${file}`
                    };
                }
                
                let fileHash, transcripcionExistente;
                
                // Si vienen par√°metros hash y transcripcion (desde playlist), usarlos
                if (hash && transcripcion !== undefined) {
                    fileHash = hash;
                    transcripcionExistente = {
                        archivo: file,
                        hash: hash,
                        transcripcion: transcripcion
                    };
                } else {
                    // Calcular hash del archivo
                    const hashResponse = await fetch('/api/calcular-hash-archivo', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            archivo_path: uploadData.archivo_path
                        })
                    });
                    
                    const hashResult = await hashResponse.json();
                    
                    if (!hashResult.success) {
                        throw new Error('Error al calcular hash');
                    }
                    
                    fileHash = hashResult.hash;
                    
                    // Buscar si ya existe una transcripci√≥n para este archivo
                    const nombreArchivo = file instanceof File ? file.name : file;
                    // Primero buscar por nombre exacto
                    transcripcionExistente = resultadosTranscripcion.find(r => r.archivo === nombreArchivo);
                    
                    // Si no se encuentra, buscar por nombre base (sin timestamp)
                    if (!transcripcionExistente) {
                        const nombreBase = nombreArchivo.replace(/_\d{8}_\d{6}\./, '.');
                        transcripcionExistente = resultadosTranscripcion.find(r => {
                            const nombreBaseResultado = r.archivo.replace(/_\d{8}_\d{6}\./, '.');
                            return nombreBaseResultado === nombreBase;
                        });
                    }
                }
                
                // Si no se encuentra en la sesi√≥n actual, buscar en el servidor
                if (!transcripcionExistente) {
                    try {
                        const buscarResponse = await fetch('/api/buscar-transcripcion', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                                                    body: JSON.stringify({
                            archivo: file instanceof File ? file.name : file,
                            hash: fileHash
                        })
                        });
                        
                        if (buscarResponse.ok) {
                            const buscarData = await buscarResponse.json();
                            
                            if (buscarData.success && buscarData.transcripcion) {
                                transcripcionExistente = {
                                    archivo: file instanceof File ? file.name : file,
                                    hash: fileHash,
                                    transcripcion: buscarData.transcripcion
                                };
                            }
                        }
                    } catch (error) {
                        console.log('Error al buscar transcripci√≥n en servidor:', error);
                    }
                }
                
                // Crear objeto de archivo actual
                archivoActual = {
                    archivo: file instanceof File ? file.name : file,  // Si es File usar .name, si es string usar directamente
                    hash: fileHash,
                    transcripcion: transcripcionExistente ? transcripcionExistente.transcripcion : '',
                    archivo_path: uploadData.archivo_path
                };
                
                transcripcionOriginal = archivoActual.transcripcion;
                
                // Actualizar informaci√≥n del archivo
                document.getElementById('archivo-nombre').textContent = archivoActual.archivo;
                document.getElementById('archivo-hash').textContent = archivoActual.hash;
                
                // Cargar transcripci√≥n en el editor
                const editor = document.getElementById('transcript-editor');
                editor.value = archivoActual.transcripcion;
                
                // Configurar reproductor de audio
                const audioPlayer = document.getElementById('audio-player');
                const audioUrl = `/casos_data/${expedienteActual}/archivos_aportados/${uploadData.filename}`;
                audioPlayer.src = audioUrl;
                audioPlayer.load();
                
                // Ocultar mensaje inicial y mostrar contenido de verificaci√≥n
                const verificacionInicial = document.getElementById('verificacion-inicial');
                const verificacionContent = document.getElementById('verificacion-content');
                if (verificacionInicial) verificacionInicial.style.display = 'none';
                if (verificacionContent) verificacionContent.style.display = 'block';
                
                if (transcripcionExistente && transcripcionExistente.transcripcion) {
                    mostrarAlerta('Transcripci√≥n existente cargada', 'info', true);
                } else {
                    mostrarAlerta('Archivo cargado. No se encontr√≥ transcripci√≥n existente. Puedes crear una nueva.', 'warning', true);
                }
                
            } catch (error) {
                mostrarAlerta('Error al cargar archivo: ' + error.message, 'danger', true);
            }
        }


        // Controles del reproductor
        function togglePlayPause() {
            const audio = document.getElementById('audio-player');
            if (audio.paused) {
                audio.play();
            } else {
                audio.pause();
            }
        }

        function skipBackward() {
            const audio = document.getElementById('audio-player');
            audio.currentTime = Math.max(0, audio.currentTime - 1);
        }

        function skipForward() {
            const audio = document.getElementById('audio-player');
            audio.currentTime = Math.min(audio.duration, audio.currentTime + 1);
        }

        function changeSpeed() {
            const audio = document.getElementById('audio-player');
            const speed = document.getElementById('speed-select').value;
            audio.playbackRate = parseFloat(speed);
        }

        // Controles del editor
        function guardarTranscripcion() {
            // Actualizar la transcripci√≥n en la playlist antes de guardar
            if (archivoActual && playlistArchivos.length > 0) {
                const transcripcionActual = document.getElementById('transcript-editor').value;
                
                // Buscar y actualizar la transcripci√≥n en la playlist
                const archivoIndex = playlistArchivos.findIndex(a => a.archivo === archivoActual.archivo);
                if (archivoIndex !== -1) {
                    playlistArchivos[archivoIndex].transcripcion = transcripcionActual;
                    console.log('üìù Transcripci√≥n actualizada en playlist para:', archivoActual.archivo);
                }
            }
            
            // Llamar directamente a insertarEnTxt para guardar en el archivo
            insertarEnTxt();
        }

        function insertarTimestamp() {
            const editor = document.getElementById('transcript-editor');
            const audio = document.getElementById('audio-player');
            const tiempo = audio.currentTime || 0;
            const minutos = Math.floor(tiempo / 60);
            const segundos = Math.floor(tiempo % 60);
            const timestamp = `[${minutos}:${segundos.toString().padStart(2, '0')}] `;
            
            const posicion = editor.selectionStart;
            const texto = editor.value;
            const nuevoTexto = texto.substring(0, posicion) + timestamp + texto.substring(posicion);
            
            editor.value = nuevoTexto;
            editor.focus();
            editor.setSelectionRange(posicion + timestamp.length, posicion + timestamp.length);
        }

        function resetearTranscripcion() {
            if (confirm('¬øEst√° seguro de que desea resetear la transcripci√≥n a su estado original?')) {
                document.getElementById('transcript-editor').value = transcripcionOriginal;
                mostrarAlerta('Transcripci√≥n reseteada', 'info');
            }
        }
        
        // Funci√≥n para insertar transcripci√≥n en archivo TXT
        async function insertarEnTxt() {
            if (!archivoActual) {
                mostrarAlerta('No hay archivo cargado', 'warning');
                return;
            }
            
            const transcripcion = document.getElementById('transcript-editor').value;
            if (!transcripcion.trim()) {
                mostrarAlerta('No hay transcripci√≥n para insertar', 'warning');
                return;
            }
            
            // Validar que tenemos todos los datos necesarios
            if (!archivoActual.archivo) {
                mostrarAlerta('Error: No se encontr√≥ el nombre del archivo', 'danger');
                return;
            }
            
            if (!archivoActual.hash) {
                mostrarAlerta('Error: No se encontr√≥ el hash del archivo', 'danger');
                return;
            }
            
            console.log('üì§ Enviando datos a insertar-en-txt:', {
                archivo: archivoActual.archivo,
                hash: archivoActual.hash,
                transcripcion: transcripcion.substring(0, 50) + '...',
                sesion_id: expedienteActual
            });
            
            try {
                const response = await fetch('/api/insertar-en-txt', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        archivo: archivoActual.archivo,
                        hash: archivoActual.hash,
                        transcripcion: transcripcion,
                        sesion_id: expedienteActual  // Pasar el sesion_id del expediente actual
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    mostrarAlerta('Transcripci√≥n insertada en TXT exitosamente', 'success');
                } else {
                    throw new Error(result.error || 'Error al insertar en TXT');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarAlerta('Error al insertar en TXT: ' + error.message, 'danger');
            }
        }
        
        // Funci√≥n para cargar expediente
        async function cargarExpediente() {
            const expediente = document.getElementById('caso-expediente').value.trim();
            if (!expediente) {
                mostrarAlerta('Por favor ingresa un n√∫mero de expediente', 'warning');
                return;
            }
            
            try {
                const response = await fetch('/api/cargar-expediente', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        expediente: expediente
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    mostrarAlerta(`Expediente ${expediente} cargado exitosamente`, 'success');
                    // Aqu√≠ podr√≠as cargar archivos existentes del expediente si los hay
                } else {
                    throw new Error(result.error || 'Error al cargar expediente');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarAlerta('Error al cargar expediente: ' + error.message, 'danger');
            }
        }


        // =============================
        // FUNCIONES DE PLAYLIST
        // =============================
        
        function inicializarPlaylist(resultados) {
            playlistArchivos = resultados;
            playlistIndexActual = 0;
            archivosVerificados.clear();
            
            // Verificar que el contenedor de playlist existe
            const playlistContainer = document.getElementById('playlist-container');
            if (!playlistContainer) return;
            
            // Mostrar el contenedor de playlist
            playlistContainer.style.display = 'block';
            
            // Generar la lista de archivos
            generarListaPlaylist();
            
            // Cargar el primer archivo
            cargarArchivoPlaylist(0);
        }
        
        function generarListaPlaylist() {
            const lista = document.getElementById('playlist-list');
            if (!lista) return;
            
            lista.innerHTML = '';
            
            playlistArchivos.forEach((archivo, index) => {
                const item = document.createElement('div');
                item.className = 'playlist-item';
                item.onclick = () => cargarArchivoPlaylist(index);
                
                const esVerificado = archivosVerificados.has(archivo.archivo);
                const esActivo = index === playlistIndexActual;
                
                if (esActivo) item.classList.add('active');
                if (esVerificado) item.classList.add('verificado');
                
                item.innerHTML = `
                    <div class="playlist-item-info">
                        <div class="playlist-item-name">${archivo.archivo}</div>
                        <div class="playlist-item-hash">${archivo.hash}</div>
                    </div>
                    <span class="status-badge">${esVerificado ? 'Verificado' : 'Pendiente'}</span>
                `;
                
                lista.appendChild(item);
            });
            
            actualizarInfoPlaylist();
        }
        
        function cargarArchivoPlaylist(index) {
            if (index < 0 || index >= playlistArchivos.length) return;
            
            playlistIndexActual = index;
            const archivo = playlistArchivos[index];
            
            // Actualizar la lista visual
            generarListaPlaylist();
            
            // Cargar el archivo para verificaci√≥n
            cargarArchivoParaVerificacion(archivo.archivo, archivo.hash, archivo.transcripcion);
            
            // Ocultar mensaje inicial y mostrar contenido
            const verificacionInicial = document.getElementById('verificacion-inicial');
            const verificacionContent = document.getElementById('verificacion-content');
            
            if (verificacionInicial) verificacionInicial.style.display = 'none';
            if (verificacionContent) verificacionContent.style.display = 'block';
        }
        
        function playlistAnterior() {
            if (playlistIndexActual > 0) {
                cargarArchivoPlaylist(playlistIndexActual - 1);
            }
        }
        
        function playlistSiguiente() {
            if (playlistIndexActual < playlistArchivos.length - 1) {
                cargarArchivoPlaylist(playlistIndexActual + 1);
            }
        }
        
        function marcarComoVerificado() {
            const archivo = playlistArchivos[playlistIndexActual];
            archivosVerificados.add(archivo.archivo);
            
            // Actualizar la lista visual
            generarListaPlaylist();
            
            // Mostrar mensaje de confirmaci√≥n
            mostrarAlerta(`Archivo "${archivo.archivo}" marcado como verificado`, 'success');
            
            // Verificar si todos est√°n verificados
            if (archivosVerificados.size === playlistArchivos.length) {
                mostrarAlerta('¬°Todos los archivos han sido verificados!', 'success');
            }
        }
        
        function actualizarInfoPlaylist() {
            const total = playlistArchivos.length;
            const actual = playlistIndexActual + 1;
            const verificados = archivosVerificados.size;
            
            const progressElement = document.getElementById('playlist-progress');
            const statusElement = document.getElementById('playlist-status');
            const btnAnterior = document.getElementById('btn-anterior');
            const btnSiguiente = document.getElementById('btn-siguiente');
            const btnVerificado = document.getElementById('btn-verificado');
            
            if (progressElement) {
                progressElement.textContent = `Archivo ${actual} de ${total}`;
            }
            
            if (statusElement) {
                statusElement.textContent = 
                    archivosVerificados.has(playlistArchivos[playlistIndexActual]?.archivo) ? 'Verificado' : 'Pendiente';
            }
            
            // Actualizar botones
            if (btnAnterior) btnAnterior.disabled = playlistIndexActual === 0;
            if (btnSiguiente) btnSiguiente.disabled = playlistIndexActual === total - 1;
            
            const esVerificado = archivosVerificados.has(playlistArchivos[playlistIndexActual]?.archivo);
            if (btnVerificado) {
                btnVerificado.disabled = esVerificado;
                btnVerificado.textContent = esVerificado ? '‚úÖ Verificado' : '‚úÖ Marcar como Verificado';
            }
        }

        // Funciones para expedientes
        async function cargarExpedientesDisponibles() {
            try {
                const response = await fetch('/api/casos_completos');
                const data = await response.json();
                
                if (data.success) {
                    expedientesDisponibles = data.casos;
                    actualizarSelectorExpedientes();
                } else {
                    console.error('Error al cargar expedientes:', data.message);
                }
            } catch (error) {
                console.error('Error al cargar expedientes:', error);
            }
        }
        
        function actualizarSelectorExpedientes() {
            const selector = document.getElementById('expediente-selector');
            if (selector) {
                selector.innerHTML = '<option value="">Seleccionar expediente...</option>';
                
                expedientesDisponibles.forEach(caso => {
                    const option = document.createElement('option');
                    option.value = caso.sesion_id;
                    option.textContent = `${caso.expediente} - ${caso.nombre_caso}`;
                    selector.appendChild(option);
                });
            }
        }
        
        async function establecerRutaPorDefecto() {
            const selector = document.getElementById('expediente-selector');
            const sesionId = selector.value;
            const expedienteInfo = document.getElementById('expediente-info');
            
            if (!sesionId) {
                expedienteActual = null;
                if (expedienteInfo) {
                    expedienteInfo.style.display = 'none';
                }
                return;
            }
            
            // Buscar el caso seleccionado para obtener los datos completos
            const casoSeleccionado = expedientesDisponibles.find(caso => caso.sesion_id === sesionId);
            
            if (casoSeleccionado) {
                expedienteActual = sesionId;
                
                // Mostrar informaci√≥n del expediente
                if (expedienteInfo) {
                    document.getElementById('expediente-numero').textContent = casoSeleccionado.expediente;
                    document.getElementById('numero-informe').textContent = casoSeleccionado.numero_informe_tecnico;
                    document.getElementById('sesion-id').textContent = sesionId;
                    expedienteInfo.style.display = 'block';
                }
                
                console.log(`Expediente seleccionado: ${sesionId}`);
                
                // Buscar transcripciones existentes autom√°ticamente
                console.log('üîç Buscando transcripciones existentes autom√°ticamente...');
                try {
                    const hayTranscripciones = await cargarTranscripcionesExistentes();
                    
                    if (hayTranscripciones) {
                        console.log('‚úÖ Transcripciones existentes cargadas autom√°ticamente');
                    } else {
                        console.log('‚ÑπÔ∏è No se encontraron transcripciones existentes, listo para transcribir');
                    }
                } catch (error) {
                    console.error('‚ùå Error al buscar transcripciones existentes:', error);
                }
            }
        }
        
        function actualizarContadorArchivos() {
            const input = document.getElementById('audio-files');
            const contador = document.getElementById('contador-archivos');
            
            if (input.files.length > 0) {
                contador.textContent = `${input.files.length} archivo${input.files.length > 1 ? 's' : ''} seleccionado${input.files.length > 1 ? 's' : ''}`;
                contador.style.display = 'inline-block';
            } else {
                contador.style.display = 'none';
            }
        }
        
        
        function formatearTama√±o(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        
        function buscarExpediente() {
            const busquedaManual = document.getElementById('busqueda-manual');
            if (busquedaManual) {
                busquedaManual.style.display = busquedaManual.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        async function cargarExpedienteManual() {
            const expediente = document.getElementById('expediente-manual').value.trim();
            if (!expediente) {
                alert('Por favor ingresa un n√∫mero de expediente');
                return;
            }
            
            try {
                // Buscar el expediente existente
                const response = await fetch('/api/buscar-expediente', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ expediente: expediente })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    expedienteActual = data.sesion_id;
                    
                    // Actualizar el selector dropdown
                    const selector = document.getElementById('expediente-selector');
                    if (selector) {
                        selector.value = data.sesion_id;
                    }
                    
                    // Mostrar informaci√≥n del expediente
                    const expedienteInfo = document.getElementById('expediente-info');
                    if (expedienteInfo) {
                        document.getElementById('expediente-numero').textContent = data.expediente;
                        document.getElementById('numero-informe').textContent = data.numero_informe_tecnico;
                        document.getElementById('sesion-id').textContent = data.sesion_id;
                        expedienteInfo.style.display = 'block';
                    }
                    
                    document.getElementById('busqueda-manual').style.display = 'none';
                    
                    // Buscar transcripciones existentes autom√°ticamente
                    console.log('üîç Buscando transcripciones existentes autom√°ticamente...');
                    const hayTranscripciones = await cargarTranscripcionesExistentes();
                    
                    if (hayTranscripciones) {
                        alert(`Expediente ${expediente} encontrado. Se encontraron transcripciones existentes. Ve a la pesta√±a "Verificaci√≥n" para revisarlas.`);
                    } else {
                        alert(`Expediente ${expediente} encontrado. Ahora puedes seleccionar archivos para transcribir.`);
                    }
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error al cargar expediente:', error);
                alert('Error al cargar expediente');
            }
        }

        // Inicializar cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            configurarSelectores();
            configurarSelectorVerificacion();
            cargarExpedientesDisponibles();
        });

        // Funci√≥n para cargar transcripciones existentes desde evidencia_en_proceso
        async function cargarTranscripcionesExistentes() {
            if (!expedienteActual) {
                console.log('‚ùå No hay expediente actual seleccionado');
                return false;
            }

            try {
                console.log('üîç Buscando transcripciones existentes para:', expedienteActual);
                
                const response = await fetch(`/api/cargar-transcripciones-existentes/${expedienteActual}`, {
                    credentials: 'include'
                });
                console.log('üì° Respuesta del servidor:', response.status, response.statusText);
                
                const data = await response.json();
                console.log('üìÑ Datos recibidos:', data);
                
                if (data.success) {
                    // Mostrar estad√≠sticas si est√°n disponibles
                    if (data.estadisticas) {
                        console.log('üìä Estad√≠sticas:', data.estadisticas);
                        mostrarAlerta(`üìä Transcripciones encontradas:\n- Corregidas: ${data.estadisticas.corregidas}\n- No corregidas: ${data.estadisticas.no_corregidas}\n- Total: ${data.estadisticas.total}\n\nSe cargar√°n solo las no corregidas para verificaci√≥n.`, 'info', true);
                    }
                    
                    if (data.transcripciones && data.transcripciones.length > 0) {
                        console.log('‚úÖ Transcripciones encontradas:', data.transcripciones.length);
                        
                        // Limpiar playlist actual
                        playlistArchivos = [];
                        archivosVerificados.clear();
                        playlistIndexActual = 0;
                        
                        // Cargar las transcripciones encontradas
                        data.transcripciones.forEach(transcripcion => {
                            playlistArchivos.push({
                                archivo: transcripcion.archivo,
                                hash: transcripcion.hash,
                                transcripcion: transcripcion.transcripcion
                            });
                        });
                        
                        console.log('üìã Playlist cargada con', playlistArchivos.length, 'archivos');
                        
                        // Actualizar la interfaz
                        generarListaPlaylist();
                        
                        // Mostrar contenido de verificaci√≥n
                        const verificacionInicial = document.getElementById('verificacion-inicial');
                        const verificacionContent = document.getElementById('verificacion-content');
                        const playlistContainer = document.getElementById('playlist-container');
                        
                        console.log('üéõÔ∏è Elementos DOM encontrados:', {
                            verificacionInicial: !!verificacionInicial,
                            verificacionContent: !!verificacionContent,
                            playlistContainer: !!playlistContainer
                        });
                        
                        if (verificacionInicial) verificacionInicial.style.display = 'none';
                        if (verificacionContent) verificacionContent.style.display = 'block';
                        if (playlistContainer) playlistContainer.style.display = 'block';
                        
                        // Cargar el primer archivo autom√°ticamente
                        if (playlistArchivos.length > 0) {
                            console.log('üéµ Cargando primer archivo de la playlist...');
                            cargarArchivoPlaylist(0);
                        }
                        
                        // Mostrar mensaje en la pesta√±a de transcripci√≥n
                        mostrarAlerta(`‚úÖ Se encontraron ${data.transcripciones.length} transcripciones no corregidas. Ve a la pesta√±a "Verificaci√≥n" para revisarlas.`, 'success', true);
                        
                        return true; // Indica que se encontraron transcripciones
                    
                    } else {
                        console.log('‚ÑπÔ∏è No se encontraron transcripciones no corregidas:', data);
                        return false; // Indica que no se encontraron transcripciones
                    }
                } else {
                    console.log('‚ùå Error del servidor:', data.error);
                    return false; // Indica que hubo un error
                }
                
            } catch (error) {
                console.error('‚ùå Error al cargar transcripciones existentes:', error);
                return false;
            }
        }
    </script>
</body>
</html>
