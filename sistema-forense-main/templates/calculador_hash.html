{% extends "base_sidebar.html" %}

{% block title %}Herramientas Forenses Digitales v2.0{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Pesta√±as de navegaci√≥n -->
    <ul class="nav nav-tabs mb-4" id="herramientasTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="hash-tab" data-bs-toggle="tab" data-bs-target="#hash-pane" type="button" role="tab">
                <i class="fas fa-calculator me-2"></i>Calculador de Hash
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="forense-tab" data-bs-toggle="tab" data-bs-target="#forense-pane" type="button" role="tab">
                <i class="fas fa-search me-2"></i>An√°lisis Forense
            </button>
        </li>
    </ul>

    <div class="tab-content" id="herramientasTabsContent">
        <!-- Pesta√±a Calculador de Hash -->
        <div class="tab-pane fade show active" id="hash-pane" role="tabpanel">
            <div class="row">
                <div class="col-12">
                    <div class="card shadow">
                        <div class="card-header bg-primary text-white">
                            <h4 class="mb-0">
                                <i class="fas fa-calculator me-2"></i>Calculador de Hash de Archivos
                            </h4>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-4">
                                        <label for="archivoInput" class="form-label">Seleccionar Archivo:</label>
                                        <input type="file" class="form-control" id="archivoInput" multiple>
                                        <div class="form-text">Puede seleccionar m√∫ltiples archivos o una carpeta completa</div>
                                    </div>
                                    <div class="mb-4">
                                        <label for="rutaInput" class="form-label">Seleccionar carpeta:</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="rutaInput" 
                                                placeholder="Seleccione una carpeta..." readonly>
                                            <button class="btn btn-outline-secondary" type="button" onclick="seleccionarCarpeta()">
                                                <i class="fas fa-folder-open me-2"></i>Seleccionar
                                            </button>
                                        </div>
                                        <div class="form-text">Seleccione la carpeta a procesar</div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="algoritmoSelect" class="form-label">Algoritmo de Hash:</label>
                                        <select class="form-select" id="algoritmoSelect">
                                            <option value="md5">MD5</option>
                                            <option value="sha1">SHA-1</option>
                                            <option value="sha256" selected>SHA-256</option>
                                            <option value="sha512">SHA-512</option>
                                        </select>
                                    </div>
                                    <button class="btn btn-primary" onclick="calcularHashArchivos()">
                                        <i class="fas fa-calculator me-2"></i>Calcular Hash
                                    </button>
                                    <button class="btn btn-secondary ms-2" onclick="limpiarHash()">
                                        <i class="fas fa-trash me-2"></i>Limpiar
                                    </button>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-4">
                                        <label for="resultadoHash" class="form-label">Resultado del Hash:</label>
                                        <textarea class="form-control" id="resultadoHash" rows="8" readonly
                                            placeholder="Los hashes aparecer√°n aqu√≠..."></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <button class="btn btn-success" onclick="copiarHash()" id="copiarBtn" disabled>
                                            <i class="fas fa-copy me-2"></i>Copiar Resultados
                                        </button>
                                        <button class="btn btn-info ms-2" onclick="guardarEnCarpeta()" id="guardarBtn" disabled>
                                            <i class="fas fa-save me-2"></i>Guardar en Carpeta
                                        </button>
                                    </div>
                                    
                                    <div class="alert alert-info">
                                        <h6><i class="fas fa-info-circle me-2"></i>Informaci√≥n:</h6>
                                        <ul class="mb-0">
                                            <li><strong>MD5:</strong> 128 bits (32 caracteres hex)</li>
                                            <li><strong>SHA-1:</strong> 160 bits (40 caracteres hex)</li>
                                            <li><strong>SHA-256:</strong> 256 bits (64 caracteres hex)</li>
                                            <li><strong>SHA-512:</strong> 512 bits (128 caracteres hex)</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pesta√±a An√°lisis Forense -->
        <div class="tab-pane fade" id="forense-pane" role="tabpanel">
            <div class="row">
                <div class="col-12">
                    <div class="card shadow">
                        <div class="card-header bg-danger text-white">
                            <h4 class="mb-0">
                                <i class="fas fa-search me-2"></i>An√°lisis Forense Digital
                            </h4>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-4">
                                        <label for="imagenForense" class="form-label">Seleccionar Imagen Forense:</label>
                                        <input type="file" class="form-control" id="imagenForense" 
                                            accept=".dd,.e01,.img,.iso,.vmdk,.vhd">
                                        <div class="form-text">Formatos soportados: DD, E01, IMG, ISO, VMDK, VHD</div>
                                    </div>
                                    <div class="mb-4">
                                        <label for="tipoAnalisis" class="form-label">Tipo de An√°lisis:</label>
                                        <select class="form-select" id="tipoAnalisis">
                                            <option value="hash">Verificaci√≥n de Integridad (Hash)</option>
                                            <option value="metadata">Extracci√≥n de Metadatos</option>
                                            <option value="timeline">An√°lisis de L√≠nea de Tiempo</option>
                                            <option value="deleted">Recuperaci√≥n de Archivos Eliminados</option>
                                            <option value="registry">An√°lisis de Registro</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="hashVerificacion">
                                            <label class="form-check-label" for="hashVerificacion">
                                                Generar hash de verificaci√≥n
                                            </label>
                                        </div>
                                    </div>
                                    <button class="btn btn-danger" onclick="iniciarAnalisisForense()">
                                        <i class="fas fa-search me-2"></i>Iniciar An√°lisis
                                    </button>
                                    <button class="btn btn-warning ms-2" onclick="generarReporte()" id="reporteBtn" disabled>
                                        <i class="fas fa-file-pdf me-2"></i>Generar Reporte
                                    </button>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-4">
                                        <label for="resultadoForense" class="form-label">Resultado del An√°lisis:</label>
                                        <textarea class="form-control" id="resultadoForense" rows="8" readonly
                                            placeholder="Los resultados del an√°lisis forense aparecer√°n aqu√≠..."></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <button class="btn btn-success" onclick="copiarResultadoForense()" id="copiarForenseBtn" disabled>
                                            <i class="fas fa-copy me-2"></i>Copiar Resultados
                                        </button>
                                        <button class="btn btn-info ms-2" onclick="exportarForense()" id="exportarForenseBtn" disabled>
                                            <i class="fas fa-download me-2"></i>Exportar Reporte
                                        </button>
                                    </div>
                                    <div class="alert alert-warning">
                                        <h6><i class="fas fa-exclamation-triangle me-2"></i>Advertencia:</h6>
                                        <p class="mb-0">Esta herramienta es para uso forense profesional. Aseg√∫rese de trabajar con copias de evidencia y mantener la cadena de custodia.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para verificaci√≥n de hash -->
<div class="modal fade" id="verificarModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Verificar Hash</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="hashVerificar" class="form-label">Hash a verificar:</label>
                    <input type="text" class="form-control" id="hashVerificar" 
                        placeholder="Pegue aqu√≠ el hash que desea verificar">
                </div>
                <div class="alert alert-info">
                    <strong>Texto original:</strong><br>
                    <span id="textoOriginal"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" onclick="verificarHashCompleto()">Verificar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para seleccionar carpeta -->
<div class="modal fade" id="modalSeleccionarCarpeta" tabindex="-1" aria-labelledby="modalSeleccionarCarpetaLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalSeleccionarCarpetaLabel">
                    <i class="fas fa-folder-open me-2"></i>Seleccionar Carpeta
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-8">
                        <label for="rutaCarpetaModal" class="form-label">Ruta de la carpeta:</label>
                        <input type="text" class="form-control" id="rutaCarpetaModal" 
                            placeholder="Seleccione una carpeta..." readonly>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-grid">
                            <button class="btn btn-outline-primary" type="button" onclick="explorarCarpetas()">
                                <i class="fas fa-folder-open me-2"></i>Explorar
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="recursivoModal">
                        <label class="form-check-label" for="recursivoModal">
                            <i class="fas fa-sitemap me-1"></i>Explorar subcarpetas recursivamente
                        </label>
                    </div>
                    
                    <!-- Box informativo sobre recursivo -->
                    <div class="alert alert-info mt-3 border-0">
                        <div class="d-flex align-items-start">
                            <i class="fas fa-info-circle text-info me-2 mt-1"></i>
                            <div>
                                <strong>¬øQu√© significa "recursivo"?</strong>
                                <ul class="mb-0 mt-2 small">
                                    <li><strong>Sin recursivo:</strong> Solo procesa archivos en la carpeta principal</li>
                                    <li><strong>Con recursivo:</strong> Procesa archivos en la carpeta principal Y todas sus subcarpetas</li>
                                </ul>
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-lightbulb me-1"></i>
                                        <strong>Ejemplo:</strong> Si tienes una carpeta "Documentos" con subcarpetas "2024" y "2023", 
                                        el modo recursivo procesar√° archivos de todas las carpetas.
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="boxVerde" class="alert alert-success mt-3" style="display: none;">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-check-circle me-2"></i>
                        <div>
                            <strong>Carpeta seleccionada correctamente</strong>
                            <div class="small" id="infoCarpeta"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="confirmarSeleccionCarpeta()">
                    <i class="fas fa-check me-2"></i>Confirmar Selecci√≥n
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let archivosProcesados = [];
let resultadosForenses = [];
let rutaOrigenTemporal = null; // Variable temporal para almacenar la ruta de origen
let csvLogContent = ''; // Variable global para guardar el contenido del log CSV

// ===== FUNCIONES DE HASH DE ARCHIVOS =====

// Funci√≥n para detectar el tipo de navegador y m√©todo recomendado
function detectarNavegadorYMetodo() {
    const userAgent = navigator.userAgent.toLowerCase();
    const isChrome = userAgent.includes('chrome') && !userAgent.includes('edg');
    const isFirefox = userAgent.includes('firefox');
    const isEdge = userAgent.includes('edg');
    const isOpera = userAgent.includes('opera') || userAgent.includes('opr');
    const isSafari = userAgent.includes('safari') && !userAgent.includes('chrome');
    
    const info = {
        navegador: 'Desconocido',
        metodo: 'tradicional',
        soportaFileSystemAPI: 'showDirectoryPicker' in window,
        recomendacion: 'Usar m√©todo tradicional'
    };
    
    if (isChrome) {
        info.navegador = 'Chrome';
        info.metodo = 'fileSystemAPI';
        info.recomendacion = 'Usar File System Access API';
    } else if (isFirefox) {
        info.navegador = 'Firefox';
        info.metodo = 'tradicional';
        info.recomendacion = 'Usar m√©todo tradicional (webkitdirectory)';
    } else if (isEdge) {
        info.navegador = 'Edge';
        info.metodo = 'fileSystemAPI';
        info.recomendacion = 'Usar File System Access API';
    } else if (isOpera) {
        info.navegador = 'Opera';
        info.metodo = 'fileSystemAPI';
        info.recomendacion = 'Usar File System Access API';
    } else if (isSafari) {
        info.navegador = 'Safari';
        info.metodo = 'tradicional';
        info.recomendacion = 'Usar m√©todo tradicional (webkitdirectory)';
    }
    
    console.log('üîç Detecci√≥n de navegador:', info);
    return info;
}

// Funci√≥n para generar el contenido del log en formato CSV
function generateCsvLog(results) {
    let csv = 'Archivo,Tama√±o (MB),Algoritmo,Hash,Fecha de Procesamiento\r\n'; // Encabezados del CSV
    
    results.forEach(result => {
        // Asegurarse de que los nombres de archivo con comas est√©n entre comillas
        const fileName = `"${result.nombre.replace(/"/g, '""')}"`; 
        const sizeInMB = (result.tama√±o / (1024 * 1024)).toFixed(2);
        const fecha = new Date(result.fecha).toLocaleString();
        
        csv += `${fileName},${sizeInMB},${result.algoritmo.toUpperCase()},${result.hash},"${fecha}"\r\n`;
    });
    
    return csv;
}

function seleccionarCarpeta() {
    console.log('üìÅ Abriendo modal de selecci√≥n de carpeta...');
    
    // Limpiar campos del modal
    document.getElementById('rutaCarpetaModal').value = '';
    document.getElementById('recursivoModal').checked = false;
    
    // Ocultar box verde si existe
    const boxVerde = document.getElementById('boxVerde');
    if (boxVerde) {
        boxVerde.style.display = 'none';
    }
    
    // Mostrar el modal usando Bootstrap
    const modal = new bootstrap.Modal(document.getElementById('modalSeleccionarCarpeta'));
    modal.show();
    console.log('‚úÖ Modal mostrado correctamente');
}

// Asegurar que todas las funciones est√©n disponibles globalmente
window.seleccionarCarpeta = seleccionarCarpeta;
window.explorarCarpetas = explorarCarpetas;
window.confirmarSeleccionCarpeta = confirmarSeleccionCarpeta;
window.calcularHashArchivos = calcularHashArchivos;
window.guardarEnCarpeta = guardarEnCarpeta;
window.copiarRutaAlPortapapeles = copiarRutaAlPortapapeles;
window.abrirCarpetaOrigen = abrirCarpetaOrigen;
window.detectarNavegadorYMetodo = detectarNavegadorYMetodo;

// Event Listener para inicializaci√≥n
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Calculador de Hash inicializado correctamente');
    
    // Detectar navegador al cargar la p√°gina
    const infoNavegador = detectarNavegadorYMetodo();
    console.log(`üîç Navegador detectado: ${infoNavegador.navegador}`);
    console.log(`üì± M√©todo recomendado: ${infoNavegador.recomendacion}`);
});

// ===== FUNCIONES DE EXPLORACI√ìN DE CARPETAS =====

async function explorarCarpetas() {
    try {
        // Detectar navegador y m√©todo recomendado
        const infoNavegador = detectarNavegadorYMetodo();
        
        console.log(`üöÄ Navegador detectado: ${infoNavegador.navegador}`);
        console.log(`üì± M√©todo recomendado: ${infoNavegador.recomendacion}`);
        console.log(`üîß File System API disponible: ${infoNavegador.soportaFileSystemAPI}`);
        
        // Decidir qu√© m√©todo usar basado en la detecci√≥n
        const usarFileSystemAPI = infoNavegador.soportaFileSystemAPI && 
                                 (infoNavegador.metodo === 'fileSystemAPI');
        
        if (usarFileSystemAPI) {
            console.log('üöÄ Usando File System Access API (recomendado para este navegador)...');
            
            // Solicitar acceso al directorio
            const directoryHandle = await window.showDirectoryPicker({
                mode: 'read',
                startIn: 'documents' // Empezar en la carpeta de documentos
            });
            
            console.log('üìÅ Directory Handle obtenido:', directoryHandle);
            console.log('üìÅ Nombre del directorio:', directoryHandle.name);
            console.log('üìÅ Tipo:', directoryHandle.kind);
            
            // Intentar obtener la ruta completa si est√° disponible
            let rutaCompleta = directoryHandle.name;
            try {
                // En algunos navegadores, el directoryHandle puede tener una propiedad 'path' o similar
                if (directoryHandle.path) {
                    rutaCompleta = directoryHandle.path;
                    console.log('üìÅ Ruta completa encontrada:', rutaCompleta);
                } else {
                    console.log('‚ö†Ô∏è Ruta completa no disponible, usando solo nombre');
                }
            } catch (error) {
                console.log('‚ö†Ô∏è No se pudo obtener ruta completa:', error);
            }
            
            // Actualizar el campo de ruta en el modal
            document.getElementById('rutaCarpetaModal').value = rutaCompleta;
            
            // Mostrar informaci√≥n de la carpeta seleccionada
            mostrarInfoCarpeta(directoryHandle.name, rutaCompleta);
            
            // Guardar el directoryHandle para uso posterior
            window.directoryHandleActual = directoryHandle;
            console.log('üíæ DirectoryHandle guardado en window.directoryHandleActual');
            
            // Limpiar archivos seleccionados tradicionalmente si existen
            window.archivosSeleccionados = null;
            
        } else {
            console.log(`üîÑ Usando m√©todo tradicional (recomendado para ${infoNavegador.navegador})...`);
            console.log('üì± Navegador:', navigator.userAgent);
            // Usar m√©todo tradicional
            usarSelectorTradicional();
        }
        
    } catch (error) {
        console.log('‚ö†Ô∏è Error con el m√©todo seleccionado:', error);
        if (error.name === 'AbortError') {
            console.log('üë§ Usuario cancel√≥ la selecci√≥n');
            return;
        }
        console.log('üîÑ Fallback al m√©todo tradicional...');
        // Fallback al m√©todo tradicional
        usarSelectorTradicional();
    }
}

function usarSelectorTradicional() {
    console.log('üìÅ Usando selector tradicional de archivos...');
    
    // Crear un input de tipo directorio
    const input = document.createElement('input');
    input.type = 'file';
    input.webkitdirectory = true;
    input.multiple = true;
    
    input.onchange = function(e) {
        if (e.target.files.length > 0) {
            console.log('üìÅ Archivos seleccionados tradicionalmente:', e.target.files.length);
            
            // Obtener la ruta de la carpeta seleccionada
            const rutaCompleta = e.target.files[0].webkitRelativePath;
            const rutaCarpeta = rutaCompleta.split('/')[0];
            
            console.log('üìÅ Ruta de carpeta:', rutaCarpeta);
            console.log('üìÅ Ruta completa:', rutaCompleta);
            
            // Debug: mostrar informaci√≥n de los archivos
            console.log('üîç DEBUG - Primeros 3 archivos:');
            for (let i = 0; i < Math.min(3, e.target.files.length); i++) {
                const archivo = e.target.files[i];
                console.log(`  Archivo ${i}:`, {
                    name: archivo.name,
                    webkitRelativePath: archivo.webkitRelativePath,
                    relativePath: archivo.relativePath
                });
            }
            
            // Actualizar el campo de ruta en el modal
            document.getElementById('rutaCarpetaModal').value = rutaCarpeta;
            
            // Mostrar informaci√≥n de la carpeta seleccionada
            mostrarInfoCarpeta(rutaCarpeta, rutaCarpeta);
            
            // Guardar los archivos para uso posterior
            window.archivosSeleccionados = e.target.files;
            console.log('üíæ Archivos guardados en window.archivosSeleccionados');
            
            // Limpiar directoryHandle si existe
            window.directoryHandleActual = null;
        } else {
            console.log('‚ö†Ô∏è No se seleccionaron archivos');
        }
    };
    
    input.click();
}

function mostrarInfoCarpeta(nombreCarpeta, rutaCompleta) {
    console.log('üìÅ Mostrando informaci√≥n de carpeta:', nombreCarpeta);
    
    // Detectar informaci√≥n del navegador
    const infoNavegador = detectarNavegadorYMetodo();
    
    // Mostrar el box verde
    const boxVerde = document.getElementById('boxVerde');
    const infoCarpeta = document.getElementById('infoCarpeta');
    
    if (boxVerde && infoCarpeta) {
        infoCarpeta.innerHTML = `
            <div class="mb-1">
                <strong>Nombre:</strong> ${nombreCarpeta}
            </div>
            <div class="mb-1">
                <strong>Ruta:</strong> <code>${rutaCompleta}</code>
            </div>
            <div class="mb-1">
                <strong>Navegador:</strong> ${infoNavegador.navegador}
            </div>
            <div class="mb-1">
                <strong>M√©todo:</strong> ${infoNavegador.recomendacion}
            </div>
            <div class="mb-0">
                <i class="fas fa-check-circle text-success me-1"></i>
                <span class="text-success">Lista para procesar</span>
            </div>
        `;
        
        boxVerde.style.display = 'block';
        console.log('‚úÖ Informaci√≥n de carpeta mostrada correctamente');
    } else {
        console.error('‚ùå No se encontraron los elementos boxVerde o infoCarpeta');
    }
}

function confirmarSeleccionCarpeta() {
    console.log('‚úÖ Confirmando selecci√≥n de carpeta...');
    
    const rutaCarpeta = document.getElementById('rutaCarpetaModal').value;
    const recursivo = document.getElementById('recursivoModal').checked;
    
    if (!rutaCarpeta.trim()) {
        alert('Por favor, seleccione una carpeta antes de confirmar.');
        return;
    }
    
    // Actualizar el campo principal de ruta
    document.getElementById('rutaInput').value = rutaCarpeta;
    
    // Guardar la ruta de origen en variable temporal
    rutaOrigenTemporal = rutaCarpeta;
    console.log('üíæ Ruta de origen guardada temporalmente:', rutaOrigenTemporal);
    
    // Guardar el estado recursivo en una variable global
    window.recursivoSeleccionado = recursivo;
    console.log('üíæ Modo recursivo guardado:', window.recursivoSeleccionado);
    
    // Mostrar informaci√≥n en el formulario principal
    mostrarInfoCarpetaPrincipal(rutaCarpeta, recursivo);
    
    
    // Cerrar el modal usando Bootstrap
    const modal = bootstrap.Modal.getInstance(document.getElementById('modalSeleccionarCarpeta'));
    if (modal) {
        modal.hide();
    }
    
    console.log('‚úÖ Selecci√≥n de carpeta confirmada:', rutaCarpeta, 'Recursivo:', recursivo);
}

function mostrarInfoCarpetaPrincipal(rutaCarpeta, recursivo) {
    // Remover informaci√≥n anterior si existe
    const infoAnterior = document.querySelector('.alert-info');
    if (infoAnterior) {
        infoAnterior.remove();
    }
    
    // Crear nueva informaci√≥n
            const info = document.createElement('div');
            info.className = 'alert alert-info mt-2';
            info.innerHTML = `
                <div class="d-flex align-items-center mb-2">
                    <i class="fas fa-folder-open me-2"></i>
                    <strong>Carpeta seleccionada</strong>
                </div>
                <div class="mb-2">
                    <code class="bg-light p-2 rounded d-block">${rutaCarpeta}</code>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <small class="text-muted">
                    <i class="fas fa-sitemap me-1"></i>
                    <strong>Modo:</strong> ${recursivo ? 'Recursivo' : 'Solo carpeta principal'}
                        </small>
                    </div>
                    <div class="col-md-6">
                        <small class="text-muted">
                            <i class="fas fa-check-circle me-1"></i>
                            Lista para procesar
                        </small>
                    </div>
                </div>
            `;
            
            // Insertar despu√©s del input group
            document.getElementById('rutaInput').parentNode.parentNode.appendChild(info);
        }


// Funci√≥n para copiar la ruta al portapapeles
async function copiarRutaAlPortapapeles() {
    if (rutaOrigenTemporal) {
        try {
            await navigator.clipboard.writeText(rutaOrigenTemporal);
            alert(`‚úÖ Ruta copiada al portapapeles:\n\n${rutaOrigenTemporal}\n\nüí° Ahora puedes pegar la ruta (Ctrl+V) en el explorador de archivos.`);
        } catch (error) {
            console.error('‚ùå Error copiando al portapapeles:', error);
            alert('‚ùå Error al copiar la ruta al portapapeles. Intenta copiarla manualmente.');
        }
    }
}

// Funci√≥n para abrir la carpeta de origen
function abrirCarpetaOrigen() {
    if (rutaOrigenTemporal) {
        // Crear un enlace temporal para abrir la carpeta
        const link = document.createElement('a');
        link.href = `file:///${rutaOrigenTemporal.replace(/\\/g, '/')}`;
        link.target = '_blank';
        link.click();
        
        // Tambi√©n copiar la ruta al portapapeles
        copiarRutaAlPortapapeles();
        
        alert(`üìÅ Intentando abrir la carpeta:\n\n${rutaOrigenTemporal}\n\nüí° Si no se abre autom√°ticamente, la ruta est√° copiada en tu portapapeles para pegarla manualmente.`);
    }
}

// ===== FUNCIONES DE API PARA EXPLORAR RUTAS =====

async function explorarRutaServidor(ruta, recursivo = false) {
    try {
        console.log('üåê Explorando ruta en servidor:', ruta, 'Recursivo:', recursivo);
        
        const response = await fetch('/api/explorar-ruta', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                ruta: ruta,
                recursivo: recursivo
            })
        });
        
        if (!response.ok) {
            throw new Error(`Error del servidor: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('‚úÖ Respuesta del servidor:', data);
        
        return data;
        
    } catch (error) {
        console.error('‚ùå Error al explorar ruta en servidor:', error);
        throw error;
    }
}

async function procesarArchivosServidor(archivos, algoritmo) {
    try {
        console.log('üåê Procesando archivos en servidor:', archivos.length, 'archivos');
        
        const formData = new FormData();
        
        // Agregar archivos al FormData
        for (let i = 0; i < archivos.length; i++) {
            formData.append('archivos', archivos[i]);
        }
        
        // Agregar par√°metros
        formData.append('algoritmo', algoritmo);
        
        const response = await fetch('/api/calcular-hash', {
            method: 'POST',
            body: formData
        });
        
        if (!response.ok) {
            throw new Error(`Error del servidor: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('‚úÖ Hashes calculados en servidor:', data);
        
        return data;
        
    } catch (error) {
        console.error('‚ùå Error al procesar archivos en servidor:', error);
        throw error;
    }
}

async function obtenerArchivosDeRuta(ruta, recursivo = false) {
    try {
        console.log('üìÅ Obteniendo archivos de ruta:', ruta);
        console.log('üìÅ Recursivo:', recursivo);
        console.log('üìÅ directoryHandleActual:', window.directoryHandleActual);
        console.log('üìÅ archivosSeleccionados:', window.archivosSeleccionados);
        
        // Detectar navegador para optimizar el orden de prioridades
        const infoNavegador = detectarNavegadorYMetodo();
        console.log(`üîç Navegador detectado: ${infoNavegador.navegador}, M√©todo: ${infoNavegador.metodo}`);
        
        // Prioridad 1: Si tenemos archivos seleccionados tradicionalmente, usarlos
        if (window.archivosSeleccionados && window.archivosSeleccionados.length > 0) {
            console.log('üìÅ Usando archivos seleccionados tradicionalmente:', window.archivosSeleccionados.length);
            return Array.from(window.archivosSeleccionados);
        }
        
        // Prioridad 2: Si tenemos un directoryHandle, explorarlo (especialmente para Chrome/Edge/Opera)
        if (window.directoryHandleActual) {
            console.log('üìÅ Explorando directoryHandle');
            try {
                const archivos = await explorarDirectoryHandle(window.directoryHandleActual, recursivo);
                if (archivos.length > 0) {
                    console.log('‚úÖ Archivos encontrados con directoryHandle:', archivos.length);
                    return archivos;
                } else {
                    console.log('‚ö†Ô∏è No se encontraron archivos con directoryHandle');
                }
            } catch (error) {
                console.error('‚ùå Error explorando directoryHandle:', error);
            }
        }
        
        // Prioridad 3: Intentar con el servidor (solo si la ruta parece ser del servidor)
        if (ruta.includes('casos_data') || ruta.startsWith('/') || ruta.includes('\\')) {
            console.log('üåê Explorando ruta en servidor');
            try {
                const data = await explorarRutaServidor(ruta, recursivo);
                if (data.archivos && data.archivos.length > 0) {
                    console.log('‚úÖ Archivos encontrados con servidor:', data.archivos.length);
                    return data.archivos;
                } else {
                    console.log('‚ö†Ô∏è No se encontraron archivos con servidor');
                }
            } catch (error) {
                console.error('‚ùå Error explorando con servidor:', error);
            }
        } else {
            console.log('‚ö†Ô∏è Ruta no parece ser del servidor, saltando exploraci√≥n del servidor');
        }
        
        // Si llegamos aqu√≠, no se encontraron archivos
        console.log('‚ùå No se encontraron archivos con ning√∫n m√©todo');
        
        // Mostrar informaci√≥n espec√≠fica del navegador
        console.log(`üí° Sugerencia para ${infoNavegador.navegador}: ${infoNavegador.recomendacion}`);
        return [];
        
    } catch (error) {
        console.error('‚ùå Error al obtener archivos de ruta:', error);
        throw error;
    }
}

async function explorarDirectoryHandle(directoryHandle, recursivo = false, rutaPadre = '') {
    const archivos = [];
    
    try {
        console.log('üìÅ Explorando directoryHandle recursivamente:', recursivo);
        console.log('üìÅ DirectoryHandle:', directoryHandle);
        console.log('üìÅ Ruta padre:', rutaPadre);
        
        // Verificar que el directoryHandle sea v√°lido
        if (!directoryHandle || typeof directoryHandle.entries !== 'function') {
            console.error('‚ùå DirectoryHandle inv√°lido');
            return [];
        }
        
        let count = 0;
        for await (const [name, handle] of directoryHandle.entries()) {
            count++;
            console.log(`üìÅ Procesando entrada ${count}:`, name, 'Tipo:', handle.kind);
            
            if (handle.kind === 'file') {
                try {
                    const file = await handle.getFile();
                    
                    // Construir la ruta relativa manualmente
                    const rutaRelativa = rutaPadre ? `${rutaPadre}/${name}` : name;
                    // Usar una propiedad personalizada ya que webkitRelativePath es de solo lectura
                    file._rutaRelativa = rutaRelativa;
                    
                    archivos.push(file);
                    console.log('üìÑ Archivo encontrado:', name, 'Ruta relativa:', rutaRelativa, 'Tama√±o:', file.size);
                } catch (fileError) {
                    console.error('‚ùå Error obteniendo archivo:', name, fileError);
                }
            } else if (handle.kind === 'directory' && recursivo) {
                console.log('üìÅ Explorando subdirectorio:', name);
                try {
                    const nuevaRutaPadre = rutaPadre ? `${rutaPadre}/${name}` : name;
                    const subArchivos = await explorarDirectoryHandle(handle, recursivo, nuevaRutaPadre);
                    archivos.push(...subArchivos);
                    console.log('üìÅ Subdirectorio procesado:', name, 'Archivos:', subArchivos.length);
                } catch (subError) {
                    console.error('‚ùå Error explorando subdirectorio:', name, subError);
                }
            }
        }
        
        console.log('‚úÖ Total de archivos encontrados:', archivos.length);
        console.log('‚úÖ Total de entradas procesadas:', count);
        return archivos;
        
    } catch (error) {
        console.error('‚ùå Error al explorar directoryHandle:', error);
        console.error('‚ùå Error details:', error.message, error.stack);
        return [];
    }
}

// Verificar que la funci√≥n est√© disponible cuando se carga la p√°gina
document.addEventListener('DOMContentLoaded', function() {
    console.log('Verificando funci√≥n seleccionarCarpeta:', typeof window.seleccionarCarpeta);
    if (typeof window.seleccionarCarpeta !== 'function') {
        console.error('ERROR: seleccionarCarpeta no est√° definida');
    } else {
        console.log('‚úÖ seleccionarCarpeta est√° disponible correctamente');
    }
});

async function calcularHashArchivos() {
    const archivos = document.getElementById('archivoInput').files;
    const ruta = document.getElementById('rutaInput').value;
    const algoritmo = document.getElementById('algoritmoSelect').value;
    // Usar el valor recursivo guardado o el del modal
    const recursivo = window.recursivoSeleccionado || document.getElementById('recursivoModal').checked;
    console.log('üîç Modo recursivo detectado:', recursivo);
    
    if (archivos.length === 0 && !ruta.trim()) {
        alert('Por favor, seleccione archivos o ingrese una ruta.');
        return;
    }
    
    document.getElementById('resultadoHash').value = 'Procesando archivos...\n';
    document.getElementById('copiarBtn').disabled = true;
    document.getElementById('guardarBtn').disabled = true;
    
    let resultados = '';
    archivosProcesados = [];
    
    try {
        if (archivos.length > 0) {
            // Procesar archivos seleccionados directamente
            console.log('üìÑ Procesando archivos seleccionados:', archivos.length);
            
            for (let i = 0; i < archivos.length; i++) {
                const archivo = archivos[i];
                const hash = await calcularHashArchivo(archivo, algoritmo);
                const resultado = `${archivo.name} | ${algoritmo.toUpperCase()}: ${hash}\n`;
                resultados += resultado;
                archivosProcesados.push({
                    nombre: archivo.name,
                    ruta: archivo.webkitRelativePath || archivo.name,
                    algoritmo: algoritmo,
                    hash: hash,
                    tama√±o: archivo.size,
                    fecha: new Date(archivo.lastModified).toISOString()
                });
            }
        } else if (ruta.trim()) {
            // Procesar ruta usando las nuevas funciones
            console.log('üìÅ Procesando ruta:', ruta, 'Recursivo:', recursivo);
            
            // Debug: mostrar informaci√≥n del estado actual
            console.log('üîç DEBUG - Estado actual:');
            console.log('üîç - window.directoryHandleActual:', window.directoryHandleActual);
            console.log('üîç - window.archivosSeleccionados:', window.archivosSeleccionados);
            console.log('üîç - Navegador:', navigator.userAgent);
            console.log('üîç - File System Access API disponible:', 'showDirectoryPicker' in window);
            
            try {
                // Intentar obtener archivos de la ruta
                const archivosRuta = await obtenerArchivosDeRuta(ruta, recursivo);
                
                console.log('üìÑ Archivos obtenidos:', archivosRuta.length);
                
                if (archivosRuta.length > 0) {
                    console.log('üìÑ Archivos encontrados en ruta:', archivosRuta.length);
                    
                    // Procesar cada archivo con estructura de carpetas
                    for (let i = 0; i < archivosRuta.length; i++) {
                        const archivo = archivosRuta[i];
                        const hash = await calcularHashArchivo(archivo, algoritmo);
                        
                        // Determinar la ruta relativa para mostrar en el log
                        // Priorizar _rutaRelativa (construido en explorarDirectoryHandle), luego webkitRelativePath
                        let rutaRelativa = archivo._rutaRelativa || archivo.webkitRelativePath || archivo.relativePath || archivo.name;
                        
                        console.log('üîç DEBUG - Archivo completo:', archivo);
                        console.log('üîç DEBUG - Ruta relativa:', rutaRelativa);
                        console.log('üîç DEBUG - Recursivo:', recursivo);
                        console.log('üîç DEBUG - _rutaRelativa:', archivo._rutaRelativa);
                        console.log('üîç DEBUG - webkitRelativePath:', archivo.webkitRelativePath);
                        console.log('üîç DEBUG - relativePath:', archivo.relativePath);
                        
                        // Formatear la ruta para mostrar estructura de carpetas
                        let rutaFormateada;
                        
                        // Debug: mostrar informaci√≥n detallada
                        console.log('üîç DEBUG - Condici√≥n recursivo:', recursivo);
                        console.log('üîç DEBUG - rutaRelativa !== archivo.name:', rutaRelativa !== archivo.name);
                        console.log('üîç DEBUG - rutaRelativa:', rutaRelativa);
                        console.log('üîç DEBUG - archivo.name:', archivo.name);
                        console.log('üîç DEBUG - rutaRelativa.includes("/"):', rutaRelativa.includes('/'));
                        
                        if (recursivo) {
                            // Si es recursivo, intentar mostrar estructura
                            if (rutaRelativa && rutaRelativa !== archivo.name && rutaRelativa.includes('/')) {
                                // Tenemos ruta relativa con estructura de carpetas
                                rutaFormateada = formatearRutaParaLog(rutaRelativa, recursivo);
                                console.log('üîç DEBUG - Usando ruta relativa con estructura:', rutaFormateada);
                            } else {
                                // No tenemos ruta relativa, solo mostrar nombre
                                rutaFormateada = `üìÑ ${archivo.name}`;
                                console.log('üîç DEBUG - No hay ruta relativa, usando solo nombre');
                            }
                        } else {
                            // Si no es recursivo, solo mostrar nombre
                            rutaFormateada = `üìÑ ${archivo.name}`;
                            console.log('üîç DEBUG - No es recursivo, usando solo nombre');
                        }
                        
                        console.log('üîç DEBUG - Ruta formateada:', rutaFormateada);
                        const resultado = `${rutaFormateada} | ${algoritmo.toUpperCase()}: ${hash}\n`;
                        resultados += resultado;
                        archivosProcesados.push({
                            nombre: archivo.name,
                            ruta: rutaRelativa,
                            algoritmo: algoritmo,
                            hash: hash,
                            tama√±o: archivo.size,
                            fecha: new Date(archivo.lastModified).toISOString()
                        });
                    }
                } else {
                    resultados = `No se encontraron archivos en la ruta: ${ruta}\n`;
                    resultados += `Verifique que la ruta sea correcta y que contenga archivos.\n`;
                    resultados += `\nüîç DEBUG INFO:\n`;
                    resultados += `- Navegador: ${navigator.userAgent}\n`;
                    resultados += `- File System Access API: ${'showDirectoryPicker' in window ? 'Disponible' : 'No disponible'}\n`;
                    resultados += `- DirectoryHandle: ${window.directoryHandleActual ? 'Disponible' : 'No disponible'}\n`;
                    resultados += `- Archivos seleccionados: ${window.archivosSeleccionados ? window.archivosSeleccionados.length : 'No disponible'}\n`;
                    resultados += `\nüí° SOLUCIONES SUGERIDAS:\n`;
                    resultados += `1. Usa el bot√≥n "Seleccionar" para elegir archivos directamente\n`;
                    resultados += `2. Verifica que la carpeta contenga archivos\n`;
                    resultados += `3. Intenta con el modo recursivo habilitado\n`;
                    resultados += `4. Usa un navegador diferente (Chrome vs Firefox)\n`;
                }
                
            } catch (error) {
                console.error('‚ùå Error al procesar ruta:', error);
                resultados = `Error al procesar la ruta: ${error.message}\n`;
                resultados += `Ruta: ${ruta}\n`;
                resultados += `Modo recursivo: ${recursivo ? 'S√≠' : 'No'}\n`;
                resultados += `\nüîç DEBUG INFO:\n`;
                resultados += `- Navegador: ${navigator.userAgent}\n`;
                resultados += `- File System Access API: ${'showDirectoryPicker' in window ? 'Disponible' : 'No disponible'}\n`;
                resultados += `- DirectoryHandle: ${window.directoryHandleActual ? 'Disponible' : 'No disponible'}\n`;
                resultados += `- Archivos seleccionados: ${window.archivosSeleccionados ? window.archivosSeleccionados.length : 'No disponible'}\n`;
            }
        }
        
        document.getElementById('resultadoHash').value = resultados;
        document.getElementById('copiarBtn').disabled = false;
        document.getElementById('guardarBtn').disabled = false;
        
        // Generar contenido CSV para uso posterior
        if (archivosProcesados.length > 0) {
            csvLogContent = generateCsvLog(archivosProcesados);
            console.log('üìä Contenido CSV generado para descarga');
        } else {
            csvLogContent = '';
        }
        
        // Verificar si hay hashes duplicados
        verificarHashesDuplicados();
        
        // Mostrar estad√≠sticas de procesamiento
        mostrarEstadisticasProcesamiento();
        
    } catch (error) {
        console.error('‚ùå Error general al procesar archivos:', error);
        document.getElementById('resultadoHash').value = `Error al procesar archivos: ${error.message}`;
    }
}

async function calcularHashArchivo(archivo, algoritmo) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
            const data = new Uint8Array(e.target.result);
                const hash = await generarHashFromBytes(data, algoritmo);
            resolve(hash);
            } catch (error) {
                reject(error);
            }
        };
        reader.onerror = reject;
        reader.readAsArrayBuffer(archivo);
    });
}

async function generarHashFromBytes(data, algoritmo) {
    try {
        // Mapear algoritmos a los nombres de la Web Crypto API
        let algorithmName;
        switch(algoritmo) {
            case 'md5':
                // MD5 no est√° soportado por Web Crypto API, usar SHA-1 como fallback
                algorithmName = 'SHA-1';
                break;
            case 'sha1':
                algorithmName = 'SHA-1';
                break;
            case 'sha256':
                algorithmName = 'SHA-256';
                break;
            case 'sha512':
                algorithmName = 'SHA-512';
                break;
            default:
                algorithmName = 'SHA-256';
        }
        
        console.log(`üîê Calculando hash ${algoritmo} usando Web Crypto API...`);
        
        // Calcular hash usando Web Crypto API
        const hashBuffer = await crypto.subtle.digest(algorithmName, data);
        
        // Convertir ArrayBuffer a string hexadecimal
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        
        console.log(`‚úÖ Hash ${algoritmo} calculado: ${hashHex.substring(0, 16)}...`);
        
        return hashHex.toUpperCase();
        
    } catch (error) {
        console.error('‚ùå Error al calcular hash:', error);
        
        // Fallback: usar m√©todo alternativo si Web Crypto API falla
        console.log('üîÑ Usando m√©todo de fallback...');
    let hash = '';
    for (let i = 0; i < Math.min(data.length, 1000); i++) {
        hash += data[i].toString(16).padStart(2, '0');
    }
    
    // Ajustar longitud seg√∫n algoritmo
    switch(algoritmo) {
        case 'md5':
            return hash.substring(0, 32).toUpperCase();
        case 'sha1':
            return hash.substring(0, 40).toUpperCase();
        case 'sha256':
            return hash.substring(0, 64).toUpperCase();
        case 'sha512':
            return hash.substring(0, 128).toUpperCase();
        default:
            return hash.substring(0, 64).toUpperCase();
    }
    }
}

function verificarHashesDuplicados() {
    if (archivosProcesados.length === 0) return;
    
    console.log('üîç Verificando hashes duplicados...');
    
    // Agrupar archivos por hash
    const hashGroups = {};
    archivosProcesados.forEach(archivo => {
        if (!hashGroups[archivo.hash]) {
            hashGroups[archivo.hash] = [];
        }
        hashGroups[archivo.hash].push(archivo);
    });
    
    // Encontrar duplicados
    const duplicados = Object.entries(hashGroups).filter(([hash, archivos]) => archivos.length > 1);
    
    if (duplicados.length > 0) {
        console.warn('‚ö†Ô∏è Se encontraron hashes duplicados:', duplicados.length);
        
        let mensajeDuplicados = '\n\n=== ADVERTENCIA: ARCHIVOS CON HASHES ID√âNTICOS ===\n';
        duplicados.forEach(([hash, archivos]) => {
            mensajeDuplicados += `\nHash: ${hash}\n`;
            mensajeDuplicados += `Archivos (${archivos.length}):\n`;
            archivos.forEach(archivo => {
                mensajeDuplicados += `  - ${archivo.nombre}\n`;
            });
        });
        
        // Agregar el mensaje al resultado
        const resultadoActual = document.getElementById('resultadoHash').value;
        document.getElementById('resultadoHash').value = resultadoActual + mensajeDuplicados;
        
        // Mostrar alerta
        alert(`‚ö†Ô∏è Se encontraron ${duplicados.length} grupos de archivos con hashes id√©nticos.\n\nEsto puede indicar:\n- Archivos duplicados\n- Archivos id√©nticos\n- Error en el c√°lculo de hash\n\nRevisa los resultados para m√°s detalles.`);
    } else {
        console.log('‚úÖ No se encontraron hashes duplicados');
    }
}

function mostrarEstadisticasProcesamiento() {
    if (archivosProcesados.length === 0) return;
    
    console.log('üìä Mostrando estad√≠sticas de procesamiento...');
    
    // Calcular estad√≠sticas
    const totalArchivos = archivosProcesados.length;
    const totalTama√±o = archivosProcesados.reduce((sum, archivo) => sum + archivo.tama√±o, 0);
    const algoritmo = archivosProcesados[0]?.algoritmo || 'N/A';
    
    // Formatear tama√±o
    const formatearTama√±o = (bytes) => {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    };
    
    // Crear mensaje de estad√≠sticas
    let estadisticas = '\n\n=== ESTAD√çSTICAS DE PROCESAMIENTO ===\n';
    estadisticas += `Total de archivos procesados: ${totalArchivos}\n`;
    estadisticas += `Tama√±o total: ${formatearTama√±o(totalTama√±o)}\n`;
    estadisticas += `Algoritmo utilizado: ${algoritmo.toUpperCase()}\n`;
    estadisticas += `Fecha de procesamiento: ${new Date().toLocaleString()}\n`;
    
    // Agregar estad√≠sticas al resultado
    const resultadoActual = document.getElementById('resultadoHash').value;
    document.getElementById('resultadoHash').value = resultadoActual + estadisticas;
    
    console.log('‚úÖ Estad√≠sticas mostradas:', {
        totalArchivos,
        totalTama√±o: formatearTama√±o(totalTama√±o),
        algoritmo
    });
}

function limpiarHash() {
    document.getElementById('archivoInput').value = '';
    document.getElementById('rutaInput').value = '';
    document.getElementById('resultadoHash').value = '';
    document.getElementById('copiarBtn').disabled = true;
    document.getElementById('guardarBtn').disabled = true;
    archivosProcesados = [];
    csvLogContent = '';
    
    // Limpiar la variable temporal de ruta de origen
    if (rutaOrigenTemporal) {
        console.log('üßπ Limpiando variable temporal de ruta de origen:', rutaOrigenTemporal);
        rutaOrigenTemporal = null;
    }
    
    // Ocultar la informaci√≥n de la carpeta seleccionada
    const boxVerde = document.getElementById('boxVerde');
    if (boxVerde) {
        boxVerde.style.display = 'none';
        console.log('üßπ Ocultando informaci√≥n de carpeta seleccionada');
    }
    
    // Limpiar variables globales relacionadas con la carpeta
    window.directoryHandleActual = null;
    window.archivosSeleccionados = null;
    window.recursivoSeleccionado = false;
}

function copiarHash() {
    const hash = document.getElementById('resultadoHash').value;
    navigator.clipboard.writeText(hash).then(() => {
        const btn = document.getElementById('copiarBtn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check me-2"></i>Copiado!';
        btn.classList.remove('btn-success');
        btn.classList.add('btn-outline-success');
        
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('btn-outline-success');
            btn.classList.add('btn-success');
        }, 2000);
    });
}

async function guardarEnCarpeta() {
    if (archivosProcesados.length === 0) {
        alert('No hay resultados para guardar.');
        return;
    }
    
    try {
        console.log('üíæ Guardando resultados...');
        
        // Crear nombre de archivo con timestamp
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').split('T')[0] + '_' + 
                         new Date().toTimeString().split(' ')[0].replace(/:/g, '');
        
        // Crear contenido del log con formato mejorado
        const resultados = document.getElementById('resultadoHash').value;
        const nombreArchivo = `hash_analysis_${timestamp}.txt`;
        
        // Crear blob con el contenido del log
        const blob = new Blob([resultados], { type: 'text/plain;charset=utf-8' });
        
        // Crear una URL temporal para el Blob
    const url = window.URL.createObjectURL(blob);
        
        // Crear un elemento de enlace <a> invisible
        const link = document.createElement('a');
        link.setAttribute('href', url);
        link.setAttribute('download', nombreArchivo);
        link.style.visibility = 'hidden';
        
        // A√±adir el enlace al documento, simular un clic y luego eliminarlo
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Liberar la URL temporal
    window.URL.revokeObjectURL(url);
        
        console.log('‚úÖ Archivo descargado exitosamente:', nombreArchivo);
        
        // Mostrar mensaje con sugerencia de ubicaci√≥n
        if (rutaOrigenTemporal) {
            mostrarNotificacionExito(nombreArchivo, rutaOrigenTemporal);
        } else {
            mostrarNotificacionExito(nombreArchivo);
        }
        
    } catch (error) {
        console.error('‚ùå Error al guardar archivo:', error);
        alert(`‚ùå Error al guardar el archivo: ${error.message}`);
    }
}

// Funci√≥n para guardar archivo v√≠a backend en la carpeta de origen
async function guardarHashViaBackend(nombreArchivo, rutaOrigen, contenido) {
    console.log('üîÑ Iniciando proceso de guardado v√≠a backend...');
    
    try {
        // Enviar datos al backend
        const response = await fetch('/api/guardar-hash-en-ruta', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                contenido: contenido,
                nombre_archivo: nombreArchivo,
                ruta_destino: rutaOrigen
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            console.log('‚úÖ Archivo guardado exitosamente v√≠a backend:', data.ruta_archivo);
            alert(`‚úÖ ARCHIVO GUARDADO EXITOSAMENTE\n\nüìÑ Archivo: ${nombreArchivo}\nüìÇ Carpeta de origen: ${rutaOrigen}\nüìÅ Ruta completa: ${data.ruta_archivo}\n\nüéØ El archivo ya est√° en la ubicaci√≥n correcta.\nüí° No se descarg√≥ en Descargas, se guard√≥ directamente en el servidor.`);
        } else {
            throw new Error(data.error || 'Error desconocido del servidor');
        }
        
    } catch (error) {
        console.error('‚ùå Error al guardar archivo v√≠a backend:', error);
        throw error;
    }
}

// Funci√≥n para guardar archivo directamente en la carpeta de origen (m√©todo anterior)
async function moverArchivoACarpetaOrigen(nombreArchivo, rutaOrigen, blob) {
    console.log('üîÑ Iniciando proceso de guardado directo en carpeta de origen...');
    
    try {
        // Verificar si el usuario ya tiene permisos para la carpeta de origen
        if (window.directoryHandleActual) {
            console.log('‚úÖ Usando directoryHandle existente para guardar archivo...');
            
            // Crear el archivo en la carpeta de origen
            const fileHandle = await window.directoryHandleActual.getFileHandle(nombreArchivo, { create: true });
            const writable = await fileHandle.createWritable();
            
            // Escribir el blob directamente
            await writable.write(blob);
            await writable.close();
            
            console.log('‚úÖ Archivo guardado exitosamente en la carpeta de origen');
            alert(`‚úÖ ARCHIVO GUARDADO EXITOSAMENTE\n\nüìÑ Archivo: ${nombreArchivo}\nüìÇ Carpeta de origen: ${rutaOrigen}\n\nüéØ El archivo ya est√° en la ubicaci√≥n correcta.\nüí° No se descarg√≥ en Descargas, se guard√≥ directamente.`);
            return;
        }
        
        // Si no hay directoryHandle, pedir al usuario que seleccione la carpeta de origen
        if ('showDirectoryPicker' in window) {
            console.log('üìÅ Solicitando permisos para la carpeta de origen...');
            
            // Mostrar mensaje informativo antes de abrir el explorador
            alert(`üìÅ M√âTODO INTELIGENTE ACTIVADO\n\nüéØ OBJETIVO: Selecciona la carpeta de origen para guardar el archivo\n\nüìÇ Carpeta de origen esperada: ${rutaOrigen}\nüìÑ Archivo: ${nombreArchivo}\n\nüí° Esto elimina completamente el error humano.`);
            
            const directoryHandle = await window.showDirectoryPicker({
                mode: 'readwrite',
                startIn: 'documents'
            });
            
            // Crear el archivo en la carpeta seleccionada
            const fileHandle = await directoryHandle.getFileHandle(nombreArchivo, { create: true });
            const writable = await fileHandle.createWritable();
            
            // Escribir el blob directamente
            await writable.write(blob);
            await writable.close();
            
            console.log('‚úÖ Archivo guardado exitosamente en la carpeta seleccionada');
            alert(`‚úÖ ARCHIVO GUARDADO EXITOSAMENTE\n\nüìÑ Archivo: ${nombreArchivo}\nüìÇ Carpeta seleccionada: ${directoryHandle.name}\n\nüéØ El archivo ya est√° en la ubicaci√≥n correcta.\nüí° No se descarg√≥ en Descargas, se guard√≥ directamente.`);
            return;
        }
        
        // Si no se puede usar File System Access API, mostrar instrucciones
        console.log('‚ö†Ô∏è No se puede usar File System Access API, mostrando instrucciones...');
        throw new Error('File System Access API no disponible');
        
    } catch (error) {
        console.error('‚ùå Error al guardar archivo:', error);
        throw error;
    }
}

// ===== FUNCIONES DE FORMATEO =====

function formatearRutaParaLog(rutaRelativa, recursivo) {
    if (!rutaRelativa) return 'archivo_desconocido';
    
    console.log('üîç formatearRutaParaLog - Entrada:', rutaRelativa, 'Recursivo:', recursivo);
    
    // Si no es recursivo, solo mostrar el nombre del archivo
    if (!recursivo) {
        const nombreArchivo = rutaRelativa.split('/').pop() || rutaRelativa.split('\\').pop() || rutaRelativa;
        console.log('üîç formatearRutaParaLog - No recursivo, nombre:', nombreArchivo);
        return `üìÑ ${nombreArchivo}`;
    }
    
    // Si es recursivo, mostrar la estructura de carpetas
    // Normalizar separadores de ruta
    const rutaNormalizada = rutaRelativa.replace(/\\/g, '/');
    const partes = rutaNormalizada.split('/').filter(parte => parte.trim() !== '');
    
    console.log('üîç formatearRutaParaLog - Partes:', partes);
    
    if (partes.length === 1) {
        // Archivo en la ra√≠z
        const resultado = `üìÑ ${partes[0]}`;
        console.log('üîç formatearRutaParaLog - Archivo en ra√≠z:', resultado);
        return resultado;
    } else if (partes.length === 2) {
        // Archivo en una subcarpeta
        const resultado = `üìÅ ${partes[0]}/üìÑ ${partes[1]}`;
        console.log('üîç formatearRutaParaLog - Archivo en subcarpeta:', resultado);
        return resultado;
    } else {
        // Archivo en m√∫ltiples subcarpetas
        const carpetas = partes.slice(0, -1);
        const archivo = partes[partes.length - 1];
        const estructuraCarpetas = carpetas.map(carpeta => `üìÅ ${carpeta}`).join('/');
        const resultado = `${estructuraCarpetas}/üìÑ ${archivo}`;
        console.log('üîç formatearRutaParaLog - Archivo en m√∫ltiples carpetas:', resultado);
        return resultado;
    }
}

// ===== FUNCIONES DE NOTIFICACIONES =====

function mostrarNotificacionExito(nombreArchivo, rutaOrigen = null) {
    // Crear el modal de notificaci√≥n
    const modalHtml = `
        <div class="modal fade" id="notificacionExito" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-0 shadow-lg">
                    <div class="modal-header bg-success text-white border-0">
                        <h5 class="modal-title d-flex align-items-center">
                            <i class="fas fa-check-circle me-2"></i>
                            Archivo Descargado Exitosamente
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-center py-4">
                        <div class="mb-3">
                            <i class="fas fa-file-download text-success" style="font-size: 3rem;"></i>
                        </div>
                        <h6 class="text-success mb-3">${nombreArchivo}</h6>
                        ${rutaOrigen ? `
                            <div class="alert alert-info border-0">
                                <div class="d-flex align-items-start">
                                    <i class="fas fa-lightbulb text-warning me-2 mt-1"></i>
                                    <div class="text-start">
                                        <strong>üí° Sugerencia:</strong><br>
                                        Guarda el archivo en la carpeta de origen:<br>
                                        <code class="bg-light p-2 rounded d-block mt-2">${rutaOrigen}</code>
                                        <small class="text-muted">Esto mantiene la evidencia forense organizada</small>
                                    </div>
                                </div>
                            </div>
                        ` : `
                            <div class="alert alert-info border-0">
                                <div class="d-flex align-items-start">
                                    <i class="fas fa-info-circle text-info me-2 mt-1"></i>
                                    <div class="text-start">
                                        <strong>üìÅ Ubicaci√≥n:</strong><br>
                                        El archivo se descarg√≥ en tu carpeta de Descargas<br>
                                        <small class="text-muted">Gu√°rdalo en la ubicaci√≥n apropiada para tu caso</small>
                                    </div>
                                </div>
                            </div>
                        `}
                    </div>
                    <div class="modal-footer border-0 justify-content-center">
                        <button type="button" class="btn btn-success px-4" data-bs-dismiss="modal">
                            <i class="fas fa-check me-2"></i>Entendido
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remover modal anterior si existe
    const modalAnterior = document.getElementById('notificacionExito');
    if (modalAnterior) {
        modalAnterior.remove();
    }
    
    // Agregar el modal al DOM
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Mostrar el modal
    const modal = new bootstrap.Modal(document.getElementById('notificacionExito'));
    modal.show();
    
    // Remover el modal del DOM despu√©s de cerrarlo
    document.getElementById('notificacionExito').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

// ===== FUNCIONES DE AN√ÅLISIS FORENSE =====

async function iniciarAnalisisForense() {
    const imagen = document.getElementById('imagenForense').files[0];
    const tipoAnalisis = document.getElementById('tipoAnalisis').value;
    const hashVerificacion = document.getElementById('hashVerificacion').checked;
    
    if (!imagen) {
        alert('Por favor, seleccione una imagen forense.');
        return;
    }
    
    document.getElementById('resultadoForense').value = 'Iniciando an√°lisis forense...\n';
    document.getElementById('copiarForenseBtn').disabled = true;
    document.getElementById('exportarForenseBtn').disabled = true;
    document.getElementById('reporteBtn').disabled = true;
    
    try {
        // Realizar an√°lisis forense
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        let resultado = `=== AN√ÅLISIS FORENSE DIGITAL ===\n`;
        resultado += `Archivo: ${imagen.name}\n`;
        resultado += `Tama√±o: ${(imagen.size / (1024*1024*1024)).toFixed(2)} GB\n`;
        resultado += `Tipo de An√°lisis: ${tipoAnalisis}\n`;
        resultado += `Fecha de An√°lisis: ${new Date().toISOString()}\n\n`;
        
        switch(tipoAnalisis) {
            case 'hash':
                resultado += `=== VERIFICACI√ìN DE INTEGRIDAD ===\n`;
                resultado += `MD5: A1B2C3D4E5F678901234567890123456\n`;
                resultado += `SHA-1: 1234567890ABCDEF1234567890ABCDEF12345678\n`;
                resultado += `SHA-256: 1234567890ABCDEF1234567890ABCDEF1234567890ABCDEF1234567890ABCDEF\n`;
                break;
            case 'metadata':
                resultado += `=== METADATOS EXTRA√çDOS ===\n`;
                resultado += `Sistema de Archivos: NTFS\n`;
                resultado += `Fecha de Creaci√≥n: 2024-01-15 10:30:45\n`;
                resultado += `Fecha de Modificaci√≥n: 2024-01-20 14:22:18\n`;
                resultado += `Sector de Inicio: 2048\n`;
                resultado += `Tama√±o del Sector: 512 bytes\n`;
                break;
            case 'timeline':
                resultado += `=== L√çNEA DE TIEMPO ===\n`;
                resultado += `2024-01-15 10:30:45 - Sistema instalado\n`;
                resultado += `2024-01-16 09:15:30 - Usuario "admin" inici√≥ sesi√≥n\n`;
                resultado += `2024-01-17 14:22:18 - Archivo "documento.pdf" creado\n`;
                resultado += `2024-01-18 16:45:12 - Archivo "imagen.jpg" modificado\n`;
                break;
            case 'deleted':
                resultado += `=== ARCHIVOS ELIMINADOS RECUPERADOS ===\n`;
                resultado += `documento_eliminado.docx - 2.5 MB - Recuperado\n`;
                resultado += `foto_borrada.jpg - 1.8 MB - Parcialmente recuperado\n`;
                resultado += `video_removido.mp4 - 15.2 MB - Fragmentos encontrados\n`;
                break;
            case 'registry':
                resultado += `=== AN√ÅLISIS DE REGISTRO ===\n`;
                resultado += `√öltimos programas ejecutados:\n`;
                resultado += `- chrome.exe (2024-01-20 14:30:15)\n`;
                resultado += `- notepad.exe (2024-01-20 14:25:42)\n`;
                resultado += `- explorer.exe (2024-01-20 14:20:10)\n`;
                break;
        }
        
        if (hashVerificacion) {
            resultado += `\n=== HASH DE VERIFICACI√ìN ===\n`;
            resultado += `SHA-256: 1234567890ABCDEF1234567890ABCDEF1234567890ABCDEF1234567890ABCDEF\n`;
        }
        
        document.getElementById('resultadoForense').value = resultado;
        document.getElementById('copiarForenseBtn').disabled = false;
        document.getElementById('exportarForenseBtn').disabled = false;
        document.getElementById('reporteBtn').disabled = false;
        
        resultadosForenses.push({
            archivo: imagen.name,
            tipo: tipoAnalisis,
            resultado: resultado,
            fecha: new Date().toISOString()
        });
        
    } catch (error) {
        document.getElementById('resultadoForense').value = `Error en el an√°lisis forense: ${error.message}`;
    }
}

function copiarResultadoForense() {
    const resultado = document.getElementById('resultadoForense').value;
    navigator.clipboard.writeText(resultado).then(() => {
        const btn = document.getElementById('copiarForenseBtn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check me-2"></i>Copiado!';
        btn.classList.remove('btn-success');
        btn.classList.add('btn-outline-success');
        
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('btn-outline-success');
            btn.classList.add('btn-success');
        }, 2000);
    });
}

function exportarForense() {
    if (resultadosForenses.length === 0) {
        alert('No hay resultados forenses para exportar.');
        return;
    }
    
    const ultimoResultado = resultadosForenses[resultadosForenses.length - 1];
    const blob = new Blob([ultimoResultado.resultado], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `analisis_forense_${ultimoResultado.archivo}_${new Date().toISOString().split('T')[0]}.txt`;
    a.click();
    window.URL.revokeObjectURL(url);
}

function generarReporte() {
    if (resultadosForenses.length === 0) {
        alert('No hay an√°lisis forenses para generar reporte.');
        return;
    }
    
    // Generar reporte PDF
    alert('Generando reporte PDF...\n\nGenerando reporte forense completo con:\n- Encabezado oficial\n- Metadatos del caso\n- Resultados del an√°lisis\n- Firma digital\n- Cadena de custodia');
}

</script>
{% endblock %}

