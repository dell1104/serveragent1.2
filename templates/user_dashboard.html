{% extends "base_sidebar.html" %}

{% block title %}Mi Panel - Sistema Forense{% endblock %}

{% block page_title %}
<div class="d-flex justify-content-between align-items-center">
    <div>
        <h1 class="h3 mb-1">
            <i class="fas fa-user-circle me-2 text-primary"></i>Bienvenido, {{ current_user.nombre_completo }}
        </h1>
        <p class="text-muted mb-0 small">Panel personal - Gestión de casos forenses</p>
    </div>
    <div class="text-end">
        <span class="badge bg-success">{{ current_user.rol.title() }}</span>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Estadísticas Personales -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <h6 class="card-title">Mis Casos</h6>
                    <h4 id="totalMisCasos">-</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body text-center">
                    <h6 class="card-title">Pendientes</h6>
                    <h4 id="casosPendientes">-</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h6 class="card-title">Completados</h6>
                    <h4 id="casosCompletados">-</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <h6 class="card-title">Archivos</h6>
                    <h4 id="totalArchivos">-</h4>
                </div>
            </div>
        </div>
    </div>

    <!-- Casos Pendientes -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-clock me-2"></i>Casos Pendientes
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Expediente</th>
                                    <th>Origen</th>
                                    <th>Tipo</th>
                                    <th>Fecha Creación</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tablaCasosPendientes">
                                <tr>
                                    <td colspan="6" class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Cargando...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Actividad Reciente -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-history me-2"></i>Mi Actividad Reciente
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Fecha</th>
                                    <th>Acción</th>
                                    <th>Descripción</th>
                                    <th>IP</th>
                                </tr>
                            </thead>
                            <tbody id="tablaActividad">
                                <tr>
                                    <td colspan="4" class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Cargando...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Todos los Casos -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-folder-open me-2"></i>Todos los Casos
                        </h5>
                        <div class="btn-group" role="group">
                            <button class="btn btn-outline-primary btn-sm" onclick="cargarTodosLosCasos()">
                                <i class="fas fa-sync me-1"></i>Actualizar
                            </button>
                            <button class="btn btn-outline-success btn-sm" onclick="exportarMisCasos()">
                                <i class="fas fa-download me-1"></i>Exportar
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Filtros -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="filtroExpediente" placeholder="Buscar por expediente...">
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="filtroEstado">
                                <option value="">Todos los estados</option>
                                <option value="En Proceso">En Proceso</option>
                                <option value="Completado">Completado</option>
                                <option value="Archivado">Archivado</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="filtroTipo">
                                <option value="">Todos los tipos</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-primary w-100" onclick="filtrarCasos()">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Tabla de casos -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Expediente</th>
                                    <th>Origen</th>
                                    <th>Tipo</th>
                                    <th>Fecha Creación</th>
                                    <th>Estado</th>
                                    <th>Propietario</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tablaTodosLosCasos">
                                <tr>
                                    <td colspan="7" class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Cargando...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Modal para Ver Caso -->
<div id="viewCaseModal" class="modal" style="display: none;">
    <div class="modal-content modal-centered">
        <div class="modal-header">
            <h5 class="modal-title">Detalles del Caso</h5>
            <button type="button" class="btn-close" onclick="cerrarModal('viewCaseModal')"></button>
        </div>
        <div class="modal-body" id="viewCaseContent">
            <!-- Contenido dinámico -->
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="cerrarModal('viewCaseModal')">Cerrar</button>
        </div>
    </div>
</div>

<!-- Modal para Editar Caso (solo propios) -->
<div id="editCaseModal" class="modal" style="display: none;">
    <div class="modal-content modal-centered">
        <div class="modal-header">
            <h5 class="modal-title">Editar Caso</h5>
            <button type="button" class="btn-close" onclick="cerrarModal('editCaseModal')"></button>
        </div>
        <div class="modal-body" id="editCaseContent">
            <!-- Contenido dinámico -->
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="cerrarModal('editCaseModal')">Cancelar</button>
            <button type="button" class="btn btn-primary" onclick="guardarEdicionCaso()">Guardar Cambios</button>
        </div>
    </div>
</div>

<script>
// Variables globales
let todosLosCasos = [];
let casosPendientes = [];
let currentCaseToEdit = null;

// Cargar datos al inicializar
document.addEventListener('DOMContentLoaded', function() {
    cargarEstadisticasPersonales();
    cargarCasosPendientes();
    cargarTodosLosCasos();
    cargarActividadReciente();
});

// Cargar estadísticas personales
async function cargarEstadisticasPersonales() {
    try {
        const response = await fetch('/api/estadisticas-personales');
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('totalMisCasos').textContent = data.estadisticas.mis_casos || 0;
            document.getElementById('casosPendientes').textContent = data.estadisticas.casos_pendientes || 0;
            document.getElementById('casosCompletados').textContent = data.estadisticas.casos_completados || 0;
            document.getElementById('totalArchivos').textContent = data.estadisticas.total_archivos || 0;
        }
    } catch (error) {
        console.error('Error cargando estadísticas personales:', error);
    }
}

// Cargar casos pendientes
async function cargarCasosPendientes() {
    try {
        const response = await fetch('/api/mis-casos-pendientes');
        const data = await response.json();
        
        if (data.success) {
            casosPendientes = data.casos;
            mostrarCasosPendientes(data.casos);
        }
    } catch (error) {
        console.error('Error cargando casos pendientes:', error);
    }
}

// Mostrar casos pendientes
function mostrarCasosPendientes(casos) {
    const tbody = document.getElementById('tablaCasosPendientes');
    
    if (casos.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center text-muted">
                    <i class="fas fa-check-circle me-2"></i>No tienes casos pendientes
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = casos.map(caso => `
        <tr>
            <td><code>${caso.expediente}</code></td>
            <td>${caso.origen_solicitud || '-'}</td>
            <td>${caso.tipo_requerimiento || '-'}</td>
            <td>${new Date(caso.fecha_creacion).toLocaleDateString('es-ES')}</td>
            <td><span class="badge bg-warning">${caso.estado_caso}</span></td>
            <td>
                <button class="btn btn-sm btn-outline-info" onclick="verCaso(${caso.id})" title="Ver detalles">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-outline-primary" onclick="editarCaso(${caso.id})" title="Editar">
                    <i class="fas fa-edit"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

// Cargar todos los casos
async function cargarTodosLosCasos() {
    try {
        const response = await fetch('/api/todos-los-casos');
        const data = await response.json();
        
        if (data.success) {
            todosLosCasos = data.casos;
            mostrarTodosLosCasos(data.casos);
            poblarFiltros(data.tipos_requerimiento);
        }
    } catch (error) {
        console.error('Error cargando todos los casos:', error);
    }
}

// Cargar actividad reciente
async function cargarActividadReciente() {
    try {
        const response = await fetch('/api/mi-actividad');
        const data = await response.json();
        
        if (data.success) {
            mostrarActividadReciente(data.actividad);
        }
    } catch (error) {
        console.error('Error cargando actividad reciente:', error);
    }
}

// Mostrar actividad reciente
function mostrarActividadReciente(actividad) {
    const tbody = document.getElementById('tablaActividad');
    
    if (actividad.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="4" class="text-center text-muted">
                    <i class="fas fa-info-circle me-2"></i>No hay actividad reciente
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = actividad.map(log => `
        <tr>
            <td>
                <small class="text-muted">
                    ${new Date(log.fecha_evento).toLocaleString('es-ES')}
                </small>
            </td>
            <td>
                <span class="badge bg-secondary">${log.tipo_evento}</span>
            </td>
            <td>${log.descripcion}</td>
            <td>
                <small class="text-muted">${log.ip_address || '-'}</small>
            </td>
        </tr>
    `).join('');
}

// Mostrar todos los casos
function mostrarTodosLosCasos(casos) {
    const tbody = document.getElementById('tablaTodosLosCasos');
    
    if (casos.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted">
                    <i class="fas fa-info-circle me-2"></i>No se encontraron casos
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = casos.map(caso => `
        <tr>
            <td><code>${caso.expediente}</code></td>
            <td>${caso.origen_solicitud || '-'}</td>
            <td>${caso.tipo_requerimiento || '-'}</td>
            <td>${new Date(caso.fecha_creacion).toLocaleDateString('es-ES')}</td>
            <td><span class="badge ${caso.completado ? 'bg-success' : 'bg-warning'}">${caso.estado_caso}</span></td>
            <td>${caso.usuario ? caso.usuario.nombre_completo : 'Sistema'}</td>
            <td>
                <button class="btn btn-sm btn-outline-info" onclick="verCaso(${caso.id})" title="Ver detalles">
                    <i class="fas fa-eye"></i>
                </button>
                ${caso.usuario_id === {{ current_user.id }}? 
                    `<button class="btn btn-sm btn-outline-primary" onclick="editarCaso(${caso.id})" title="Editar">
                        <i class="fas fa-edit"></i>
                    </button>` : 
                    '<span class="text-muted small">Solo lectura</span>'
                }
            </td>
        </tr>
    `).join('');
}

// Poblar filtros
function poblarFiltros(tipos) {
    const select = document.getElementById('filtroTipo');
    select.innerHTML = '<option value="">Todos los tipos</option>';
    tipos.forEach(tipo => {
        select.innerHTML += `<option value="${tipo}">${tipo}</option>`;
    });
}

// Filtrar casos
function filtrarCasos() {
    const expediente = document.getElementById('filtroExpediente').value.toLowerCase();
    const estado = document.getElementById('filtroEstado').value;
    const tipo = document.getElementById('filtroTipo').value;
    
    const casosFiltrados = todosLosCasos.filter(caso => {
        const matchExpediente = !expediente || caso.expediente.toLowerCase().includes(expediente);
        const matchEstado = !estado || caso.estado_caso === estado;
        const matchTipo = !tipo || caso.tipo_requerimiento === tipo;
        
        return matchExpediente && matchEstado && matchTipo;
    });
    
    mostrarTodosLosCasos(casosFiltrados);
}

// Ver caso
async function verCaso(casoId) {
    try {
        const response = await fetch(`/api/caso/${casoId}`);
        const data = await response.json();
        
        if (data.success) {
            mostrarModalCaso(data.caso);
        } else {
            alert('Error al cargar el caso: ' + data.error);
        }
    } catch (error) {
        console.error('Error cargando caso:', error);
        alert('Error de conexión');
    }
}

// Editar caso (solo propios)
async function editarCaso(casoId) {
    const caso = todosLosCasos.find(c => c.id === casoId);
    if (!caso) return;
    
    if (caso.usuario_id !== {{ current_user.id }}) {
        alert('Solo puedes editar tus propios casos');
        return;
    }
    
    currentCaseToEdit = caso;
    mostrarModalEdicionCaso(caso);
}

// Mostrar modal de caso
function mostrarModalCaso(caso) {
    const content = document.getElementById('viewCaseContent');
    content.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>Información General</h6>
                <p><strong>Expediente:</strong> ${caso.expediente}</p>
                <p><strong>Origen:</strong> ${caso.origen_solicitud || '-'}</p>
                <p><strong>Tipo:</strong> ${caso.tipo_requerimiento || '-'}</p>
                <p><strong>Estado:</strong> <span class="badge ${caso.completado ? 'bg-success' : 'bg-warning'}">${caso.estado_caso}</span></p>
            </div>
            <div class="col-md-6">
                <h6>Fechas</h6>
                <p><strong>Creación:</strong> ${new Date(caso.fecha_creacion).toLocaleString('es-ES')}</p>
                <p><strong>Actualización:</strong> ${new Date(caso.fecha_actualizacion).toLocaleString('es-ES')}</p>
                ${caso.fecha_intervencion ? `<p><strong>Intervención:</strong> ${new Date(caso.fecha_intervencion).toLocaleDateString('es-ES')}</p>` : ''}
            </div>
        </div>
        ${caso.observaciones ? `<div class="mt-3"><h6>Observaciones</h6><p>${caso.observaciones}</p></div>` : ''}
    `;
    
    document.getElementById('viewCaseModal').style.display = 'block';
}

// Mostrar modal de edición
function mostrarModalEdicionCaso(caso) {
    const content = document.getElementById('editCaseContent');
    content.innerHTML = `
        <form id="formEditarCaso">
            <div class="mb-3">
                <label for="editOrigen" class="form-label">Origen de Solicitud</label>
                <input type="text" class="form-control" id="editOrigen" value="${caso.origen_solicitud || ''}">
            </div>
            <div class="mb-3">
                <label for="editTipo" class="form-label">Tipo de Requerimiento</label>
                <input type="text" class="form-control" id="editTipo" value="${caso.tipo_requerimiento || ''}">
            </div>
            <div class="mb-3">
                <label for="editEstado" class="form-label">Estado</label>
                <select class="form-select" id="editEstado">
                    <option value="En Proceso" ${caso.estado_caso === 'En Proceso' ? 'selected' : ''}>En Proceso</option>
                    <option value="Completado" ${caso.estado_caso === 'Completado' ? 'selected' : ''}>Completado</option>
                    <option value="Archivado" ${caso.estado_caso === 'Archivado' ? 'selected' : ''}>Archivado</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="editObservaciones" class="form-label">Observaciones</label>
                <textarea class="form-control" id="editObservaciones" rows="3">${caso.observaciones || ''}</textarea>
            </div>
        </form>
    `;
    
    document.getElementById('editCaseModal').style.display = 'block';
}

// Guardar edición de caso
async function guardarEdicionCaso() {
    if (!currentCaseToEdit) return;
    
    try {
        const data = {
            origen_solicitud: document.getElementById('editOrigen').value,
            tipo_requerimiento: document.getElementById('editTipo').value,
            estado_caso: document.getElementById('editEstado').value,
            observaciones: document.getElementById('editObservaciones').value
        };
        
        const response = await fetch(`/api/caso/${currentCaseToEdit.id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Caso actualizado correctamente');
            cerrarModal('editCaseModal');
            cargarTodosLosCasos();
            cargarCasosPendientes();
        } else {
            alert('Error al actualizar: ' + result.error);
        }
    } catch (error) {
        console.error('Error actualizando caso:', error);
        alert('Error de conexión');
    }
}

// Actualizar perfil
async function actualizarPerfil() {
    try {
        const data = {
            nombre_completo: document.getElementById('nombreCompleto').value,
            email: document.getElementById('email').value,
            assemblyai_key: document.getElementById('assemblyaiKey').value
        };
        
        const response = await fetch('/api/mi-perfil', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Perfil actualizado correctamente');
        } else {
            alert('Error al actualizar: ' + result.error);
        }
    } catch (error) {
        console.error('Error actualizando perfil:', error);
        alert('Error de conexión');
    }
}

// Cambiar contraseña
async function cambiarPassword() {
    const passwordActual = document.getElementById('passwordActual').value;
    const passwordNueva = document.getElementById('passwordNueva').value;
    const passwordConfirmar = document.getElementById('passwordConfirmar').value;
    
    if (passwordNueva !== passwordConfirmar) {
        alert('Las contraseñas no coinciden');
        return;
    }
    
    if (passwordNueva.length < 6) {
        alert('La contraseña debe tener al menos 6 caracteres');
        return;
    }
    
    try {
        const data = {
            password_actual: passwordActual,
            password_nueva: passwordNueva
        };
        
        const response = await fetch('/api/cambiar-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Contraseña cambiada correctamente');
            document.getElementById('formPassword').reset();
        } else {
            alert('Error al cambiar contraseña: ' + result.error);
        }
    } catch (error) {
        console.error('Error cambiando contraseña:', error);
        alert('Error de conexión');
    }
}

// Exportar mis casos
async function exportarMisCasos() {
    try {
        const response = await fetch('/api/exportar-mis-casos');
        const data = await response.json();
        
        if (data.success) {
            const blob = new Blob([data.content], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = data.filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            alert('Casos exportados exitosamente');
        } else {
            alert('Error al exportar: ' + data.error);
        }
    } catch (error) {
        console.error('Error exportando casos:', error);
        alert('Error de conexión');
    }
}

// Cerrar modal
function cerrarModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

// Cerrar modal al hacer clic fuera
window.onclick = function(event) {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    });
}
</script>

<style>
.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: #fefefe;
    margin: 5% auto;
    padding: 0;
    border: none;
    border-radius: 8px;
    width: 80%;
    max-width: 600px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.modal-centered {
    margin: 10% auto;
}

.modal-header {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #dee2e6;
    background-color: #f8f9fa;
    border-radius: 8px 8px 0 0;
}

.modal-body {
    padding: 1.5rem;
}

.modal-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid #dee2e6;
    background-color: #f8f9fa;
    border-radius: 0 0 8px 8px;
}

.btn-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    float: right;
}

.fade-in-up {
    animation: fadeInUp 0.6s ease-out;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>
{% endblock %}
