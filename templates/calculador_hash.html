{% extends "base_sidebar.html" %}

{% block title %}Herramientas Forenses Digitales v2.0{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Pestañas de navegación -->
    <ul class="nav nav-tabs mb-4" id="herramientasTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="hash-tab" data-bs-toggle="tab" data-bs-target="#hash-pane" type="button" role="tab">
                <i class="fas fa-calculator me-2"></i>Calculador de Hash
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="forense-tab" data-bs-toggle="tab" data-bs-target="#forense-pane" type="button" role="tab">
                <i class="fas fa-search me-2"></i>Análisis Forense
            </button>
        </li>
    </ul>

    <div class="tab-content" id="herramientasTabsContent">
        <!-- Pestaña Calculador de Hash -->
        <div class="tab-pane fade show active" id="hash-pane" role="tabpanel">
            <div class="row">
                <div class="col-12">
                    <div class="card shadow">
                        <div class="card-header bg-primary text-white">
                            <h4 class="mb-0">
                                <i class="fas fa-calculator me-2"></i>Calculador de Hash de Archivos
                            </h4>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-4">
                                        <label for="archivoInput" class="form-label">Seleccionar Archivo:</label>
                                        <input type="file" class="form-control" id="archivoInput" multiple>
                                        <div class="form-text">Puede seleccionar múltiples archivos o una carpeta completa</div>
                                    </div>
                                    <div class="mb-4">
                                        <label for="rutaInput" class="form-label">Seleccionar carpeta:</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="rutaInput" 
                                                placeholder="Seleccione una carpeta..." readonly>
                                            <button class="btn btn-outline-secondary" type="button" onclick="seleccionarCarpeta()">
                                                <i class="fas fa-folder-open me-2"></i>Seleccionar
                                            </button>
                                        </div>
                                        <div class="form-text">Seleccione la carpeta a procesar</div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="algoritmoSelect" class="form-label">Algoritmo de Hash:</label>
                                        <select class="form-select" id="algoritmoSelect">
                                            <option value="md5">MD5</option>
                                            <option value="sha1">SHA-1</option>
                                            <option value="sha256" selected>SHA-256</option>
                                            <option value="sha512">SHA-512</option>
                                        </select>
                                    </div>
                                    <button class="btn btn-primary" onclick="calcularHashArchivos()">
                                        <i class="fas fa-calculator me-2"></i>Calcular Hash
                                    </button>
                                    <button class="btn btn-secondary ms-2" onclick="limpiarHash()">
                                        <i class="fas fa-trash me-2"></i>Limpiar
                                    </button>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-4">
                                        <label for="resultadoHash" class="form-label">Resultado del Hash:</label>
                                        <textarea class="form-control" id="resultadoHash" rows="8" readonly
                                            placeholder="Los hashes aparecerán aquí..."></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <button class="btn btn-success" onclick="copiarHash()" id="copiarBtn" disabled>
                                            <i class="fas fa-copy me-2"></i>Copiar Resultados
                                        </button>
                                        <button class="btn btn-info ms-2" onclick="guardarEnCarpeta()" id="guardarBtn" disabled>
                                            <i class="fas fa-save me-2"></i>Guardar en Carpeta
                                        </button>
                                    </div>
                                    
                                    <div class="alert alert-info">
                                        <h6><i class="fas fa-info-circle me-2"></i>Información:</h6>
                                        <ul class="mb-0">
                                            <li><strong>MD5:</strong> 128 bits (32 caracteres hex)</li>
                                            <li><strong>SHA-1:</strong> 160 bits (40 caracteres hex)</li>
                                            <li><strong>SHA-256:</strong> 256 bits (64 caracteres hex)</li>
                                            <li><strong>SHA-512:</strong> 512 bits (128 caracteres hex)</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pestaña Análisis Forense -->
        <div class="tab-pane fade" id="forense-pane" role="tabpanel">
            <div class="row">
                <div class="col-12">
                    <div class="card shadow">
                        <div class="card-header bg-danger text-white">
                            <h4 class="mb-0">
                                <i class="fas fa-search me-2"></i>Análisis Forense Digital
                            </h4>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-4">
                                        <label for="imagenForense" class="form-label">Seleccionar Imagen Forense:</label>
                                        <input type="file" class="form-control" id="imagenForense" 
                                            accept=".dd,.e01,.img,.iso,.vmdk,.vhd">
                                        <div class="form-text">Formatos soportados: DD, E01, IMG, ISO, VMDK, VHD</div>
                                    </div>
                                    <div class="mb-4">
                                        <label for="tipoAnalisis" class="form-label">Tipo de Análisis:</label>
                                        <select class="form-select" id="tipoAnalisis">
                                            <option value="hash">Verificación de Integridad (Hash)</option>
                                            <option value="metadata">Extracción de Metadatos</option>
                                            <option value="timeline">Análisis de Línea de Tiempo</option>
                                            <option value="deleted">Recuperación de Archivos Eliminados</option>
                                            <option value="registry">Análisis de Registro</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="hashVerificacion">
                                            <label class="form-check-label" for="hashVerificacion">
                                                Generar hash de verificación
                                            </label>
                                        </div>
                                    </div>
                                    <button class="btn btn-danger" onclick="iniciarAnalisisForense()">
                                        <i class="fas fa-search me-2"></i>Iniciar Análisis
                                    </button>
                                    <button class="btn btn-warning ms-2" onclick="generarReporte()" id="reporteBtn" disabled>
                                        <i class="fas fa-file-pdf me-2"></i>Generar Reporte
                                    </button>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-4">
                                        <label for="resultadoForense" class="form-label">Resultado del Análisis:</label>
                                        <textarea class="form-control" id="resultadoForense" rows="8" readonly
                                            placeholder="Los resultados del análisis forense aparecerán aquí..."></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <button class="btn btn-success" onclick="copiarResultadoForense()" id="copiarForenseBtn" disabled>
                                            <i class="fas fa-copy me-2"></i>Copiar Resultados
                                        </button>
                                        <button class="btn btn-info ms-2" onclick="exportarForense()" id="exportarForenseBtn" disabled>
                                            <i class="fas fa-download me-2"></i>Exportar Reporte
                                        </button>
                                    </div>
                                    <div class="alert alert-warning">
                                        <h6><i class="fas fa-exclamation-triangle me-2"></i>Advertencia:</h6>
                                        <p class="mb-0">Esta herramienta es para uso forense profesional. Asegúrese de trabajar con copias de evidencia y mantener la cadena de custodia.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para verificación de hash -->
<div class="modal fade" id="verificarModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Verificar Hash</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="hashVerificar" class="form-label">Hash a verificar:</label>
                    <input type="text" class="form-control" id="hashVerificar" 
                        placeholder="Pegue aquí el hash que desea verificar">
                </div>
                <div class="alert alert-info">
                    <strong>Texto original:</strong><br>
                    <span id="textoOriginal"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" onclick="verificarHashCompleto()">Verificar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para seleccionar carpeta -->
<div class="modal fade" id="modalSeleccionarCarpeta" tabindex="-1" aria-labelledby="modalSeleccionarCarpetaLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalSeleccionarCarpetaLabel">
                    <i class="fas fa-folder-open me-2"></i>Seleccionar Carpeta
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-8">
                        <label for="rutaCarpetaModal" class="form-label">Ruta de la carpeta:</label>
                        <input type="text" class="form-control" id="rutaCarpetaModal" 
                            placeholder="Seleccione una carpeta..." readonly>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-grid">
                            <button class="btn btn-outline-primary" type="button" onclick="explorarCarpetas()">
                                <i class="fas fa-folder-open me-2"></i>Explorar
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="recursivoModal">
                        <label class="form-check-label" for="recursivoModal">
                            <i class="fas fa-sitemap me-1"></i>Explorar subcarpetas recursivamente
                        </label>
                    </div>
                    
                    <!-- Box informativo sobre recursivo -->
                    <div class="alert alert-info mt-3 border-0">
                        <div class="d-flex align-items-start">
                            <i class="fas fa-info-circle text-info me-2 mt-1"></i>
                            <div>
                                <strong>¿Qué significa "recursivo"?</strong>
                                <ul class="mb-0 mt-2 small">
                                    <li><strong>Sin recursivo:</strong> Solo procesa archivos en la carpeta principal</li>
                                    <li><strong>Con recursivo:</strong> Procesa archivos en la carpeta principal Y todas sus subcarpetas</li>
                                </ul>
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-lightbulb me-1"></i>
                                        <strong>Ejemplo:</strong> Si tienes una carpeta "Documentos" con subcarpetas "2024" y "2023", 
                                        el modo recursivo procesará archivos de todas las carpetas.
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="boxVerde" class="alert alert-success mt-3" style="display: none;">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-check-circle me-2"></i>
                        <div>
                            <strong>Carpeta seleccionada correctamente</strong>
                            <div class="small" id="infoCarpeta"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="confirmarSeleccionCarpeta()">
                    <i class="fas fa-check me-2"></i>Confirmar Selección
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let archivosProcesados = [];
let resultadosForenses = [];
let rutaOrigenTemporal = null; // Variable temporal para almacenar la ruta de origen
let csvLogContent = ''; // Variable global para guardar el contenido del log CSV

// ===== FUNCIONES DE HASH DE ARCHIVOS =====

// Función para detectar el tipo de navegador y método recomendado
function detectarNavegadorYMetodo() {
    const userAgent = navigator.userAgent.toLowerCase();
    const isChrome = userAgent.includes('chrome') && !userAgent.includes('edg');
    const isFirefox = userAgent.includes('firefox');
    const isEdge = userAgent.includes('edg');
    const isOpera = userAgent.includes('opera') || userAgent.includes('opr');
    const isSafari = userAgent.includes('safari') && !userAgent.includes('chrome');
    
    const info = {
        navegador: 'Desconocido',
        metodo: 'tradicional',
        soportaFileSystemAPI: 'showDirectoryPicker' in window,
        recomendacion: 'Usar método tradicional'
    };
    
    if (isChrome) {
        info.navegador = 'Chrome';
        info.metodo = 'fileSystemAPI';
        info.recomendacion = 'Usar File System Access API';
    } else if (isFirefox) {
        info.navegador = 'Firefox';
        info.metodo = 'tradicional';
        info.recomendacion = 'Usar método tradicional (webkitdirectory)';
    } else if (isEdge) {
        info.navegador = 'Edge';
        info.metodo = 'fileSystemAPI';
        info.recomendacion = 'Usar File System Access API';
    } else if (isOpera) {
        info.navegador = 'Opera';
        info.metodo = 'fileSystemAPI';
        info.recomendacion = 'Usar File System Access API';
    } else if (isSafari) {
        info.navegador = 'Safari';
        info.metodo = 'tradicional';
        info.recomendacion = 'Usar método tradicional (webkitdirectory)';
    }
    
    console.log('🔍 Detección de navegador:', info);
    return info;
}

// Función para generar el contenido del log en formato CSV
function generateCsvLog(results) {
    let csv = 'Archivo,Tamaño (MB),Algoritmo,Hash,Fecha de Procesamiento\r\n'; // Encabezados del CSV
    
    results.forEach(result => {
        // Asegurarse de que los nombres de archivo con comas estén entre comillas
        const fileName = `"${result.nombre.replace(/"/g, '""')}"`; 
        const sizeInMB = (result.tamaño / (1024 * 1024)).toFixed(2);
        const fecha = new Date(result.fecha).toLocaleString();
        
        csv += `${fileName},${sizeInMB},${result.algoritmo.toUpperCase()},${result.hash},"${fecha}"\r\n`;
    });
    
    return csv;
}

function seleccionarCarpeta() {
    console.log('📁 Abriendo modal de selección de carpeta...');
    
    // Limpiar campos del modal
    document.getElementById('rutaCarpetaModal').value = '';
    document.getElementById('recursivoModal').checked = false;
    
    // Ocultar box verde si existe
    const boxVerde = document.getElementById('boxVerde');
    if (boxVerde) {
        boxVerde.style.display = 'none';
    }
    
    // Mostrar el modal usando Bootstrap
    const modal = new bootstrap.Modal(document.getElementById('modalSeleccionarCarpeta'));
    modal.show();
    console.log('✅ Modal mostrado correctamente');
}

// Asegurar que todas las funciones estén disponibles globalmente
window.seleccionarCarpeta = seleccionarCarpeta;
window.explorarCarpetas = explorarCarpetas;
window.confirmarSeleccionCarpeta = confirmarSeleccionCarpeta;
window.calcularHashArchivos = calcularHashArchivos;
window.guardarEnCarpeta = guardarEnCarpeta;
window.copiarRutaAlPortapapeles = copiarRutaAlPortapapeles;
window.abrirCarpetaOrigen = abrirCarpetaOrigen;
window.detectarNavegadorYMetodo = detectarNavegadorYMetodo;

// Event Listener para inicialización
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 Calculador de Hash inicializado correctamente');
    
    // Detectar navegador al cargar la página
    const infoNavegador = detectarNavegadorYMetodo();
    console.log(`🔍 Navegador detectado: ${infoNavegador.navegador}`);
    console.log(`📱 Método recomendado: ${infoNavegador.recomendacion}`);
});

// ===== FUNCIONES DE EXPLORACIÓN DE CARPETAS =====

async function explorarCarpetas() {
    try {
        // Detectar navegador y método recomendado
        const infoNavegador = detectarNavegadorYMetodo();
        
        console.log(`🚀 Navegador detectado: ${infoNavegador.navegador}`);
        console.log(`📱 Método recomendado: ${infoNavegador.recomendacion}`);
        console.log(`🔧 File System API disponible: ${infoNavegador.soportaFileSystemAPI}`);
        
        // Decidir qué método usar basado en la detección
        const usarFileSystemAPI = infoNavegador.soportaFileSystemAPI && 
                                 (infoNavegador.metodo === 'fileSystemAPI');
        
        if (usarFileSystemAPI) {
            console.log('🚀 Usando File System Access API (recomendado para este navegador)...');
            
            // Solicitar acceso al directorio
            const directoryHandle = await window.showDirectoryPicker({
                mode: 'read',
                startIn: 'documents' // Empezar en la carpeta de documentos
            });
            
            console.log('📁 Directory Handle obtenido:', directoryHandle);
            console.log('📁 Nombre del directorio:', directoryHandle.name);
            console.log('📁 Tipo:', directoryHandle.kind);
            
            // Intentar obtener la ruta completa si está disponible
            let rutaCompleta = directoryHandle.name;
            try {
                // En algunos navegadores, el directoryHandle puede tener una propiedad 'path' o similar
                if (directoryHandle.path) {
                    rutaCompleta = directoryHandle.path;
                    console.log('📁 Ruta completa encontrada:', rutaCompleta);
                } else {
                    console.log('⚠️ Ruta completa no disponible, usando solo nombre');
                }
            } catch (error) {
                console.log('⚠️ No se pudo obtener ruta completa:', error);
            }
            
            // Actualizar el campo de ruta en el modal
            document.getElementById('rutaCarpetaModal').value = rutaCompleta;
            
            // Mostrar información de la carpeta seleccionada
            mostrarInfoCarpeta(directoryHandle.name, rutaCompleta);
            
            // Guardar el directoryHandle para uso posterior
            window.directoryHandleActual = directoryHandle;
            console.log('💾 DirectoryHandle guardado en window.directoryHandleActual');
            
            // Limpiar archivos seleccionados tradicionalmente si existen
            window.archivosSeleccionados = null;
            
        } else {
            console.log(`🔄 Usando método tradicional (recomendado para ${infoNavegador.navegador})...`);
            console.log('📱 Navegador:', navigator.userAgent);
            // Usar método tradicional
            usarSelectorTradicional();
        }
        
    } catch (error) {
        console.log('⚠️ Error con el método seleccionado:', error);
        if (error.name === 'AbortError') {
            console.log('👤 Usuario canceló la selección');
            return;
        }
        console.log('🔄 Fallback al método tradicional...');
        // Fallback al método tradicional
        usarSelectorTradicional();
    }
}

function usarSelectorTradicional() {
    console.log('📁 Usando selector tradicional de archivos...');
    
    // Crear un input de tipo directorio
    const input = document.createElement('input');
    input.type = 'file';
    input.webkitdirectory = true;
    input.multiple = true;
    
    input.onchange = function(e) {
        if (e.target.files.length > 0) {
            console.log('📁 Archivos seleccionados tradicionalmente:', e.target.files.length);
            
            // Obtener la ruta de la carpeta seleccionada
            const rutaCompleta = e.target.files[0].webkitRelativePath;
            const rutaCarpeta = rutaCompleta.split('/')[0];
            
            console.log('📁 Ruta de carpeta:', rutaCarpeta);
            console.log('📁 Ruta completa:', rutaCompleta);
            
            // Debug: mostrar información de los archivos
            console.log('🔍 DEBUG - Primeros 3 archivos:');
            for (let i = 0; i < Math.min(3, e.target.files.length); i++) {
                const archivo = e.target.files[i];
                console.log(`  Archivo ${i}:`, {
                    name: archivo.name,
                    webkitRelativePath: archivo.webkitRelativePath,
                    relativePath: archivo.relativePath
                });
            }
            
            // Actualizar el campo de ruta en el modal
            document.getElementById('rutaCarpetaModal').value = rutaCarpeta;
            
            // Mostrar información de la carpeta seleccionada
            mostrarInfoCarpeta(rutaCarpeta, rutaCarpeta);
            
            // Guardar los archivos para uso posterior
            window.archivosSeleccionados = e.target.files;
            console.log('💾 Archivos guardados en window.archivosSeleccionados');
            
            // Limpiar directoryHandle si existe
            window.directoryHandleActual = null;
        } else {
            console.log('⚠️ No se seleccionaron archivos');
        }
    };
    
    input.click();
}

function mostrarInfoCarpeta(nombreCarpeta, rutaCompleta) {
    console.log('📁 Mostrando información de carpeta:', nombreCarpeta);
    
    // Detectar información del navegador
    const infoNavegador = detectarNavegadorYMetodo();
    
    // Mostrar el box verde
    const boxVerde = document.getElementById('boxVerde');
    const infoCarpeta = document.getElementById('infoCarpeta');
    
    if (boxVerde && infoCarpeta) {
        infoCarpeta.innerHTML = `
            <div class="mb-1">
                <strong>Nombre:</strong> ${nombreCarpeta}
            </div>
            <div class="mb-1">
                <strong>Ruta:</strong> <code>${rutaCompleta}</code>
            </div>
            <div class="mb-1">
                <strong>Navegador:</strong> ${infoNavegador.navegador}
            </div>
            <div class="mb-1">
                <strong>Método:</strong> ${infoNavegador.recomendacion}
            </div>
            <div class="mb-0">
                <i class="fas fa-check-circle text-success me-1"></i>
                <span class="text-success">Lista para procesar</span>
            </div>
        `;
        
        boxVerde.style.display = 'block';
        console.log('✅ Información de carpeta mostrada correctamente');
    } else {
        console.error('❌ No se encontraron los elementos boxVerde o infoCarpeta');
    }
}

function confirmarSeleccionCarpeta() {
    console.log('✅ Confirmando selección de carpeta...');
    
    const rutaCarpeta = document.getElementById('rutaCarpetaModal').value;
    const recursivo = document.getElementById('recursivoModal').checked;
    
    if (!rutaCarpeta.trim()) {
        alert('Por favor, seleccione una carpeta antes de confirmar.');
        return;
    }
    
    // Actualizar el campo principal de ruta
    document.getElementById('rutaInput').value = rutaCarpeta;
    
    // Guardar la ruta de origen en variable temporal
    rutaOrigenTemporal = rutaCarpeta;
    console.log('💾 Ruta de origen guardada temporalmente:', rutaOrigenTemporal);
    
    // Guardar el estado recursivo en una variable global
    window.recursivoSeleccionado = recursivo;
    console.log('💾 Modo recursivo guardado:', window.recursivoSeleccionado);
    
    // Mostrar información en el formulario principal
    mostrarInfoCarpetaPrincipal(rutaCarpeta, recursivo);
    
    
    // Cerrar el modal usando Bootstrap
    const modal = bootstrap.Modal.getInstance(document.getElementById('modalSeleccionarCarpeta'));
    if (modal) {
        modal.hide();
    }
    
    console.log('✅ Selección de carpeta confirmada:', rutaCarpeta, 'Recursivo:', recursivo);
}

function mostrarInfoCarpetaPrincipal(rutaCarpeta, recursivo) {
    // Remover información anterior si existe
    const infoAnterior = document.querySelector('.alert-info');
    if (infoAnterior) {
        infoAnterior.remove();
    }
    
    // Crear nueva información
            const info = document.createElement('div');
            info.className = 'alert alert-info mt-2';
            info.innerHTML = `
                <div class="d-flex align-items-center mb-2">
                    <i class="fas fa-folder-open me-2"></i>
                    <strong>Carpeta seleccionada</strong>
                </div>
                <div class="mb-2">
                    <code class="bg-light p-2 rounded d-block">${rutaCarpeta}</code>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <small class="text-muted">
                    <i class="fas fa-sitemap me-1"></i>
                    <strong>Modo:</strong> ${recursivo ? 'Recursivo' : 'Solo carpeta principal'}
                        </small>
                    </div>
                    <div class="col-md-6">
                        <small class="text-muted">
                            <i class="fas fa-check-circle me-1"></i>
                            Lista para procesar
                        </small>
                    </div>
                </div>
            `;
            
            // Insertar después del input group
            document.getElementById('rutaInput').parentNode.parentNode.appendChild(info);
        }


// Función para copiar la ruta al portapapeles
async function copiarRutaAlPortapapeles() {
    if (rutaOrigenTemporal) {
        try {
            await navigator.clipboard.writeText(rutaOrigenTemporal);
            alert(`✅ Ruta copiada al portapapeles:\n\n${rutaOrigenTemporal}\n\n💡 Ahora puedes pegar la ruta (Ctrl+V) en el explorador de archivos.`);
        } catch (error) {
            console.error('❌ Error copiando al portapapeles:', error);
            alert('❌ Error al copiar la ruta al portapapeles. Intenta copiarla manualmente.');
        }
    }
}

// Función para abrir la carpeta de origen
function abrirCarpetaOrigen() {
    if (rutaOrigenTemporal) {
        // Crear un enlace temporal para abrir la carpeta
        const link = document.createElement('a');
        link.href = `file:///${rutaOrigenTemporal.replace(/\\/g, '/')}`;
        link.target = '_blank';
        link.click();
        
        // También copiar la ruta al portapapeles
        copiarRutaAlPortapapeles();
        
        alert(`📁 Intentando abrir la carpeta:\n\n${rutaOrigenTemporal}\n\n💡 Si no se abre automáticamente, la ruta está copiada en tu portapapeles para pegarla manualmente.`);
    }
}

// ===== FUNCIONES DE API PARA EXPLORAR RUTAS =====

async function explorarRutaServidor(ruta, recursivo = false) {
    try {
        console.log('🌐 Explorando ruta en servidor:', ruta, 'Recursivo:', recursivo);
        
        const response = await fetch('/api/explorar-ruta', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                ruta: ruta,
                recursivo: recursivo
            })
        });
        
        if (!response.ok) {
            throw new Error(`Error del servidor: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('✅ Respuesta del servidor:', data);
        
        return data;
        
    } catch (error) {
        console.error('❌ Error al explorar ruta en servidor:', error);
        throw error;
    }
}

async function procesarArchivosServidor(archivos, algoritmo) {
    try {
        console.log('🌐 Procesando archivos en servidor:', archivos.length, 'archivos');
        
        const formData = new FormData();
        
        // Agregar archivos al FormData
        for (let i = 0; i < archivos.length; i++) {
            formData.append('archivos', archivos[i]);
        }
        
        // Agregar parámetros
        formData.append('algoritmo', algoritmo);
        
        const response = await fetch('/api/calcular-hash', {
            method: 'POST',
            body: formData
        });
        
        if (!response.ok) {
            throw new Error(`Error del servidor: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('✅ Hashes calculados en servidor:', data);
        
        return data;
        
    } catch (error) {
        console.error('❌ Error al procesar archivos en servidor:', error);
        throw error;
    }
}

async function obtenerArchivosDeRuta(ruta, recursivo = false) {
    try {
        console.log('📁 Obteniendo archivos de ruta:', ruta);
        console.log('📁 Recursivo:', recursivo);
        console.log('📁 directoryHandleActual:', window.directoryHandleActual);
        console.log('📁 archivosSeleccionados:', window.archivosSeleccionados);
        
        // Detectar navegador para optimizar el orden de prioridades
        const infoNavegador = detectarNavegadorYMetodo();
        console.log(`🔍 Navegador detectado: ${infoNavegador.navegador}, Método: ${infoNavegador.metodo}`);
        
        // Prioridad 1: Si tenemos archivos seleccionados tradicionalmente, usarlos
        if (window.archivosSeleccionados && window.archivosSeleccionados.length > 0) {
            console.log('📁 Usando archivos seleccionados tradicionalmente:', window.archivosSeleccionados.length);
            return Array.from(window.archivosSeleccionados);
        }
        
        // Prioridad 2: Si tenemos un directoryHandle, explorarlo (especialmente para Chrome/Edge/Opera)
        if (window.directoryHandleActual) {
            console.log('📁 Explorando directoryHandle');
            try {
                const archivos = await explorarDirectoryHandle(window.directoryHandleActual, recursivo);
                if (archivos.length > 0) {
                    console.log('✅ Archivos encontrados con directoryHandle:', archivos.length);
                    return archivos;
                } else {
                    console.log('⚠️ No se encontraron archivos con directoryHandle');
                }
            } catch (error) {
                console.error('❌ Error explorando directoryHandle:', error);
            }
        }
        
        // Prioridad 3: Intentar con el servidor (solo si la ruta parece ser del servidor)
        if (ruta.includes('casos_data') || ruta.startsWith('/') || ruta.includes('\\')) {
            console.log('🌐 Explorando ruta en servidor');
            try {
                const data = await explorarRutaServidor(ruta, recursivo);
                if (data.archivos && data.archivos.length > 0) {
                    console.log('✅ Archivos encontrados con servidor:', data.archivos.length);
                    return data.archivos;
                } else {
                    console.log('⚠️ No se encontraron archivos con servidor');
                }
            } catch (error) {
                console.error('❌ Error explorando con servidor:', error);
            }
        } else {
            console.log('⚠️ Ruta no parece ser del servidor, saltando exploración del servidor');
        }
        
        // Si llegamos aquí, no se encontraron archivos
        console.log('❌ No se encontraron archivos con ningún método');
        
        // Mostrar información específica del navegador
        console.log(`💡 Sugerencia para ${infoNavegador.navegador}: ${infoNavegador.recomendacion}`);
        return [];
        
    } catch (error) {
        console.error('❌ Error al obtener archivos de ruta:', error);
        throw error;
    }
}

async function explorarDirectoryHandle(directoryHandle, recursivo = false, rutaPadre = '') {
    const archivos = [];
    
    try {
        console.log('📁 Explorando directoryHandle recursivamente:', recursivo);
        console.log('📁 DirectoryHandle:', directoryHandle);
        console.log('📁 Ruta padre:', rutaPadre);
        
        // Verificar que el directoryHandle sea válido
        if (!directoryHandle || typeof directoryHandle.entries !== 'function') {
            console.error('❌ DirectoryHandle inválido');
            return [];
        }
        
        let count = 0;
        for await (const [name, handle] of directoryHandle.entries()) {
            count++;
            console.log(`📁 Procesando entrada ${count}:`, name, 'Tipo:', handle.kind);
            
            if (handle.kind === 'file') {
                try {
                    const file = await handle.getFile();
                    
                    // Construir la ruta relativa manualmente
                    const rutaRelativa = rutaPadre ? `${rutaPadre}/${name}` : name;
                    // Usar una propiedad personalizada ya que webkitRelativePath es de solo lectura
                    file._rutaRelativa = rutaRelativa;
                    
                    archivos.push(file);
                    console.log('📄 Archivo encontrado:', name, 'Ruta relativa:', rutaRelativa, 'Tamaño:', file.size);
                } catch (fileError) {
                    console.error('❌ Error obteniendo archivo:', name, fileError);
                }
            } else if (handle.kind === 'directory' && recursivo) {
                console.log('📁 Explorando subdirectorio:', name);
                try {
                    const nuevaRutaPadre = rutaPadre ? `${rutaPadre}/${name}` : name;
                    const subArchivos = await explorarDirectoryHandle(handle, recursivo, nuevaRutaPadre);
                    archivos.push(...subArchivos);
                    console.log('📁 Subdirectorio procesado:', name, 'Archivos:', subArchivos.length);
                } catch (subError) {
                    console.error('❌ Error explorando subdirectorio:', name, subError);
                }
            }
        }
        
        console.log('✅ Total de archivos encontrados:', archivos.length);
        console.log('✅ Total de entradas procesadas:', count);
        return archivos;
        
    } catch (error) {
        console.error('❌ Error al explorar directoryHandle:', error);
        console.error('❌ Error details:', error.message, error.stack);
        return [];
    }
}

// Verificar que la función esté disponible cuando se carga la página
document.addEventListener('DOMContentLoaded', function() {
    console.log('Verificando función seleccionarCarpeta:', typeof window.seleccionarCarpeta);
    if (typeof window.seleccionarCarpeta !== 'function') {
        console.error('ERROR: seleccionarCarpeta no está definida');
    } else {
        console.log('✅ seleccionarCarpeta está disponible correctamente');
    }
});

async function calcularHashArchivos() {
    const archivos = document.getElementById('archivoInput').files;
    const ruta = document.getElementById('rutaInput').value;
    const algoritmo = document.getElementById('algoritmoSelect').value;
    // Usar el valor recursivo guardado o el del modal
    const recursivo = window.recursivoSeleccionado || document.getElementById('recursivoModal').checked;
    console.log('🔍 Modo recursivo detectado:', recursivo);
    
    if (archivos.length === 0 && !ruta.trim()) {
        alert('Por favor, seleccione archivos o ingrese una ruta.');
        return;
    }
    
    document.getElementById('resultadoHash').value = 'Procesando archivos...\n';
    document.getElementById('copiarBtn').disabled = true;
    document.getElementById('guardarBtn').disabled = true;
    
    let resultados = '';
    archivosProcesados = [];
    
    try {
        if (archivos.length > 0) {
            // Procesar archivos seleccionados directamente
            console.log('📄 Procesando archivos seleccionados:', archivos.length);
            
            for (let i = 0; i < archivos.length; i++) {
                const archivo = archivos[i];
                const hash = await calcularHashArchivo(archivo, algoritmo);
                const resultado = `${archivo.name} | ${algoritmo.toUpperCase()}: ${hash}\n`;
                resultados += resultado;
                archivosProcesados.push({
                    nombre: archivo.name,
                    ruta: archivo.webkitRelativePath || archivo.name,
                    algoritmo: algoritmo,
                    hash: hash,
                    tamaño: archivo.size,
                    fecha: new Date(archivo.lastModified).toISOString()
                });
            }
        } else if (ruta.trim()) {
            // Procesar ruta usando las nuevas funciones
            console.log('📁 Procesando ruta:', ruta, 'Recursivo:', recursivo);
            
            // Debug: mostrar información del estado actual
            console.log('🔍 DEBUG - Estado actual:');
            console.log('🔍 - window.directoryHandleActual:', window.directoryHandleActual);
            console.log('🔍 - window.archivosSeleccionados:', window.archivosSeleccionados);
            console.log('🔍 - Navegador:', navigator.userAgent);
            console.log('🔍 - File System Access API disponible:', 'showDirectoryPicker' in window);
            
            try {
                // Intentar obtener archivos de la ruta
                const archivosRuta = await obtenerArchivosDeRuta(ruta, recursivo);
                
                console.log('📄 Archivos obtenidos:', archivosRuta.length);
                
                if (archivosRuta.length > 0) {
                    console.log('📄 Archivos encontrados en ruta:', archivosRuta.length);
                    
                    // Procesar cada archivo con estructura de carpetas
                    for (let i = 0; i < archivosRuta.length; i++) {
                        const archivo = archivosRuta[i];
                        const hash = await calcularHashArchivo(archivo, algoritmo);
                        
                        // Determinar la ruta relativa para mostrar en el log
                        // Priorizar _rutaRelativa (construido en explorarDirectoryHandle), luego webkitRelativePath
                        let rutaRelativa = archivo._rutaRelativa || archivo.webkitRelativePath || archivo.relativePath || archivo.name;
                        
                        console.log('🔍 DEBUG - Archivo completo:', archivo);
                        console.log('🔍 DEBUG - Ruta relativa:', rutaRelativa);
                        console.log('🔍 DEBUG - Recursivo:', recursivo);
                        console.log('🔍 DEBUG - _rutaRelativa:', archivo._rutaRelativa);
                        console.log('🔍 DEBUG - webkitRelativePath:', archivo.webkitRelativePath);
                        console.log('🔍 DEBUG - relativePath:', archivo.relativePath);
                        
                        // Formatear la ruta para mostrar estructura de carpetas
                        let rutaFormateada;
                        
                        // Debug: mostrar información detallada
                        console.log('🔍 DEBUG - Condición recursivo:', recursivo);
                        console.log('🔍 DEBUG - rutaRelativa !== archivo.name:', rutaRelativa !== archivo.name);
                        console.log('🔍 DEBUG - rutaRelativa:', rutaRelativa);
                        console.log('🔍 DEBUG - archivo.name:', archivo.name);
                        console.log('🔍 DEBUG - rutaRelativa.includes("/"):', rutaRelativa.includes('/'));
                        
                        if (recursivo) {
                            // Si es recursivo, intentar mostrar estructura
                            if (rutaRelativa && rutaRelativa !== archivo.name && rutaRelativa.includes('/')) {
                                // Tenemos ruta relativa con estructura de carpetas
                                rutaFormateada = formatearRutaParaLog(rutaRelativa, recursivo);
                                console.log('🔍 DEBUG - Usando ruta relativa con estructura:', rutaFormateada);
                            } else {
                                // No tenemos ruta relativa, solo mostrar nombre
                                rutaFormateada = `📄 ${archivo.name}`;
                                console.log('🔍 DEBUG - No hay ruta relativa, usando solo nombre');
                            }
                        } else {
                            // Si no es recursivo, solo mostrar nombre
                            rutaFormateada = `📄 ${archivo.name}`;
                            console.log('🔍 DEBUG - No es recursivo, usando solo nombre');
                        }
                        
                        console.log('🔍 DEBUG - Ruta formateada:', rutaFormateada);
                        const resultado = `${rutaFormateada} | ${algoritmo.toUpperCase()}: ${hash}\n`;
                        resultados += resultado;
                        archivosProcesados.push({
                            nombre: archivo.name,
                            ruta: rutaRelativa,
                            algoritmo: algoritmo,
                            hash: hash,
                            tamaño: archivo.size,
                            fecha: new Date(archivo.lastModified).toISOString()
                        });
                    }
                } else {
                    resultados = `No se encontraron archivos en la ruta: ${ruta}\n`;
                    resultados += `Verifique que la ruta sea correcta y que contenga archivos.\n`;
                    resultados += `\n🔍 DEBUG INFO:\n`;
                    resultados += `- Navegador: ${navigator.userAgent}\n`;
                    resultados += `- File System Access API: ${'showDirectoryPicker' in window ? 'Disponible' : 'No disponible'}\n`;
                    resultados += `- DirectoryHandle: ${window.directoryHandleActual ? 'Disponible' : 'No disponible'}\n`;
                    resultados += `- Archivos seleccionados: ${window.archivosSeleccionados ? window.archivosSeleccionados.length : 'No disponible'}\n`;
                    resultados += `\n💡 SOLUCIONES SUGERIDAS:\n`;
                    resultados += `1. Usa el botón "Seleccionar" para elegir archivos directamente\n`;
                    resultados += `2. Verifica que la carpeta contenga archivos\n`;
                    resultados += `3. Intenta con el modo recursivo habilitado\n`;
                    resultados += `4. Usa un navegador diferente (Chrome vs Firefox)\n`;
                }
                
            } catch (error) {
                console.error('❌ Error al procesar ruta:', error);
                resultados = `Error al procesar la ruta: ${error.message}\n`;
                resultados += `Ruta: ${ruta}\n`;
                resultados += `Modo recursivo: ${recursivo ? 'Sí' : 'No'}\n`;
                resultados += `\n🔍 DEBUG INFO:\n`;
                resultados += `- Navegador: ${navigator.userAgent}\n`;
                resultados += `- File System Access API: ${'showDirectoryPicker' in window ? 'Disponible' : 'No disponible'}\n`;
                resultados += `- DirectoryHandle: ${window.directoryHandleActual ? 'Disponible' : 'No disponible'}\n`;
                resultados += `- Archivos seleccionados: ${window.archivosSeleccionados ? window.archivosSeleccionados.length : 'No disponible'}\n`;
            }
        }
        
        document.getElementById('resultadoHash').value = resultados;
        document.getElementById('copiarBtn').disabled = false;
        document.getElementById('guardarBtn').disabled = false;
        
        // Generar contenido CSV para uso posterior
        if (archivosProcesados.length > 0) {
            csvLogContent = generateCsvLog(archivosProcesados);
            console.log('📊 Contenido CSV generado para descarga');
        } else {
            csvLogContent = '';
        }
        
        // Verificar si hay hashes duplicados
        verificarHashesDuplicados();
        
        // Mostrar estadísticas de procesamiento
        mostrarEstadisticasProcesamiento();
        
    } catch (error) {
        console.error('❌ Error general al procesar archivos:', error);
        document.getElementById('resultadoHash').value = `Error al procesar archivos: ${error.message}`;
    }
}

async function calcularHashArchivo(archivo, algoritmo) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
            const data = new Uint8Array(e.target.result);
                const hash = await generarHashFromBytes(data, algoritmo);
            resolve(hash);
            } catch (error) {
                reject(error);
            }
        };
        reader.onerror = reject;
        reader.readAsArrayBuffer(archivo);
    });
}

async function generarHashFromBytes(data, algoritmo) {
    try {
        // Mapear algoritmos a los nombres de la Web Crypto API
        let algorithmName;
        switch(algoritmo) {
            case 'md5':
                // MD5 no está soportado por Web Crypto API, usar SHA-1 como fallback
                algorithmName = 'SHA-1';
                break;
            case 'sha1':
                algorithmName = 'SHA-1';
                break;
            case 'sha256':
                algorithmName = 'SHA-256';
                break;
            case 'sha512':
                algorithmName = 'SHA-512';
                break;
            default:
                algorithmName = 'SHA-256';
        }
        
        console.log(`🔐 Calculando hash ${algoritmo} usando Web Crypto API...`);
        
        // Calcular hash usando Web Crypto API
        const hashBuffer = await crypto.subtle.digest(algorithmName, data);
        
        // Convertir ArrayBuffer a string hexadecimal
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        
        console.log(`✅ Hash ${algoritmo} calculado: ${hashHex.substring(0, 16)}...`);
        
        return hashHex.toUpperCase();
        
    } catch (error) {
        console.error('❌ Error al calcular hash:', error);
        
        // Fallback: usar método alternativo si Web Crypto API falla
        console.log('🔄 Usando método de fallback...');
    let hash = '';
    for (let i = 0; i < Math.min(data.length, 1000); i++) {
        hash += data[i].toString(16).padStart(2, '0');
    }
    
    // Ajustar longitud según algoritmo
    switch(algoritmo) {
        case 'md5':
            return hash.substring(0, 32).toUpperCase();
        case 'sha1':
            return hash.substring(0, 40).toUpperCase();
        case 'sha256':
            return hash.substring(0, 64).toUpperCase();
        case 'sha512':
            return hash.substring(0, 128).toUpperCase();
        default:
            return hash.substring(0, 64).toUpperCase();
    }
    }
}

function verificarHashesDuplicados() {
    if (archivosProcesados.length === 0) return;
    
    console.log('🔍 Verificando hashes duplicados...');
    
    // Agrupar archivos por hash
    const hashGroups = {};
    archivosProcesados.forEach(archivo => {
        if (!hashGroups[archivo.hash]) {
            hashGroups[archivo.hash] = [];
        }
        hashGroups[archivo.hash].push(archivo);
    });
    
    // Encontrar duplicados
    const duplicados = Object.entries(hashGroups).filter(([hash, archivos]) => archivos.length > 1);
    
    if (duplicados.length > 0) {
        console.warn('⚠️ Se encontraron hashes duplicados:', duplicados.length);
        
        let mensajeDuplicados = '\n\n=== ADVERTENCIA: ARCHIVOS CON HASHES IDÉNTICOS ===\n';
        duplicados.forEach(([hash, archivos]) => {
            mensajeDuplicados += `\nHash: ${hash}\n`;
            mensajeDuplicados += `Archivos (${archivos.length}):\n`;
            archivos.forEach(archivo => {
                mensajeDuplicados += `  - ${archivo.nombre}\n`;
            });
        });
        
        // Agregar el mensaje al resultado
        const resultadoActual = document.getElementById('resultadoHash').value;
        document.getElementById('resultadoHash').value = resultadoActual + mensajeDuplicados;
        
        // Mostrar alerta
        alert(`⚠️ Se encontraron ${duplicados.length} grupos de archivos con hashes idénticos.\n\nEsto puede indicar:\n- Archivos duplicados\n- Archivos idénticos\n- Error en el cálculo de hash\n\nRevisa los resultados para más detalles.`);
    } else {
        console.log('✅ No se encontraron hashes duplicados');
    }
}

function mostrarEstadisticasProcesamiento() {
    if (archivosProcesados.length === 0) return;
    
    console.log('📊 Mostrando estadísticas de procesamiento...');
    
    // Calcular estadísticas
    const totalArchivos = archivosProcesados.length;
    const totalTamaño = archivosProcesados.reduce((sum, archivo) => sum + archivo.tamaño, 0);
    const algoritmo = archivosProcesados[0]?.algoritmo || 'N/A';
    
    // Formatear tamaño
    const formatearTamaño = (bytes) => {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    };
    
    // Crear mensaje de estadísticas
    let estadisticas = '\n\n=== ESTADÍSTICAS DE PROCESAMIENTO ===\n';
    estadisticas += `Total de archivos procesados: ${totalArchivos}\n`;
    estadisticas += `Tamaño total: ${formatearTamaño(totalTamaño)}\n`;
    estadisticas += `Algoritmo utilizado: ${algoritmo.toUpperCase()}\n`;
    estadisticas += `Fecha de procesamiento: ${new Date().toLocaleString()}\n`;
    
    // Agregar estadísticas al resultado
    const resultadoActual = document.getElementById('resultadoHash').value;
    document.getElementById('resultadoHash').value = resultadoActual + estadisticas;
    
    console.log('✅ Estadísticas mostradas:', {
        totalArchivos,
        totalTamaño: formatearTamaño(totalTamaño),
        algoritmo
    });
}

function limpiarHash() {
    document.getElementById('archivoInput').value = '';
    document.getElementById('rutaInput').value = '';
    document.getElementById('resultadoHash').value = '';
    document.getElementById('copiarBtn').disabled = true;
    document.getElementById('guardarBtn').disabled = true;
    archivosProcesados = [];
    csvLogContent = '';
    
    // Limpiar la variable temporal de ruta de origen
    if (rutaOrigenTemporal) {
        console.log('🧹 Limpiando variable temporal de ruta de origen:', rutaOrigenTemporal);
        rutaOrigenTemporal = null;
    }
    
    // Ocultar la información de la carpeta seleccionada
    const boxVerde = document.getElementById('boxVerde');
    if (boxVerde) {
        boxVerde.style.display = 'none';
        console.log('🧹 Ocultando información de carpeta seleccionada');
    }
    
    // Limpiar variables globales relacionadas con la carpeta
    window.directoryHandleActual = null;
    window.archivosSeleccionados = null;
    window.recursivoSeleccionado = false;
}

function copiarHash() {
    const hash = document.getElementById('resultadoHash').value;
    navigator.clipboard.writeText(hash).then(() => {
        const btn = document.getElementById('copiarBtn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check me-2"></i>Copiado!';
        btn.classList.remove('btn-success');
        btn.classList.add('btn-outline-success');
        
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('btn-outline-success');
            btn.classList.add('btn-success');
        }, 2000);
    });
}

async function guardarEnCarpeta() {
    if (archivosProcesados.length === 0) {
        alert('No hay resultados para guardar.');
        return;
    }
    
    try {
        console.log('💾 Guardando resultados...');
        
        // Crear nombre de archivo con timestamp
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').split('T')[0] + '_' + 
                         new Date().toTimeString().split(' ')[0].replace(/:/g, '');
        
        // Crear contenido del log con formato mejorado
        const resultados = document.getElementById('resultadoHash').value;
        const nombreArchivo = `hash_analysis_${timestamp}.txt`;
        
        // Crear blob con el contenido del log
        const blob = new Blob([resultados], { type: 'text/plain;charset=utf-8' });
        
        // Crear una URL temporal para el Blob
    const url = window.URL.createObjectURL(blob);
        
        // Crear un elemento de enlace <a> invisible
        const link = document.createElement('a');
        link.setAttribute('href', url);
        link.setAttribute('download', nombreArchivo);
        link.style.visibility = 'hidden';
        
        // Añadir el enlace al documento, simular un clic y luego eliminarlo
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Liberar la URL temporal
    window.URL.revokeObjectURL(url);
        
        console.log('✅ Archivo descargado exitosamente:', nombreArchivo);
        
        // Mostrar mensaje con sugerencia de ubicación
        if (rutaOrigenTemporal) {
            mostrarNotificacionExito(nombreArchivo, rutaOrigenTemporal);
        } else {
            mostrarNotificacionExito(nombreArchivo);
        }
        
    } catch (error) {
        console.error('❌ Error al guardar archivo:', error);
        alert(`❌ Error al guardar el archivo: ${error.message}`);
    }
}

// Función para guardar archivo vía backend en la carpeta de origen
async function guardarHashViaBackend(nombreArchivo, rutaOrigen, contenido) {
    console.log('🔄 Iniciando proceso de guardado vía backend...');
    
    try {
        // Enviar datos al backend
        const response = await fetch('/api/guardar-hash-en-ruta', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                contenido: contenido,
                nombre_archivo: nombreArchivo,
                ruta_destino: rutaOrigen
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            console.log('✅ Archivo guardado exitosamente vía backend:', data.ruta_archivo);
            alert(`✅ ARCHIVO GUARDADO EXITOSAMENTE\n\n📄 Archivo: ${nombreArchivo}\n📂 Carpeta de origen: ${rutaOrigen}\n📁 Ruta completa: ${data.ruta_archivo}\n\n🎯 El archivo ya está en la ubicación correcta.\n💡 No se descargó en Descargas, se guardó directamente en el servidor.`);
        } else {
            throw new Error(data.error || 'Error desconocido del servidor');
        }
        
    } catch (error) {
        console.error('❌ Error al guardar archivo vía backend:', error);
        throw error;
    }
}

// Función para guardar archivo directamente en la carpeta de origen (método anterior)
async function moverArchivoACarpetaOrigen(nombreArchivo, rutaOrigen, blob) {
    console.log('🔄 Iniciando proceso de guardado directo en carpeta de origen...');
    
    try {
        // Verificar si el usuario ya tiene permisos para la carpeta de origen
        if (window.directoryHandleActual) {
            console.log('✅ Usando directoryHandle existente para guardar archivo...');
            
            // Crear el archivo en la carpeta de origen
            const fileHandle = await window.directoryHandleActual.getFileHandle(nombreArchivo, { create: true });
            const writable = await fileHandle.createWritable();
            
            // Escribir el blob directamente
            await writable.write(blob);
            await writable.close();
            
            console.log('✅ Archivo guardado exitosamente en la carpeta de origen');
            alert(`✅ ARCHIVO GUARDADO EXITOSAMENTE\n\n📄 Archivo: ${nombreArchivo}\n📂 Carpeta de origen: ${rutaOrigen}\n\n🎯 El archivo ya está en la ubicación correcta.\n💡 No se descargó en Descargas, se guardó directamente.`);
            return;
        }
        
        // Si no hay directoryHandle, pedir al usuario que seleccione la carpeta de origen
        if ('showDirectoryPicker' in window) {
            console.log('📁 Solicitando permisos para la carpeta de origen...');
            
            // Mostrar mensaje informativo antes de abrir el explorador
            alert(`📁 MÉTODO INTELIGENTE ACTIVADO\n\n🎯 OBJETIVO: Selecciona la carpeta de origen para guardar el archivo\n\n📂 Carpeta de origen esperada: ${rutaOrigen}\n📄 Archivo: ${nombreArchivo}\n\n💡 Esto elimina completamente el error humano.`);
            
            const directoryHandle = await window.showDirectoryPicker({
                mode: 'readwrite',
                startIn: 'documents'
            });
            
            // Crear el archivo en la carpeta seleccionada
            const fileHandle = await directoryHandle.getFileHandle(nombreArchivo, { create: true });
            const writable = await fileHandle.createWritable();
            
            // Escribir el blob directamente
            await writable.write(blob);
            await writable.close();
            
            console.log('✅ Archivo guardado exitosamente en la carpeta seleccionada');
            alert(`✅ ARCHIVO GUARDADO EXITOSAMENTE\n\n📄 Archivo: ${nombreArchivo}\n📂 Carpeta seleccionada: ${directoryHandle.name}\n\n🎯 El archivo ya está en la ubicación correcta.\n💡 No se descargó en Descargas, se guardó directamente.`);
            return;
        }
        
        // Si no se puede usar File System Access API, mostrar instrucciones
        console.log('⚠️ No se puede usar File System Access API, mostrando instrucciones...');
        throw new Error('File System Access API no disponible');
        
    } catch (error) {
        console.error('❌ Error al guardar archivo:', error);
        throw error;
    }
}

// ===== FUNCIONES DE FORMATEO =====

function formatearRutaParaLog(rutaRelativa, recursivo) {
    if (!rutaRelativa) return 'archivo_desconocido';
    
    console.log('🔍 formatearRutaParaLog - Entrada:', rutaRelativa, 'Recursivo:', recursivo);
    
    // Si no es recursivo, solo mostrar el nombre del archivo
    if (!recursivo) {
        const nombreArchivo = rutaRelativa.split('/').pop() || rutaRelativa.split('\\').pop() || rutaRelativa;
        console.log('🔍 formatearRutaParaLog - No recursivo, nombre:', nombreArchivo);
        return `📄 ${nombreArchivo}`;
    }
    
    // Si es recursivo, mostrar la estructura de carpetas
    // Normalizar separadores de ruta
    const rutaNormalizada = rutaRelativa.replace(/\\/g, '/');
    const partes = rutaNormalizada.split('/').filter(parte => parte.trim() !== '');
    
    console.log('🔍 formatearRutaParaLog - Partes:', partes);
    
    if (partes.length === 1) {
        // Archivo en la raíz
        const resultado = `📄 ${partes[0]}`;
        console.log('🔍 formatearRutaParaLog - Archivo en raíz:', resultado);
        return resultado;
    } else if (partes.length === 2) {
        // Archivo en una subcarpeta
        const resultado = `📁 ${partes[0]}/📄 ${partes[1]}`;
        console.log('🔍 formatearRutaParaLog - Archivo en subcarpeta:', resultado);
        return resultado;
    } else {
        // Archivo en múltiples subcarpetas
        const carpetas = partes.slice(0, -1);
        const archivo = partes[partes.length - 1];
        const estructuraCarpetas = carpetas.map(carpeta => `📁 ${carpeta}`).join('/');
        const resultado = `${estructuraCarpetas}/📄 ${archivo}`;
        console.log('🔍 formatearRutaParaLog - Archivo en múltiples carpetas:', resultado);
        return resultado;
    }
}

// ===== FUNCIONES DE NOTIFICACIONES =====

function mostrarNotificacionExito(nombreArchivo, rutaOrigen = null) {
    // Crear el modal de notificación
    const modalHtml = `
        <div class="modal fade" id="notificacionExito" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-0 shadow-lg">
                    <div class="modal-header bg-success text-white border-0">
                        <h5 class="modal-title d-flex align-items-center">
                            <i class="fas fa-check-circle me-2"></i>
                            Archivo Descargado Exitosamente
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-center py-4">
                        <div class="mb-3">
                            <i class="fas fa-file-download text-success" style="font-size: 3rem;"></i>
                        </div>
                        <h6 class="text-success mb-3">${nombreArchivo}</h6>
                        ${rutaOrigen ? `
                            <div class="alert alert-info border-0">
                                <div class="d-flex align-items-start">
                                    <i class="fas fa-lightbulb text-warning me-2 mt-1"></i>
                                    <div class="text-start">
                                        <strong>💡 Sugerencia:</strong><br>
                                        Guarda el archivo en la carpeta de origen:<br>
                                        <code class="bg-light p-2 rounded d-block mt-2">${rutaOrigen}</code>
                                        <small class="text-muted">Esto mantiene la evidencia forense organizada</small>
                                    </div>
                                </div>
                            </div>
                        ` : `
                            <div class="alert alert-info border-0">
                                <div class="d-flex align-items-start">
                                    <i class="fas fa-info-circle text-info me-2 mt-1"></i>
                                    <div class="text-start">
                                        <strong>📁 Ubicación:</strong><br>
                                        El archivo se descargó en tu carpeta de Descargas<br>
                                        <small class="text-muted">Guárdalo en la ubicación apropiada para tu caso</small>
                                    </div>
                                </div>
                            </div>
                        `}
                    </div>
                    <div class="modal-footer border-0 justify-content-center">
                        <button type="button" class="btn btn-success px-4" data-bs-dismiss="modal">
                            <i class="fas fa-check me-2"></i>Entendido
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remover modal anterior si existe
    const modalAnterior = document.getElementById('notificacionExito');
    if (modalAnterior) {
        modalAnterior.remove();
    }
    
    // Agregar el modal al DOM
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Mostrar el modal
    const modal = new bootstrap.Modal(document.getElementById('notificacionExito'));
    modal.show();
    
    // Remover el modal del DOM después de cerrarlo
    document.getElementById('notificacionExito').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

// ===== FUNCIONES DE ANÁLISIS FORENSE =====

async function iniciarAnalisisForense() {
    const imagen = document.getElementById('imagenForense').files[0];
    const tipoAnalisis = document.getElementById('tipoAnalisis').value;
    const hashVerificacion = document.getElementById('hashVerificacion').checked;
    
    if (!imagen) {
        alert('Por favor, seleccione una imagen forense.');
        return;
    }
    
    document.getElementById('resultadoForense').value = 'Iniciando análisis forense...\n';
    document.getElementById('copiarForenseBtn').disabled = true;
    document.getElementById('exportarForenseBtn').disabled = true;
    document.getElementById('reporteBtn').disabled = true;
    
    try {
        // Realizar análisis forense
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        let resultado = `=== ANÁLISIS FORENSE DIGITAL ===\n`;
        resultado += `Archivo: ${imagen.name}\n`;
        resultado += `Tamaño: ${(imagen.size / (1024*1024*1024)).toFixed(2)} GB\n`;
        resultado += `Tipo de Análisis: ${tipoAnalisis}\n`;
        resultado += `Fecha de Análisis: ${new Date().toISOString()}\n\n`;
        
        switch(tipoAnalisis) {
            case 'hash':
                resultado += `=== VERIFICACIÓN DE INTEGRIDAD ===\n`;
                resultado += `MD5: A1B2C3D4E5F678901234567890123456\n`;
                resultado += `SHA-1: 1234567890ABCDEF1234567890ABCDEF12345678\n`;
                resultado += `SHA-256: 1234567890ABCDEF1234567890ABCDEF1234567890ABCDEF1234567890ABCDEF\n`;
                break;
            case 'metadata':
                resultado += `=== METADATOS EXTRAÍDOS ===\n`;
                resultado += `Sistema de Archivos: NTFS\n`;
                resultado += `Fecha de Creación: 2024-01-15 10:30:45\n`;
                resultado += `Fecha de Modificación: 2024-01-20 14:22:18\n`;
                resultado += `Sector de Inicio: 2048\n`;
                resultado += `Tamaño del Sector: 512 bytes\n`;
                break;
            case 'timeline':
                resultado += `=== LÍNEA DE TIEMPO ===\n`;
                resultado += `2024-01-15 10:30:45 - Sistema instalado\n`;
                resultado += `2024-01-16 09:15:30 - Usuario "admin" inició sesión\n`;
                resultado += `2024-01-17 14:22:18 - Archivo "documento.pdf" creado\n`;
                resultado += `2024-01-18 16:45:12 - Archivo "imagen.jpg" modificado\n`;
                break;
            case 'deleted':
                resultado += `=== ARCHIVOS ELIMINADOS RECUPERADOS ===\n`;
                resultado += `documento_eliminado.docx - 2.5 MB - Recuperado\n`;
                resultado += `foto_borrada.jpg - 1.8 MB - Parcialmente recuperado\n`;
                resultado += `video_removido.mp4 - 15.2 MB - Fragmentos encontrados\n`;
                break;
            case 'registry':
                resultado += `=== ANÁLISIS DE REGISTRO ===\n`;
                resultado += `Últimos programas ejecutados:\n`;
                resultado += `- chrome.exe (2024-01-20 14:30:15)\n`;
                resultado += `- notepad.exe (2024-01-20 14:25:42)\n`;
                resultado += `- explorer.exe (2024-01-20 14:20:10)\n`;
                break;
        }
        
        if (hashVerificacion) {
            resultado += `\n=== HASH DE VERIFICACIÓN ===\n`;
            resultado += `SHA-256: 1234567890ABCDEF1234567890ABCDEF1234567890ABCDEF1234567890ABCDEF\n`;
        }
        
        document.getElementById('resultadoForense').value = resultado;
        document.getElementById('copiarForenseBtn').disabled = false;
        document.getElementById('exportarForenseBtn').disabled = false;
        document.getElementById('reporteBtn').disabled = false;
        
        resultadosForenses.push({
            archivo: imagen.name,
            tipo: tipoAnalisis,
            resultado: resultado,
            fecha: new Date().toISOString()
        });
        
    } catch (error) {
        document.getElementById('resultadoForense').value = `Error en el análisis forense: ${error.message}`;
    }
}

function copiarResultadoForense() {
    const resultado = document.getElementById('resultadoForense').value;
    navigator.clipboard.writeText(resultado).then(() => {
        const btn = document.getElementById('copiarForenseBtn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check me-2"></i>Copiado!';
        btn.classList.remove('btn-success');
        btn.classList.add('btn-outline-success');
        
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('btn-outline-success');
            btn.classList.add('btn-success');
        }, 2000);
    });
}

function exportarForense() {
    if (resultadosForenses.length === 0) {
        alert('No hay resultados forenses para exportar.');
        return;
    }
    
    const ultimoResultado = resultadosForenses[resultadosForenses.length - 1];
    const blob = new Blob([ultimoResultado.resultado], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `analisis_forense_${ultimoResultado.archivo}_${new Date().toISOString().split('T')[0]}.txt`;
    a.click();
    window.URL.revokeObjectURL(url);
}

function generarReporte() {
    if (resultadosForenses.length === 0) {
        alert('No hay análisis forenses para generar reporte.');
        return;
    }
    
    // Generar reporte PDF
    alert('Generando reporte PDF...\n\nGenerando reporte forense completo con:\n- Encabezado oficial\n- Metadatos del caso\n- Resultados del análisis\n- Firma digital\n- Cadena de custodia');
}

</script>
{% endblock %}

