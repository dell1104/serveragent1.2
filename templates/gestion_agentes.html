{% extends "base_sidebar.html" %}

{% block title %}Gestión de Agentes Forenses{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-users-cog me-2"></i>Gestión de Agentes Forenses
                    </h4>
                </div>
                <div class="card-body">
                    <!-- Información del Usuario Actual -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card border-info">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0"><i class="fas fa-user me-2"></i>Mi Agente</h6>
                                </div>
                                <div class="card-body">
                                    <div id="infoAgenteUsuario">
                                        <div class="text-center">
                                            <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                                            <p class="mt-2 text-muted">Cargando información del agente...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-success">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0"><i class="fas fa-download me-2"></i>Instalar Agente</h6>
                                </div>
                                <div class="card-body">
                                    <div id="instalacionAgente">
                                        <div class="text-center">
                                            <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                                            <p class="mt-2 text-muted">Detectando sistema operativo...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de Agentes del Sistema -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card border-warning">
                                <div class="card-header bg-warning text-dark">
                                    <h6 class="mb-0"><i class="fas fa-server me-2"></i>Agentes del Sistema</h6>
                                </div>
                                <div class="card-body">
                                    <div id="listaAgentesSistema">
                                        <div class="text-center">
                                            <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                                            <p class="mt-2 text-muted">Cargando agentes del sistema...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let usuarioActual = null;
let agentesSistema = [];

// ===== FUNCIONES DE INICIALIZACIÓN =====

document.addEventListener('DOMContentLoaded', function() {
    cargarUsuarioActual();
    cargarAgentesSistema();
    detectarSistemaOperativo();
});

function cargarUsuarioActual() {
    // Obtener información del usuario desde el localStorage
    const usuario = JSON.parse(localStorage.getItem('usuario_actual') || '{}');
    usuarioActual = usuario;
    
    mostrarInfoAgenteUsuario(usuario);
}

function cargarAgentesSistema() {
    // Cargar agentes del sistema desde el servidor
    fetch('/api/forensic/agentes-sistema')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                agentesSistema = data.agentes;
                mostrarAgentesSistema(data.agentes);
            } else {
                mostrarErrorAgentesSistema(data.error);
            }
        })
        .catch(error => {
            console.error('Error cargando agentes del sistema:', error);
            mostrarErrorAgentesSistema('Error de conexión');
        });
}

function detectarSistemaOperativo() {
    const userAgent = navigator.userAgent;
    let sistema = 'unknown';
    let arquitectura = 'unknown';
    
    if (userAgent.indexOf('Windows') !== -1) {
        sistema = 'windows';
        if (userAgent.indexOf('WOW64') !== -1 || userAgent.indexOf('Win64') !== -1) {
            arquitectura = 'x64';
        } else {
            arquitectura = 'x86';
        }
    } else if (userAgent.indexOf('Mac') !== -1) {
        sistema = 'macos';
        if (userAgent.indexOf('Intel') !== -1) {
            arquitectura = 'x64';
        } else {
            arquitectura = 'arm64';
        }
    } else if (userAgent.indexOf('Linux') !== -1) {
        sistema = 'linux';
        arquitectura = 'x64';
    }
    
    mostrarInstalacionAgente(sistema, arquitectura);
}

// ===== FUNCIONES DE MOSTRAR INFORMACIÓN =====

function mostrarInfoAgenteUsuario(usuario) {
    const container = document.getElementById('infoAgenteUsuario');
    
    if (usuario.agente_instalado) {
        container.innerHTML = `
            <div class="text-center">
                <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                <h5 class="text-success">Agente Instalado</h5>
                <p class="mb-2"><strong>Usuario:</strong> ${usuario.nombre || 'N/A'}</p>
                <p class="mb-2"><strong>URL:</strong> ${usuario.agente_url || 'N/A'}</p>
                <p class="mb-2"><strong>Estado:</strong> <span class="badge bg-success">Activo</span></p>
                <p class="mb-2"><strong>Última conexión:</strong> ${usuario.ultima_conexion || 'N/A'}</p>
                <div class="mt-3">
                    <button class="btn btn-sm btn-outline-primary me-2" onclick="probarAgente('${usuario.agente_url}')">
                        <i class="fas fa-play me-1"></i>Probar
                    </button>
                    <button class="btn btn-sm btn-outline-warning me-2" onclick="configurarAgente('${usuario.id}')">
                        <i class="fas fa-cog me-1"></i>Configurar
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="desinstalarAgente('${usuario.id}')">
                        <i class="fas fa-trash me-1"></i>Desinstalar
                    </button>
                </div>
            </div>
        `;
    } else {
        container.innerHTML = `
            <div class="text-center">
                <i class="fas fa-times-circle fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">Sin Agente</h5>
                <p class="text-muted">No tienes un agente instalado en tu sistema</p>
                <button class="btn btn-primary" onclick="mostrarInstalacionAgente()">
                    <i class="fas fa-download me-2"></i>Instalar Agente
                </button>
            </div>
        `;
    }
}

function mostrarInstalacionAgente(sistema = null, arquitectura = null) {
    const container = document.getElementById('instalacionAgente');
    
    if (!sistema) {
        // Detectar automáticamente
        const userAgent = navigator.userAgent;
        if (userAgent.indexOf('Windows') !== -1) {
            sistema = 'windows';
            arquitectura = userAgent.indexOf('WOW64') !== -1 || userAgent.indexOf('Win64') !== -1 ? 'x64' : 'x86';
        } else if (userAgent.indexOf('Mac') !== -1) {
            sistema = 'macos';
            arquitectura = userAgent.indexOf('Intel') !== -1 ? 'x64' : 'arm64';
        } else if (userAgent.indexOf('Linux') !== -1) {
            sistema = 'linux';
            arquitectura = 'x64';
        } else {
            sistema = 'unknown';
            arquitectura = 'unknown';
        }
    }
    
    if (sistema === 'unknown') {
        container.innerHTML = `
            <div class="text-center">
                <i class="fas fa-question-circle fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">Sistema No Detectado</h5>
                <p class="text-muted">No se pudo detectar tu sistema operativo</p>
                <div class="mt-3">
                    <button class="btn btn-outline-primary me-2" onclick="descargarInstalador('windows')">
                        <i class="fab fa-windows me-1"></i>Windows
                    </button>
                    <button class="btn btn-outline-primary me-2" onclick="descargarInstalador('macos')">
                        <i class="fab fa-apple me-1"></i>macOS
                    </button>
                    <button class="btn btn-outline-primary" onclick="descargarInstalador('linux')">
                        <i class="fab fa-linux me-1"></i>Linux
                    </button>
                </div>
            </div>
        `;
    } else {
        const iconos = {
            'windows': 'fab fa-windows',
            'macos': 'fab fa-apple',
            'linux': 'fab fa-linux'
        };
        
        const nombres = {
            'windows': 'Windows',
            'macos': 'macOS',
            'linux': 'Linux'
        };
        
        container.innerHTML = `
            <div class="text-center">
                <i class="${iconos[sistema]} fa-3x text-primary mb-3"></i>
                <h5 class="text-primary">${nombres[sistema]} ${arquitectura}</h5>
                <p class="text-muted">Sistema detectado automáticamente</p>
                <div class="mt-3">
                    <button class="btn btn-primary me-2" onclick="descargarInstalador('${sistema}')">
                        <i class="fas fa-download me-1"></i>Descargar Instalador
                    </button>
                    <button class="btn btn-outline-secondary" onclick="mostrarInstrucciones('${sistema}')">
                        <i class="fas fa-info-circle me-1"></i>Instrucciones
                    </button>
                </div>
            </div>
        `;
    }
}

function mostrarAgentesSistema(agentes) {
    const container = document.getElementById('listaAgentesSistema');
    
    if (agentes.length === 0) {
        container.innerHTML = `
            <div class="text-center">
                <i class="fas fa-server fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">Sin Agentes del Sistema</h5>
                <p class="text-muted">No hay agentes del sistema disponibles</p>
            </div>
        `;
        return;
    }
    
    let html = '<div class="row">';
    
    agentes.forEach(agente => {
        const estadoClass = agente.estado === 'activo' ? 'success' : 'danger';
        const estadoIcon = agente.estado === 'activo' ? 'check-circle' : 'times-circle';
        
        html += `
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card border-${estadoClass}">
                    <div class="card-header bg-${estadoClass} text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-${estadoIcon} me-2"></i>${agente.nombre}
                        </h6>
                    </div>
                    <div class="card-body">
                        <p class="mb-2"><strong>URL:</strong> ${agente.url}</p>
                        <p class="mb-2"><strong>Estado:</strong> <span class="badge bg-${estadoClass}">${agente.estado}</span></p>
                        <p class="mb-2"><strong>Formatos:</strong> ${agente.formatos.join(', ')}</p>
                        <p class="mb-2"><strong>Última conexión:</strong> ${agente.ultima_conexion || 'N/A'}</p>
                        <div class="mt-3">
                            <button class="btn btn-sm btn-outline-primary me-2" onclick="probarAgente('${agente.url}')">
                                <i class="fas fa-play me-1"></i>Probar
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="verDetallesAgente('${agente.id}')">
                                <i class="fas fa-info-circle me-1"></i>Detalles
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

function mostrarErrorAgentesSistema(error) {
    const container = document.getElementById('listaAgentesSistema');
    container.innerHTML = `
        <div class="text-center">
            <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
            <h5 class="text-warning">Error Cargando Agentes</h5>
            <p class="text-muted">${error}</p>
            <button class="btn btn-outline-primary" onclick="cargarAgentesSistema()">
                <i class="fas fa-refresh me-1"></i>Reintentar
            </button>
        </div>
    `;
}

// ===== FUNCIONES DE ACCIÓN =====

function descargarInstalador(sistema) {
    // Generar instalador personalizado para el usuario
    const usuario = usuarioActual || {};
    const instaladorData = {
        usuario_id: usuario.id || 'temp',
        usuario_nombre: usuario.nombre || 'Usuario',
        sistema: sistema,
        api_key: 'forensic_agent_2024',
        servidor_url: window.location.origin
    };
    
    // Crear y descargar archivo ZIP
    crearInstaladorPersonalizado(instaladorData);
}

function crearInstaladorPersonalizado(data) {
    // Crear archivos del instalador
    const archivos = {
        'install.bat': crearInstaladorWindows(data),
        'install.sh': crearInstaladorLinux(data),
        'install.ps1': crearInstaladorPowerShell(data),
        'config.json': JSON.stringify(data, null, 2),
        'README.md': crearReadmeInstalador(data)
    };
    
    // Crear y descargar ZIP
    crearZipYDescargar(archivos, `agente_forense_${data.sistema}_${data.usuario_id}.zip`);
}

function crearInstaladorWindows(data) {
    return `@echo off
echo ========================================
echo   Instalador Agente Forense Windows
echo   Usuario: ${data.usuario_nombre}
echo ========================================
echo.

REM Verificar permisos de administrador
net session >nul 2>&1
if errorlevel 1 (
    echo ⚠️  ADVERTENCIA: No se está ejecutando como administrador
    echo El agente necesita permisos de administrador para acceder a discos físicos
    echo.
    echo ¿Desea continuar de todos modos? (S/N)
    set /p continuar=
    if /i not "%continuar%"=="S" (
        echo Instalación cancelada
        pause
        exit /b 1
    )
)

REM Verificar Python
python --version >nul 2>&1
if errorlevel 1 (
    echo ERROR: Python no está instalado
    echo Por favor, instala Python 3.8+ desde https://python.org
    pause
    exit /b 1
)

REM Crear directorio de evidencias
if not exist "C:\\evidencias_forenses" (
    mkdir "C:\\evidencias_forenses"
)

REM Instalar dependencias
pip install flask flask-cors requests pywin32

REM Crear archivo de configuración
echo {
echo   "usuario_id": "${data.usuario_id}",
echo   "usuario_nombre": "${data.usuario_nombre}",
echo   "api_key": "${data.api_key}",
echo   "servidor_url": "${data.servidor_url}",
echo   "puerto": 5001
echo } > config.json

REM Crear script de inicio
echo @echo off > start_agent.bat
echo echo Iniciando Agente Forense... >> start_agent.bat
echo python agent.py >> start_agent.bat
echo pause >> start_agent.bat

echo.
echo ✅ Agente instalado correctamente
echo.
echo Para ejecutar el agente:
echo   python agent.py
echo   O ejecutar: start_agent.bat
echo.
pause
`;
}

function crearInstaladorLinux(data) {
    return `#!/bin/bash
echo "========================================"
echo "  Instalador Agente Forense Linux"
echo "  Usuario: ${data.usuario_nombre}"
echo "========================================"
echo

# Verificar Python
if ! command -v python3 &> /dev/null; then
    echo "ERROR: Python3 no está instalado"
    echo "Por favor, instala Python 3.8+ desde tu gestor de paquetes"
    exit 1
fi

# Crear directorio de evidencias
mkdir -p /home/$USER/evidencias_forenses

# Instalar dependencias
pip3 install flask flask-cors requests

# Crear archivo de configuración
cat > config.json << EOF
{
  "usuario_id": "${data.usuario_id}",
  "usuario_nombre": "${data.usuario_nombre}",
  "api_key": "${data.api_key}",
  "servidor_url": "${data.servidor_url}",
  "puerto": 5001
}
EOF

# Crear script de inicio
cat > start_agent.sh << 'EOF'
#!/bin/bash
echo "Iniciando Agente Forense..."
python3 agent.py
EOF

chmod +x start_agent.sh

echo
echo "✅ Agente instalado correctamente"
echo
echo "Para ejecutar el agente:"
echo "  python3 agent.py"
echo "  O ejecutar: ./start_agent.sh"
echo
`;
}

function crearInstaladorPowerShell(data) {
    return `# Instalador Agente Forense PowerShell
# Usuario: ${data.usuario_nombre}

Write-Host "========================================" -ForegroundColor Green
Write-Host "  Instalador Agente Forense PowerShell" -ForegroundColor Green
Write-Host "  Usuario: ${data.usuario_nombre}" -ForegroundColor Green
Write-Host "========================================" -ForegroundColor Green
Write-Host ""

# Verificar Python
try {
    $pythonVersion = python --version 2>&1
    Write-Host "✅ Python detectado: $pythonVersion" -ForegroundColor Green
} catch {
    Write-Host "❌ ERROR: Python no está instalado" -ForegroundColor Red
    Write-Host "Por favor, instala Python 3.8+ desde https://python.org" -ForegroundColor Red
    exit 1
}

# Crear directorio de evidencias
$evidenciaDir = "C:\\evidencias_forenses"
if (-not (Test-Path $evidenciaDir)) {
    New-Item -Path $evidenciaDir -ItemType Directory -Force | Out-Null
    Write-Host "✅ Directorio $evidenciaDir creado" -ForegroundColor Green
}

# Instalar dependencias
Write-Host "📦 Instalando dependencias..." -ForegroundColor Cyan
pip install flask flask-cors requests pywin32

# Crear archivo de configuración
$config = @{
    usuario_id = "${data.usuario_id}"
    usuario_nombre = "${data.usuario_nombre}"
    api_key = "${data.api_key}"
    servidor_url = "${data.servidor_url}"
    puerto = 5001
} | ConvertTo-Json

$config | Out-File -FilePath "config.json" -Encoding UTF8

# Crear script de inicio
@"
@echo off
echo Iniciando Agente Forense...
python agent.py
pause
"@ | Out-File -FilePath "start_agent.bat" -Encoding ASCII

Write-Host ""
Write-Host "✅ Agente instalado correctamente" -ForegroundColor Green
Write-Host ""
Write-Host "Para ejecutar el agente:" -ForegroundColor White
Write-Host "  python agent.py" -ForegroundColor Gray
Write-Host "  O ejecutar: .\\start_agent.bat" -ForegroundColor Gray
Write-Host ""
`;
}

function crearReadmeInstalador(data) {
    return `# Agente Forense - ${data.usuario_nombre}

## Instalación

### Windows
1. Ejecutar \`install.bat\` como administrador
2. O ejecutar \`install.ps1\` en PowerShell

### Linux/macOS
1. Ejecutar \`chmod +x install.sh\`
2. Ejecutar \`./install.sh\`

## Configuración

- **Usuario ID:** ${data.usuario_id}
- **Usuario:** ${data.usuario_nombre}
- **API Key:** ${data.api_key}
- **Servidor:** ${data.servidor_url}
- **Puerto:** 5001

## Uso

1. Ejecutar el agente: \`python agent.py\`
2. El agente estará disponible en: http://localhost:5001
3. La página web se conectará automáticamente

## Soporte

Para soporte técnico, contactar al administrador del sistema.
`;
}

function crearZipYDescargar(archivos, nombreArchivo) {
    // Crear ZIP usando JSZip (necesitarías incluir la librería)
    // Por simplicidad, crearemos un archivo JSON con los contenidos
    const contenido = JSON.stringify(archivos, null, 2);
    const blob = new Blob([contenido], { type: 'application/json' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = nombreArchivo;
    a.click();
    window.URL.revokeObjectURL(url);
}

function probarAgente(url) {
    fetch(`${url}/status`, {
        headers: {
            'Authorization': 'Bearer forensic_agent_2024'
        }
    })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success' || data.status === 'ok') {
                alert('✅ Agente funcionando correctamente');
            } else {
                alert('❌ Error en el agente: ' + (data.error || 'Error desconocido'));
            }
        })
        .catch(error => {
            alert('❌ Error de conexión: ' + error.message);
        });
}

function configurarAgente(usuarioId) {
    // Implementar configuración del agente
    alert('Función de configuración en desarrollo');
}

function desinstalarAgente(usuarioId) {
    if (confirm('¿Estás seguro de que quieres desinstalar el agente?')) {
        // Implementar desinstalación
        alert('Función de desinstalación en desarrollo');
    }
}

function verDetallesAgente(agenteId) {
    // Implementar detalles del agente
    alert('Función de detalles en desarrollo');
}

function mostrarInstrucciones(sistema) {
    const instrucciones = {
        'windows': '1. Ejecutar install.bat como administrador\n2. O ejecutar install.ps1 en PowerShell\n3. El agente se instalará automáticamente',
        'macos': '1. Ejecutar chmod +x install.sh\n2. Ejecutar ./install.sh\n3. El agente se instalará automáticamente',
        'linux': '1. Ejecutar chmod +x install.sh\n2. Ejecutar ./install.sh\n3. El agente se instalará automáticamente'
    };
    
    alert(instrucciones[sistema] || 'Instrucciones no disponibles');
}
</script>
{% endblock %}

