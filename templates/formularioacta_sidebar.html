{% extends "base_sidebar.html" %}

{% block title %}Formulario de Acta de Aporte - Sistema Forense{% endblock %}

{% block page_title %}{% endblock %}

{% block content %}
<div class="fade-in">


    <!-- FORMULARIO PRINCIPAL -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-file-alt me-2"></i>Formulario de Acta de Aporte
                    </h4>
                    <p class="text-muted mb-0 small">Complete los datos para generar el acta de aporte</p>
                </div>
                <div class="card-body">
                    <form id="main-form" action="{{ url_for('serve_html_page', filename='acta.html') }}" method="GET">
                        <!-- Datos del Caso -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-primary mb-3">
                                    <i class="fas fa-folder me-2"></i>Datos del Caso
                                </h5>
                            </div>
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label for="caso-select" class="form-label">Seleccionar Caso:</label>
                                    <select id="caso-select" name="caso_id" class="form-select" required>
                                        <option value="">Seleccionar caso...</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label for="perito" class="form-label">Perito:</label>
                                    <input type="text" id="perito" name="perito" class="form-control" readonly>
                                </div>
                            </div>
                        </div>

                        <!-- Fecha y Hora -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-primary mb-3">
                                    <i class="fas fa-calendar me-2"></i>Fecha y Hora
                                </h5>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="fecha" class="form-label">Fecha:</label>
                                    <input type="date" id="fecha" name="fecha" class="form-control" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="hora" class="form-label">Hora:</label>
                                    <input type="time" id="hora" name="hora" class="form-control" required>
                                </div>
                            </div>
                        </div>

                        <!-- Datos Personales -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-primary mb-3">
                                    <i class="fas fa-user me-2"></i>Datos Personales
                                </h5>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="primer_nombre" class="form-label">Primer Nombre:</label>
                                    <input type="text" id="primer_nombre" name="primer_nombre" class="form-control" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="segundo_nombre" class="form-label">Segundo Nombre:</label>
                                    <input type="text" id="segundo_nombre" name="segundo_nombre" class="form-control">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="apellido_paterno" class="form-label">Apellido Paterno:</label>
                                    <input type="text" id="apellido_paterno" name="apellido_paterno" class="form-control" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="apellido_materno" class="form-label">Apellido Materno:</label>
                                    <input type="text" id="apellido_materno" name="apellido_materno" class="form-control">
                                </div>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="nacionalidad" class="form-label">Nacionalidad:</label>
                                    <input type="text" id="nacionalidad" name="nacionalidad" class="form-control" value="Argentina">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="lugar_nacimiento" class="form-label">Lugar de Nacimiento:</label>
                                    <input type="text" id="lugar_nacimiento" name="lugar_nacimiento" class="form-control">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="fecha_nacimiento" class="form-label">Fecha de Nacimiento:</label>
                                    <input type="date" id="fecha_nacimiento" name="fecha_nacimiento" class="form-control">
                                </div>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="estado_civil" class="form-label">Estado Civil:</label>
                                    <select id="estado_civil" name="estado_civil" class="form-select">
                                        <option value="">Seleccionar...</option>
                                        <option value="Soltero/a">Soltero/a</option>
                                        <option value="Casado/a">Casado/a</option>
                                        <option value="Divorciado/a">Divorciado/a</option>
                                        <option value="Viudo/a">Viudo/a</option>
                                        <option value="Concubinato">Concubinato</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="profesion" class="form-label">Profesión:</label>
                                    <input type="text" id="profesion" name="profesion" class="form-control">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="nivel_alfabetizacion" class="form-label">Nivel de Alfabetización:</label>
                                    <select id="nivel_alfabetizacion" name="nivel_alfabetizacion" class="form-select">
                                        <option value="">Seleccionar...</option>
                                        <option value="Analfabeto">Analfabeto</option>
                                        <option value="Primario Incompleto">Primario Incompleto</option>
                                        <option value="Primario Completo">Primario Completo</option>
                                        <option value="Secundario Incompleto">Secundario Incompleto</option>
                                        <option value="Secundario Completo">Secundario Completo</option>
                                        <option value="Terciario/Universitario Incompleto">Terciario/Universitario Incompleto</option>
                                        <option value="Terciario/Universitario Completo">Terciario/Universitario Completo</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Dirección -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-primary mb-3">
                                    <i class="fas fa-map-marker-alt me-2"></i>Dirección
                                </h5>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="calle" class="form-label">Calle:</label>
                                    <input type="text" id="calle" name="calle" class="form-control">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="numeracion" class="form-label">Numeración:</label>
                                    <input type="text" id="numeracion" name="numeracion" class="form-control">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="barrio" class="form-label">Barrio:</label>
                                    <input type="text" id="barrio" name="barrio" class="form-control">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="ciudad" class="form-label">Ciudad:</label>
                                    <input type="text" id="ciudad" name="ciudad" class="form-control">
                                </div>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="provincia" class="form-label">Provincia:</label>
                                    <select id="provincia" name="provincia" class="form-select">
                                        <option value="">Seleccionar provincia...</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="departamento" class="form-label">Departamento:</label>
                                    <select id="departamento" name="departamento" class="form-select">
                                        <option value="">Seleccionar departamento...</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="localidad" class="form-label">Localidad:</label>
                                    <select id="localidad" name="localidad" class="form-select">
                                        <option value="">Seleccionar localidad...</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-4" id="otra-localidad-container" style="display: none;">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="otra_localidad" class="form-label">Especificar localidad:</label>
                                    <input type="text" id="otra_localidad" name="otra_localidad" class="form-control" placeholder="Ingrese el nombre de la localidad">
                                </div>
                            </div>
                        </div>

                        <!-- Contacto -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-primary mb-3">
                                    <i class="fas fa-phone me-2"></i>Contacto
                                </h5>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="telefono_contacto" class="form-label">Teléfono de Contacto:</label>
                                    <input type="tel" id="telefono_contacto" name="telefono_contacto" class="form-control">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="email_contacto" class="form-label">Email de Contacto:</label>
                                    <input type="email" id="email_contacto" name="email_contacto" class="form-control">
                                </div>
                            </div>
                        </div>

                        <!-- Dispositivo -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-primary mb-3">
                                    <i class="fas fa-mobile-alt me-2"></i>Dispositivo a Analizar
                                </h5>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="dispositivo" class="form-label">Tipo de Dispositivo:</label>
                                    <select id="dispositivo" name="dispositivo" class="form-select" required onchange="mostrarCamposDispositivo()">
                                        <option value="">Seleccionar dispositivo...</option>
                                        <option value="telefono">Teléfono Celular</option>
                                        <option value="usb">Disco Extraíble USB</option>
                                        <option value="optico">Soporte Óptico</option>
                                        <option value="nube">Almacenamiento en la Nube</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Campos específicos del dispositivo -->
                        <div id="dispositivo-campos"></div>

                        <!-- Tarea y Método -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-primary mb-3">
                                    <i class="fas fa-tasks me-2"></i>Tarea y Método
                                </h5>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="tarea" class="form-label">Tarea a Realizar:</label>
                                    <textarea id="tarea" name="tarea" class="form-control" rows="3" required></textarea>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="enviar" class="form-label">Método de Transferencia:</label>
                                    <select id="enviar" name="enviar" class="form-select" required>
                                        <option value="">Seleccionar método...</option>
                                        <option value="cable USB">Cable USB</option>
                                        <option value="cable de datos">Cable de datos</option>
                                        <option value="Bluetooth">Bluetooth</option>
                                        <option value="WiFi">WiFi</option>
                                        <option value="copia manual">Copia manual</option>
                                        <option value="otro">Otro</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Archivos Aportados -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-primary mb-3">
                                    <i class="fas fa-file-upload me-2"></i>Archivos Aportados
                                </h5>
                                <div class="card">
                                    <div class="card-body">
                                        <div class="row" id="archivos-container">
                                            <div class="col-12 text-center text-muted">
                                                <i class="fas fa-folder-open fa-3x mb-3"></i>
                                                <p>No hay archivos aportados aún</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Botones -->
                        <div class="row">
                            <div class="col-12">
                                <div class="d-flex gap-2 flex-wrap">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-file-alt me-2"></i>Generar Acta
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="limpiarFormulario()">
                                        <i class="fas fa-eraser me-2"></i>Limpiar Formulario
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>

                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para visualizar archivos -->
<div class="modal fade" id="archivoModal" tabindex="-1" aria-labelledby="archivoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="archivoModalLabel">
                    <i class="fas fa-file me-2"></i>Visualizador de Archivos
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-8">
                        <div id="archivo-contenido" class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Información del Archivo</h6>
                            </div>
                            <div class="card-body">
                                <div id="archivo-info">
                                    <p><strong>Nombre:</strong> <span id="archivo-nombre">-</span></p>
                                    <p><strong>Tamaño:</strong> <span id="archivo-tamaño">-</span></p>
                                    <p><strong>Tipo:</strong> <span id="archivo-tipo">-</span></p>
                                    <p><strong>Fecha:</strong> <span id="archivo-fecha">-</span></p>
                                </div>
                                <div class="mt-3">
                                    <button class="btn btn-primary btn-sm w-100" id="descargar-archivo">
                                        <i class="fas fa-download me-2"></i>Descargar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<style>
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background: white;
        padding: 2rem;
        border-radius: 0.5rem;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }

    .section-title {
        font-weight: 600;
        color: var(--primary-color);
        margin-bottom: 1rem;
        font-size: 1.1rem;
    }

    .modal-field-group {
        margin-bottom: 1.5rem;
    }

    .modal-field-group > div {
        margin-bottom: 1rem;
    }

    .modal-field-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: var(--dark-color);
    }

    .modal-field-group input,
    .modal-field-group select {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid var(--border-color);
        border-radius: 0.375rem;
        font-size: 0.875rem;
    }

    .modal-buttons {
        display: flex;
        gap: 0.5rem;
        justify-content: flex-end;
        margin-top: 1rem;
    }

    .dispositivo-section {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
        border: 1px solid var(--border-color);
    }

    .dispositivo-section h6 {
        color: var(--primary-color);
        margin-bottom: 1rem;
        font-weight: 600;
    }

    .required {
        color: var(--danger-color);
    }
</style>

<script src="{{ url_for('static', filename='utils.js') }}}"></script>
<script>
    // Variables globales
    let casosActivos = [];
    let casosFinalizados = [];
    let departamentos = [];
    let provincias = [];
    let localidades = [];

    // Inicialización
    document.addEventListener('DOMContentLoaded', function() {
        cargarCasos();
        cargarPeritoActual();
        cargarDatosGeograficos();
        configurarEventos();
        cargarFechaHoraActual();
    });

    // Cargar fecha y hora cuando se carga la página
    window.addEventListener('load', function() {
        // Pequeño delay para asegurar que los campos estén renderizados
        setTimeout(function() {
            cargarFechaHoraActual();
        }, 100);
    });

    // Cargar casos
    async function cargarCasos() {
        try {
            const [activosResponse, finalizadosResponse] = await Promise.all([
                fetch('/api/casos_activos'),
                fetch('/api/casos_finalizados')
            ]);

            casosActivos = await activosResponse.json();
            casosFinalizados = await finalizadosResponse.json();

            actualizarSelectCasos();
        } catch (error) {
            console.error('Error al cargar casos:', error);
        }
    }

    // Cargar datos geográficos
    async function cargarDatosGeograficos() {
        try {
            const [depResponse, provResponse, locResponse] = await Promise.all([
                fetch("{{ url_for('static', filename='data/departamentos.json') }}}"),
                fetch("{{ url_for('static', filename='data/provincias.json') }}}"),
                fetch("{{ url_for('static', filename='data/localidades_censales.json') }}}")
            ]);

            departamentos = await depResponse.json();
            provincias = await provResponse.json();
            localidades = await locResponse.json();

            llenarSelectsGeograficos();
        } catch (error) {
            console.error('Error al cargar datos geográficos:', error);
        }
    }

    // Cargar perito actual del usuario logueado
    async function cargarPeritoActual() {
        try {
            const response = await fetch('/api/usuario_actual');
            const data = await response.json();
            
            if (data.success && data.usuario) {
                document.getElementById('perito').value = data.usuario.nombre || 'Usuario Actual';
            }
        } catch (error) {
            console.error('Error al cargar perito actual:', error);
            // Fallback: usar un valor por defecto
            document.getElementById('perito').value = 'Usuario Actual';
        }
    }

    // Cargar casos disponibles
    async function cargarCasos() {
        try {
            const response = await fetch('/api/casos_activos');
            const data = await response.json();
            
            const select = document.getElementById('caso-select');
            select.innerHTML = '<option value="">Seleccionar caso...</option>';
            
            data.forEach(caso => {
                const option = document.createElement('option');
                option.value = caso.sesion_id;
                option.textContent = `${caso.nombre} - ${caso.expediente}`;
                option.dataset.expediente = caso.expediente;
                option.dataset.perito = caso.perito;
                select.appendChild(option);
            });

            // Agregar evento de cambio
            select.addEventListener('change', function() {
                if (this.value) {
                    // El perito se mantiene como el usuario logueado
                    cargarArchivosCaso(this.value);
                } else {
                    document.getElementById('archivos-container').innerHTML = '<p class="text-muted">No hay archivos cargados</p>';
                }
            });
        } catch (error) {
            console.error('Error al cargar casos:', error);
        }
    }

    // Llenar selects geográficos
    function llenarSelectsGeograficos() {
        console.log('Cargando datos geográficos:', { provincias, departamentos, localidades });
        
        // Provincias
        const provSelect = document.getElementById('provincia');
        const deptSelect = document.getElementById('departamento');
        const locSelect = document.getElementById('localidad');
        
        provSelect.innerHTML = '<option value="">Seleccionar provincia...</option>';
        
        provincias.provincias.forEach(prov => {
            const option = document.createElement('option');
            option.value = prov.id;
            option.textContent = prov.nombre;
            provSelect.appendChild(option);
        });

        // Limpiar eventos anteriores
        provSelect.replaceWith(provSelect.cloneNode(true));
        deptSelect.replaceWith(deptSelect.cloneNode(true));
        locSelect.replaceWith(locSelect.cloneNode(true));
        
        // Obtener referencias frescas
        const provSelectNew = document.getElementById('provincia');
        const deptSelectNew = document.getElementById('departamento');
        const locSelectNew = document.getElementById('localidad');

        // Evento para provincia
        provSelectNew.addEventListener('change', function() {
            console.log('Provincia seleccionada:', this.value);
            
            // Limpiar departamentos y localidades
            deptSelectNew.innerHTML = '<option value="">Seleccionar departamento...</option>';
            locSelectNew.innerHTML = '<option value="">Seleccionar localidad...</option>';
            
            if (this.value) {
                // Filtrar departamentos por provincia
                const deptosFiltrados = departamentos.departamentos.filter(dept => 
                    dept.provincia && dept.provincia.id === this.value
                );
                
                console.log('Departamentos filtrados:', deptosFiltrados);
                
                deptosFiltrados.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept.id;
                    option.textContent = dept.nombre;
                    deptSelectNew.appendChild(option);
                });
            }
        });

        // Evento para departamento
        deptSelectNew.addEventListener('change', function() {
            console.log('Departamento seleccionado:', this.value);
            
            // Limpiar localidades
            locSelectNew.innerHTML = '<option value="">Seleccionar localidad...</option>';
            
            if (this.value && provSelectNew.value) {
                // Filtrar localidades por departamento y provincia
                const locsFiltradas = localidades.localidades_censales.filter(loc => 
                    loc.departamento && loc.departamento.id === this.value &&
                    loc.provincia && loc.provincia.id === provSelectNew.value
                );
                
                console.log('Localidades filtradas:', locsFiltradas);
                
                locsFiltradas.forEach(loc => {
                    const option = document.createElement('option');
                    option.value = loc.nombre;
                    option.textContent = loc.nombre;
                    locSelectNew.appendChild(option);
                });
                
                // Agregar opción "Otros"
                const otrosOption = document.createElement('option');
                otrosOption.value = 'otros';
                otrosOption.textContent = 'Otros...';
                locSelectNew.appendChild(otrosOption);
            }
        });

        // Evento para localidad "Otros"
        locSelectNew.addEventListener('change', function() {
            const otraLocalidadContainer = document.getElementById('otra-localidad-container');
            const otraLocalidadInput = document.getElementById('otra_localidad');
            
            if (this.value === 'otros') {
                otraLocalidadContainer.style.display = 'block';
                otraLocalidadInput.required = true;
                otraLocalidadInput.focus();
            } else {
                otraLocalidadContainer.style.display = 'none';
                otraLocalidadInput.required = false;
                otraLocalidadInput.value = '';
            }
        });
    }

    // Actualizar select de casos
    function actualizarSelectCasos() {
        const select = document.getElementById('existing-case-select');
        select.innerHTML = '<option value="">Seleccionar caso...</option>';

        // Casos activos
        casosActivos.forEach(caso => {
            const option = document.createElement('option');
            option.value = caso.sesion_id;
            option.textContent = `${caso.nombre_caso} - ${caso.expediente}`;
            option.dataset.expediente = caso.expediente;
            option.dataset.perito = caso.perito;
            select.appendChild(option);
        });

        // Casos finalizados
        casosFinalizados.forEach(caso => {
            const option = document.createElement('option');
            option.value = caso.sesion_id;
            option.textContent = `${caso.nombre_caso} - ${caso.expediente} (Finalizado)`;
            option.dataset.expediente = caso.expediente;
            option.dataset.perito = caso.perito;
            select.appendChild(option);
        });
    }

    // Configurar eventos
    function configurarEventos() {
        // Solo configurar eventos de elementos que existen en la página inicial
        const createCaseBtn = document.getElementById('create-case-btn');
        const cancelCaseBtn = document.getElementById('cancel-case-btn');
        const selectCaseBtn = document.getElementById('select-case-btn');
        const cancelSelectBtn = document.getElementById('cancel-select-btn');
        const fiscaliaInput = document.getElementById('case-fiscalia-input');

        if (createCaseBtn) createCaseBtn.addEventListener('click', crearCaso);
        if (cancelCaseBtn) cancelCaseBtn.addEventListener('click', cerrarModal);
        if (selectCaseBtn) selectCaseBtn.addEventListener('click', seleccionarCaso);
        if (cancelSelectBtn) cancelSelectBtn.addEventListener('click', cerrarModal);

        if (fiscaliaInput) {
            fiscaliaInput.addEventListener('change', function() {
                const otherDiv = document.getElementById('case-fiscalia-other');
                if (otherDiv) {
                    otherDiv.style.display = this.value === 'Otros' ? 'block' : 'none';
                }
            });
        }
    }

    // Configurar eventos del formulario principal
    function configurarEventosFormulario() {
        // Cambio de dispositivo
        const dispositivoSelect = document.getElementById('dispositivo');
        if (dispositivoSelect) {
            console.log('Configurando event listener para dispositivo');
            // Remover event listeners anteriores para evitar duplicados
            dispositivoSelect.removeEventListener('change', mostrarCamposDispositivo);
            dispositivoSelect.addEventListener('change', mostrarCamposDispositivo);
        } else {
            console.error('Elemento dispositivo no encontrado');
        }
    }

    // Mostrar formulario
    function mostrarFormulario() {
        document.getElementById('inicio-formulario').style.display = 'none';
        document.getElementById('main-form').style.display = 'block';
        cargarFechaHoraActual();
        
        // Configurar eventos del formulario cuando se muestra
        setTimeout(() => {
            configurarEventosFormulario();
        }, 100);
    }

    // Crear caso
    async function crearCaso() {
        const nombre = document.getElementById('case-name-input').value;
        const expediente = document.getElementById('case-expediente-input').value;
        const fiscalia = document.getElementById('case-fiscalia-input').value;
        const fiscaliaOtro = document.getElementById('case-fiscalia-other-input').value;
        const perito = document.getElementById('case-perito-input').value;

        if (!nombre || !expediente || !fiscalia || !perito) {
            alert('Por favor complete todos los campos requeridos');
            return;
        }

        const fiscaliaFinal = fiscalia === 'Otros' ? fiscaliaOtro : fiscalia;

        try {
            const response = await fetch('/api/crear-caso', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    nombre_caso: nombre,
                    expediente: expediente,
                    fiscalia: fiscaliaFinal,
                    perito: perito
                })
            });

            const result = await response.json();

            if (result.success) {
                alert('Caso creado exitosamente');
                cerrarModal();
                cargarCasos();
                llenarDatosCaso(result.sesion_id, expediente, perito);
            } else {
                alert('Error al crear caso: ' + result.error);
            }
        } catch (error) {
            console.error('Error al crear caso:', error);
            alert('Error al crear caso');
        }
    }

    // Seleccionar caso
    function seleccionarCaso() {
        const select = document.getElementById('existing-case-select');
        const sesionId = select.value;

        if (!sesionId) {
            alert('Por favor seleccione un caso');
            return;
        }

        cerrarModal();
        cargarDatosCasoDesdeSesion(sesionId);
    }

    // Llenar datos del caso
    function llenarDatosCaso(sesionId, expediente, perito) {
        document.getElementById('expediente_completo').value = expediente;
        document.getElementById('perito').value = perito;
        mostrarFormulario();
        cargarArchivosCaso(sesionId);
    }

    // Cargar datos del caso desde sesión
    async function cargarDatosCasoDesdeSesion(sesionId) {
        try {
            const response = await fetch(`/api/casos/${sesionId}`);
            const caso = await response.json();
            
            if (caso.success) {
                document.getElementById('expediente_completo').value = caso.expediente;
                document.getElementById('perito').value = caso.perito;
                mostrarFormulario();
                cargarArchivosCaso(sesionId);
            } else {
                console.error('Error al cargar datos del caso:', caso.error);
            }
        } catch (error) {
            console.error('Error al cargar datos del caso:', error);
        }
    }

    // Cerrar modal
    function cerrarModal() {
        document.getElementById('case-modal').style.display = 'none';
    }

    // Mostrar campos del dispositivo - Función global
    window.mostrarCamposDispositivo = function() {
        const tipo = document.getElementById('dispositivo').value;
        const container = document.getElementById('dispositivo-campos');
        
        console.log('mostrarCamposDispositivo ejecutado, tipo:', tipo);
        console.log('Container encontrado:', container);
        
        if (!container) {
            console.error('Container dispositivo-campos no encontrado');
            return;
        }
        
        container.innerHTML = '';

        console.log('Tipo de dispositivo seleccionado:', tipo);
        
        if (tipo === 'telefono') {
            console.log('Mostrando campos de teléfono');
            container.innerHTML = `
                <div class="dispositivo-section">
                    <h6>Datos del Teléfono Celular</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="marca_tel" class="form-label">Marca:</label>
                                <input type="text" id="marca_tel" name="marca_tel" class="form-control">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modelo_tel" class="form-label">Modelo:</label>
                                <input type="text" id="modelo_tel" name="modelo_tel" class="form-control">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="color_tel" class="form-label">Color:</label>
                                <input type="text" id="color_tel" name="color_tel" class="form-control">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="serie_tel" class="form-label">Número de Serie:</label>
                                <input type="text" id="serie_tel" name="serie_tel" class="form-control">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="imei1" class="form-label">IMEI 1:</label>
                                <input type="text" id="imei1" name="imei1" class="form-control">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="dual" class="form-label">¿Dual SIM?</label>
                                <select id="dual" name="dual" class="form-select">
                                    <option value="no">No</option>
                                    <option value="si">Sí</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div id="imei2-container" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="imei2" class="form-label">IMEI 2:</label>
                                    <input type="text" id="imei2" name="imei2" class="form-control">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="numero_tel1" class="form-label">Número de Teléfono 1:</label>
                                <input type="tel" id="numero_tel1" name="numero_tel1" class="form-control" placeholder="+54 9 261 123-4567">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="numero_tel2" class="form-label">Número de Teléfono 2:</label>
                                <input type="tel" id="numero_tel2" name="numero_tel2" class="form-control" placeholder="+54 9 261 123-4567" style="display: none;">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <div class="mb-3">
                                <label for="obs_tel" class="form-label">Observaciones:</label>
                                <textarea id="obs_tel" name="obs_tel" class="form-control" rows="2"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Evento para dual SIM
            document.getElementById('dual').addEventListener('change', function() {
                const imei2Container = document.getElementById('imei2-container');
                const numeroTel2 = document.getElementById('numero_tel2');
                const numeroTel2Label = document.querySelector('label[for="numero_tel2"]');
                
                if (this.value === 'si') {
                    imei2Container.style.display = 'block';
                    numeroTel2.style.display = 'block';
                    numeroTel2Label.style.display = 'block';
                } else {
                    imei2Container.style.display = 'none';
                    numeroTel2.style.display = 'none';
                    numeroTel2Label.style.display = 'none';
                }
            });
        } else if (tipo === 'usb') {
            console.log('Mostrando campos de USB');
            container.innerHTML = `
                <div class="dispositivo-section">
                    <h6>Datos del Disco USB</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="marca_usb" class="form-label">Marca:</label>
                                <input type="text" id="marca_usb" name="marca_usb" class="form-control">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="capacidad_usb" class="form-label">Capacidad:</label>
                                <input type="text" id="capacidad_usb" name="capacidad_usb" class="form-control">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="serie_usb" class="form-label">Número de Serie:</label>
                                <input type="text" id="serie_usb" name="serie_usb" class="form-control">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <div class="mb-3">
                                <label for="obs_usb" class="form-label">Observaciones:</label>
                                <textarea id="obs_usb" name="obs_usb" class="form-control" rows="2"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        } else if (tipo === 'optico') {
            console.log('Mostrando campos de óptico');
            container.innerHTML = `
                <div class="dispositivo-section">
                    <h6>Datos del Soporte Óptico</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="tipo_optico" class="form-label">Tipo:</label>
                                <select id="tipo_optico" name="tipo_optico" class="form-select">
                                    <option value="">Seleccionar...</option>
                                    <option value="CD">CD</option>
                                    <option value="DVD">DVD</option>
                                    <option value="Blu-ray">Blu-ray</option>
                                    <option value="Otro">Otro</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="capacidad_optico" class="form-label">Capacidad:</label>
                                <select id="capacidad_optico" name="capacidad_optico" class="form-select">
                                    <option value="">Seleccionar capacidad...</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <div class="mb-3">
                                <label for="obs_optico" class="form-label">Observaciones:</label>
                                <textarea id="obs_optico" name="obs_optico" class="form-control" rows="2"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Evento para tipo óptico
            document.getElementById('tipo_optico').addEventListener('change', function() {
                const capacidadSelect = document.getElementById('capacidad_optico');
                capacidadSelect.innerHTML = '<option value="">Seleccionar capacidad...</option>';

                const capacidades = {
                    'CD': ['650 MB', '700 MB', '800 MB', '900 MB'],
                    'DVD': ['4.7 GB (DVD-5)', '8.5 GB (DVD-9)', '9.4 GB (DVD-10)', '17 GB (DVD-18)'],
                    'Blu-ray': ['25 GB (BD-25)', '50 GB (BD-50)', '100 GB (BD-100)', '128 GB (BD-128)']
                };

                if (capacidades[this.value]) {
                    capacidades[this.value].forEach(capacidad => {
                        const option = document.createElement('option');
                        option.value = capacidad;
                        option.textContent = capacidad;
                        capacidadSelect.appendChild(option);
                    });
                }
            });
        } else if (tipo === 'nube') {
            console.log('Mostrando campos de nube');
            container.innerHTML = `
                <div class="dispositivo-section">
                    <h6>Datos del Almacenamiento en la Nube</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="url_nube" class="form-label">URL del Servicio:</label>
                                <input type="url" id="url_nube" name="url_nube" class="form-control">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="correo_nube" class="form-label">Correo Asociado:</label>
                                <input type="email" id="correo_nube" name="correo_nube" class="form-control">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <div class="mb-3">
                                <label for="obs_nube" class="form-label">Observaciones:</label>
                                <textarea id="obs_nube" name="obs_nube" class="form-control" rows="2"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        console.log('Función mostrarCamposDispositivo completada');
    };

    // Cargar fecha y hora actual
    function cargarFechaHoraActual() {
        const now = new Date();
        const fecha = now.toISOString().split('T')[0];
        const hora = now.toTimeString().split(' ')[0].substring(0, 5);
        
        const fechaInput = document.getElementById('fecha');
        const horaInput = document.getElementById('hora');
        
        if (fechaInput) {
            fechaInput.value = fecha;
        }
        if (horaInput) {
            horaInput.value = hora;
        }
    }

    // Limpiar formulario
    function limpiarFormulario() {
        document.getElementById('main-form').reset();
        document.getElementById('dispositivo-campos').innerHTML = '';
        document.getElementById('otra-localidad-container').style.display = 'none';
        document.getElementById('otra_localidad').required = false;
        cargarFechaHoraActual();
    }

    // Cargar archivos del caso
    async function cargarArchivosCaso(sesionId) {
        try {
            const response = await fetch(`/api/casos/${sesionId}/archivos`);
            const archivos = await response.json();
            
            const container = document.getElementById('archivos-container');
            
            if (archivos.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center text-muted">
                        <i class="fas fa-folder-open fa-3x mb-3"></i>
                        <p>No hay archivos aportados aún</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';
            archivos.forEach(archivo => {
                const archivoCard = crearTarjetaArchivo(archivo);
                container.appendChild(archivoCard);
            });
        } catch (error) {
            console.error('Error al cargar archivos:', error);
        }
    }

    // Crear tarjeta de archivo
    function crearTarjetaArchivo(archivo) {
        const col = document.createElement('div');
        col.className = 'col-md-4 mb-3';
        
        const icono = obtenerIconoArchivo(archivo.tipo);
        const tamaño = formatearTamaño(archivo.tamaño);
        const fecha = new Date(archivo.fecha_subida).toLocaleDateString();
        
        col.innerHTML = `
            <div class="card h-100">
                <div class="card-body text-center">
                    <i class="${icono} fa-3x text-primary mb-3"></i>
                    <h6 class="card-title">${archivo.nombre_original}</h6>
                    <p class="card-text small text-muted">
                        <i class="fas fa-weight-hanging me-1"></i>${tamaño}<br>
                        <i class="fas fa-calendar me-1"></i>${fecha}
                    </p>
                </div>
                <div class="card-footer">
                    <button class="btn btn-primary btn-sm w-100" onclick="verArchivo('${archivo.id}', '${archivo.nombre_original}', '${archivo.tipo}')">
                        <i class="fas fa-eye me-2"></i>Ver
                    </button>
                </div>
            </div>
        `;
        
        return col;
    }

    // Obtener icono según tipo de archivo
    function obtenerIconoArchivo(tipo) {
        if (tipo.startsWith('image/')) return 'fas fa-image';
        if (tipo.startsWith('video/')) return 'fas fa-video';
        if (tipo.startsWith('audio/')) return 'fas fa-music';
        if (tipo === 'application/pdf') return 'fas fa-file-pdf';
        if (tipo.includes('word')) return 'fas fa-file-word';
        if (tipo.includes('excel')) return 'fas fa-file-excel';
        if (tipo.includes('powerpoint')) return 'fas fa-file-powerpoint';
        return 'fas fa-file';
    }

    // Formatear tamaño de archivo
    function formatearTamaño(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Ver archivo en modal
    async function verArchivo(archivoId, nombre, tipo) {
        const modal = new bootstrap.Modal(document.getElementById('archivoModal'));
        const contenido = document.getElementById('archivo-contenido');
        const info = document.getElementById('archivo-info');
        
        // Mostrar spinner
        contenido.innerHTML = `
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
        `;
        
        // Actualizar información
        document.getElementById('archivo-nombre').textContent = nombre;
        document.getElementById('archivo-tipo').textContent = tipo;
        
        modal.show();
        
        try {
            const response = await fetch(`/api/archivos/${archivoId}/ver`);
            
            if (tipo.startsWith('image/')) {
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                contenido.innerHTML = `<img src="${url}" class="img-fluid" alt="${nombre}">`;
            } else if (tipo.startsWith('video/')) {
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                contenido.innerHTML = `
                    <video controls class="w-100" style="max-height: 500px;">
                        <source src="${url}" type="${tipo}">
                        Tu navegador no soporta el elemento video.
                    </video>
                `;
            } else if (tipo.startsWith('audio/')) {
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                contenido.innerHTML = `
                    <audio controls class="w-100">
                        <source src="${url}" type="${tipo}">
                        Tu navegador no soporta el elemento audio.
                    </audio>
                `;
            } else if (tipo === 'application/pdf') {
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                contenido.innerHTML = `
                    <iframe src="${url}" class="w-100" style="height: 500px;" frameborder="0"></iframe>
                `;
            } else {
                contenido.innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-file fa-3x text-muted mb-3"></i>
                        <p>Este tipo de archivo no se puede visualizar directamente</p>
                        <button class="btn btn-primary" onclick="descargarArchivo('${archivoId}', '${nombre}')">
                            <i class="fas fa-download me-2"></i>Descargar para ver
                        </button>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Error al cargar archivo:', error);
            contenido.innerHTML = `
                <div class="text-center text-danger">
                    <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                    <p>Error al cargar el archivo</p>
                </div>
            `;
        }
    }

    // Descargar archivo
    async function descargarArchivo(archivoId, nombre) {
        try {
            const response = await fetch(`/api/archivos/${archivoId}/descargar`);
            const blob = await response.blob();
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = nombre;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        } catch (error) {
            console.error('Error al descargar archivo:', error);
            alert('Error al descargar el archivo');
        }
    }
</script>
{% endblock %}
