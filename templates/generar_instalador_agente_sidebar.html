{% extends "base_sidebar.html" %}

{% block title %}Generar Instalador de Agente - Sistema Forense{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-cogs me-2"></i>Generar Instalador de Agente
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-4">
                    Genere un instalador personalizado para el agente forense con su configuración específica.
                </p>
                
                <form id="generarInstaladorForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="user_id" class="form-label">ID de Usuario</label>
                            <input type="text" class="form-control" id="user_id" name="user_id" 
                                   value="{{ current_user.id }}" readonly>
                        </div>
                        <div class="col-md-6">
                            <label for="server_url" class="form-label">URL del Servidor</label>
                            <input type="text" class="form-control" id="server_url" name="server_url" 
                                   value="{{ request.url_root.rstrip('/') }}" readonly>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="token" class="form-label">Token de Registro</label>
                            <input type="text" class="form-control" id="token" name="token" 
                                   placeholder="Ingrese un token único" required>
                            <div class="form-text">Token único para el registro del agente</div>
                        </div>
                        <div class="col-md-6">
                            <label for="tipo_instalador" class="form-label">Tipo de Instalador</label>
                            <select class="form-select" id="tipo_instalador" name="tipo_instalador">
                                <option value="bat">BAT (Recomendado)</option>
                                <option value="exe">EXE (Avanzado)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Información:</strong> El instalador generado incluirá automáticamente la configuración 
                                para conectarse a este servidor y registrarse con el token proporcionado.
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary" id="generarBtn">
                            <i class="fas fa-cogs me-2"></i>Generar Instalador
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="generarToken()">
                            <i class="fas fa-key me-2"></i>Generar Token Aleatorio
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Progreso de generación -->
<div class="row mt-4" id="progresoGeneracion" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-cog fa-spin me-2"></i>Generando Instalador
                </h5>
            </div>
            <div class="card-body">
                <div class="progress mb-3">
                    <div class="progress-bar" role="progressbar" style="width: 0%" id="progresoBarra"></div>
                </div>
                <div class="text-center">
                    <p id="estadoGeneracion">Preparando generación...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Generar token aleatorio por defecto
        generarToken();
        
        // Configurar formulario
        document.getElementById('generarInstaladorForm').addEventListener('submit', function(e) {
            e.preventDefault();
            generarInstalador();
        });
    });

    function generarToken() {
        const token = 'AGENTE_' + Math.random().toString(36).substr(2, 9).toUpperCase();
        document.getElementById('token').value = token;
    }

    async function generarInstalador() {
        const formData = new FormData(document.getElementById('generarInstaladorForm'));
        const data = Object.fromEntries(formData.entries());
        
        // Mostrar progreso
        document.getElementById('progresoGeneracion').style.display = 'block';
        document.getElementById('generarBtn').disabled = true;
        
        // Simular progreso
        simularProgreso();
        
        try {
            const tipoInstalador = data.tipo_instalador;
            const endpoint = tipoInstalador === 'exe' ? 
                '/api/installer-agente/generate-exe' : 
                '/api/installer-agente/generate';
            
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                
                // Crear enlace de descarga
                const a = document.createElement('a');
                a.href = url;
                a.download = `Instalador_Agente_${data.user_id}_${tipoInstalador.toUpperCase()}.${tipoInstalador === 'exe' ? 'exe' : 'zip'}`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                // Limpiar URL
                window.URL.revokeObjectURL(url);
                
                // Mostrar mensaje de éxito
                mostrarMensaje('Instalador generado y descargado exitosamente', 'success');
            } else {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Error generando instalador');
            }
        } catch (error) {
            console.error('Error generando instalador:', error);
            mostrarMensaje('Error generando instalador: ' + error.message, 'danger');
        } finally {
            document.getElementById('progresoGeneracion').style.display = 'none';
            document.getElementById('generarBtn').disabled = false;
        }
    }

    function simularProgreso() {
        const progressBar = document.getElementById('progresoBarra');
        const statusText = document.getElementById('estadoGeneracion');
        let progress = 0;

        const interval = setInterval(() => {
            progress += Math.random() * 20;
            if (progress > 100) progress = 100;
            
            progressBar.style.width = `${progress}%`;
            
            if (progress < 30) {
                statusText.textContent = 'Preparando archivos...';
            } else if (progress < 60) {
                statusText.textContent = 'Configurando instalador...';
            } else if (progress < 90) {
                statusText.textContent = 'Compilando instalador...';
            } else {
                statusText.textContent = 'Finalizando generación...';
            }
            
            if (progress >= 100) {
                clearInterval(interval);
            }
        }, 300);
    }

    function mostrarMensaje(mensaje, tipo) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${tipo} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            <i class="fas fa-${tipo === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
            ${mensaje}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.querySelector('main').insertBefore(alertDiv, document.querySelector('main').firstChild);
    }
</script>
{% endblock %}
