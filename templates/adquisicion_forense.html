{% extends "base_sidebar.html" %}

{% block title %}Adquisición Forense Digital{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-warning text-dark">
                    <h4 class="mb-0">
                        <i class="fas fa-hdd me-2"></i>Adquisición de Imágenes Forenses
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-4">
                                <label for="dispositivoOrigen" class="form-label">Dispositivo de Origen:</label>
                                <select class="form-select" id="dispositivoOrigen">
                                    <option value="">Seleccionar dispositivo...</option>
                                    <option value="hdd">Disco Duro (HDD)</option>
                                    <option value="ssd">Disco de Estado Sólido (SSD)</option>
                                    <option value="usb">Memoria USB</option>
                                    <option value="sd">Tarjeta SD</option>
                                    <option value="cd">CD/DVD</option>
                                    <option value="network">Dispositivo de Red</option>
                                </select>
                            </div>
                            <div class="mb-4">
                                <label for="rutaDispositivo" class="form-label">Dispositivo a Adquirir:</label>
                                <div class="input-group">
                                    <select class="form-select" id="dispositivoSelect">
                                        <option value="">Seleccionar dispositivo...</option>
                                    </select>
                                    <button class="btn btn-outline-info" type="button" onclick="detectarDispositivos()">
                                        <i class="fas fa-search me-2"></i>Detectar
                                    </button>
                                </div>
                                <div class="form-text">Seleccione el dispositivo de la lista o ingrese manualmente</div>
                                <div class="mt-2">
                                    <input type="text" class="form-control" id="rutaDispositivo" 
                                        placeholder="O ingrese ruta manual: /dev/sda, \\.\PhysicalDrive0, E:">
                                </div>
                            </div>
                            <div class="mb-4">
                                <label for="formatoImagen" class="form-label">Formato de Imagen:</label>
                                <select class="form-select" id="formatoImagen">
                                    <option value="dd">Raw Image (DD)</option>
                                    <option value="e01" selected>Expert Witness Format (E01)</option>
                                    <option value="aff">Advanced Forensics Format (AFF)</option>
                                    <option value="img">Generic Image (IMG)</option>
                                </select>
                            </div>
                            <div class="mb-4">
                                <label for="rutaDestino" class="form-label">Ruta de Destino:</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="rutaDestino" 
                                        placeholder="Seleccione ubicación y nombre del archivo..." readonly>
                                    <button class="btn btn-outline-secondary" type="button" onclick="seleccionarDestino()">
                                        <i class="fas fa-folder-open me-2"></i>Seleccionar
                                    </button>
                                </div>
                                <div class="form-text">Seleccione la ubicación y nombre del archivo de imagen forense</div>
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="verificacionHash" checked>
                                    <label class="form-check-label" for="verificacionHash">
                                        Generar hash de verificación (MD5, SHA-1, SHA-256)
                                    </label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="compresion" checked>
                                    <label class="form-check-label" for="compresion">
                                        Comprimir imagen (disponible solo para E01 y AFF)
                                    </label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="verificacionIntegridad">
                                    <label class="form-check-label" for="verificacionIntegridad">
                                        Verificar integridad durante la adquisición
                                    </label>
                                </div>
                            </div>
                            <button class="btn btn-warning" onclick="iniciarAdquisicion()">
                                <i class="fas fa-play me-2"></i>Iniciar Adquisición
                            </button>
                            <button class="btn btn-danger ms-2" onclick="detenerAdquisicion()" id="detenerBtn" disabled>
                                <i class="fas fa-stop me-2"></i>Detener
                            </button>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-4">
                                <label for="progresoAdquisicion" class="form-label">Progreso de Adquisición:</label>
                                <div class="progress mb-2">
                                    <div class="progress-bar" id="barraProgreso" role="progressbar" style="width: 0%"></div>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <small id="porcentajeProgreso">0%</small>
                                    <small id="tiempoEstimado">Tiempo estimado: --</small>
                                </div>
                            </div>
                            <div class="mb-4">
                                <label for="logAdquisicion" class="form-label">Log de Adquisición:</label>
                                <textarea class="form-control" id="logAdquisicion" rows="8" readonly
                                    placeholder="Los logs de la adquisición aparecerán aquí..."></textarea>
                            </div>
                            <div class="mb-3">
                                <button class="btn btn-success" onclick="copiarLog()" id="copiarLogBtn" disabled>
                                    <i class="fas fa-copy me-2"></i>Copiar Log
                                </button>
                                <button class="btn btn-info ms-2" onclick="exportarLog()" id="exportarLogBtn" disabled>
                                    <i class="fas fa-download me-2"></i>Exportar Log
                                </button>
                            </div>
                            <div class="alert alert-info">
                                <h6><i class="fas fa-info-circle me-2"></i>Información de Formatos Forenses:</h6>
                                <ul class="mb-0">
                                    <li><strong>DD (Raw):</strong> Volcado bit a bit puro, sin compresión</li>
                                    <li><strong>E01 (EnCase):</strong> Formato estándar forense con compresión integrada</li>
                                    <li><strong>AFF (Advanced):</strong> Formato avanzado con compresión, encriptación y metadatos</li>
                                    <li><strong>IMG (Genérica):</strong> Imagen cruda tipo DD, sin compresión</li>
                                </ul>
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                        <strong>Nota:</strong> La compresión solo está disponible para formatos E01 y AFF
                                    </small>
                                </div>
                            </div>
                            
            <div class="alert alert-success">
                <h6><i class="fas fa-check-circle me-2"></i>✅ ARQUITECTURA DISTRIBUIDA ACTIVA:</h6>
                <p class="mb-1"><strong>Stack Principal (Python 3.13):</strong> DD, E01, IMG</p>
                <p class="mb-1"><strong>Stack Forense (Python 3.9):</strong> AFF4</p>
                <p class="mb-1"><strong>Agente Windows (Python 3.13):</strong> DD, E01, IMG</p>
                <p class="mb-0"><strong>Fallback:</strong> Si los agentes no están disponibles, se usará simulación</p>
            </div>
                            
                            <div class="alert alert-warning">
                                <h6><i class="fas fa-desktop me-2"></i>Nomenclatura de Dispositivos por Sistema:</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <strong>Windows:</strong>
                                        <ul class="mb-0">
                                            <li><code>\\\\.\\PhysicalDrive0</code> - Disco principal</li>
                                            <li><code>\\\\.\\PhysicalDrive1</code> - Segundo disco</li>
                                            <li><code>E:</code> - Unidad de disco</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Linux/Unix:</strong>
                                        <ul class="mb-0">
                                            <li><code>/dev/sda</code> - Disco principal</li>
                                            <li><code>/dev/sdb</code> - Segundo disco/USB</li>
                                            <li><code>/dev/sdc</code> - Tercer dispositivo</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para selección de destino -->
<div class="modal fade" id="modalDestino" tabindex="-1" aria-labelledby="modalDestinoLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="modalDestinoLabel">
                    <i class="fas fa-folder-open me-2"></i>Seleccionar Destino de Imagen Forense
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-lg-7">
                        <div class="mb-4">
                            <label for="rutaDestinoModal" class="form-label fw-bold">Ruta de Destino:</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="rutaDestinoModal" 
                                    placeholder="C:\Evidencia\Caso001\" value="C:\Evidencia\Caso001\" readonly>
                                <button class="btn btn-outline-secondary" type="button" onclick="seleccionarCarpetaDestino()">
                                    <i class="fas fa-folder-open me-2"></i>Seleccionar
                                </button>
                            </div>
                            <div class="form-text">Directorio donde se guardará la imagen forense</div>
                        </div>
                        <div class="mb-4">
                            <label for="nombreArchivoModal" class="form-label fw-bold">Nombre del Archivo:</label>
                            <input type="text" class="form-control" id="nombreArchivoModal" 
                                placeholder="imagen_forense" value="imagen_forense">
                            <div class="form-text">Nombre sin extensión (se agregará automáticamente)</div>
                        </div>
                    </div>
                    <div class="col-lg-5">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Vista Previa:</label>
                            <div class="border rounded p-2 bg-light">
                                <code id="vistaPreviaArchivo" class="fs-6">C:\Evidencia\Caso001\imagen_forense.e01</code>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Formato:</label>
                            <div class="alert alert-info mb-0 py-2">
                                <i class="fas fa-file me-2"></i>
                                <span id="formatoSeleccionado" class="fw-bold">Expert Witness Format (E01)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-warning" onclick="confirmarDestino()">
                    <i class="fas fa-check me-2"></i>Confirmar Destino
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let adquisicionEnProgreso = false;

    // ===== FUNCIONES DE DETECCIÓN DE DISPOSITIVOS =====

    function detectarDispositivos() {
        const select = document.getElementById('dispositivoSelect');
        const btn = document.querySelector('button[onclick="detectarDispositivos()"]');
        
        // Mostrar estado de carga
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Detectando...';
        btn.disabled = true;
        
        // Obtener información del usuario actual
        const usuarioActual = obtenerUsuarioActual();
        
        if (usuarioActual && usuarioActual.agente_instalado) {
            // Usuario tiene agente instalado - usar agente local
            detectarConAgenteLocal(usuarioActual);
        } else {
            // Usuario no tiene agente - usar stack forense central
            detectarConStackForense();
        }
    }

    function obtenerUsuarioActual() {
        // Obtener información del usuario desde el localStorage o sessionStorage
        const usuario = JSON.parse(localStorage.getItem('usuario_actual') || '{}');
        return usuario;
    }

    function detectarConAgenteLocal(usuario) {
        const agenteUrl = usuario.agente_url || 'http://localhost:5001';
        
        fetch(`${agenteUrl}/disks`, {
            headers: {
                'Authorization': `Bearer ${usuario.agente_api_key || 'forensic_agent_2024'}`
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const dispositivos = data.disks.map(disk => ({
                        ruta: disk.device_id,
                        nombre: `${disk.model} (${disk.size})`,
                        tipo: disk.type,
                        tamano: disk.size,
                        marca: disk.model.split(' ')[0] || 'N/A',
                        modelo: disk.model,
                        interface: disk.interface,
                        smart: { estado: 'Disponible' },
                        agente: 'Local',
                        usuario: usuario.nombre || 'Usuario'
                    }));
                    mostrarDispositivosReales(dispositivos);
                } else {
                    console.warn('Agente local no disponible, usando stack forense:', data.error);
                    detectarConStackForense();
                }
            })
            .catch(error => {
                console.warn('Error con agente local, usando stack forense:', error);
                detectarConStackForense();
            });
    }

    function detectarConStackForense() {
        // Usar stack forense central
        fetch('http://localhost:5002/status', {
            headers: {
                'Authorization': 'Bearer forensic_agent_2024'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'ok') {
                    // El stack forense está disponible, pero no tiene endpoint de discos
                    // Simular detección o usar API del servidor principal
                    fetch('/api/forensic/detectar-dispositivos')
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                const dispositivos = data.dispositivos.map(disk => ({
                                    ...disk,
                                    agente: 'Stack Forense',
                                    usuario: 'Sistema'
                                }));
                                mostrarDispositivosReales(dispositivos);
                            } else {
                                simularDispositivos();
                            }
                        })
                        .catch(() => simularDispositivos());
                } else {
                    simularDispositivos();
                }
            })
            .catch(error => {
                console.warn('Stack forense no disponible, usando simulación:', error);
                simularDispositivos();
            });
    }

function mostrarDispositivosReales(dispositivos) {
    const select = document.getElementById('dispositivoSelect');
    const btn = document.querySelector('button[onclick="detectarDispositivos()"]');
    
    // Limpiar opciones anteriores
    select.innerHTML = '<option value="">Seleccionar dispositivo...</option>';
    
    dispositivos.forEach(dispositivo => {
        const option = document.createElement('option');
        option.value = dispositivo.ruta;
        option.textContent = `${dispositivo.nombre} (${dispositivo.tipo}) - ${dispositivo.tamano}`;
        option.dataset.dispositivo = JSON.stringify(dispositivo);
        select.appendChild(option);
    });
    
    // Restaurar botón
    btn.innerHTML = '<i class="fas fa-search me-2"></i>Detectar';
    btn.disabled = false;
    
    // Mostrar información
    mostrarInfoDispositivos(dispositivos.length);
}

function simularDispositivos() {
    const select = document.getElementById('dispositivoSelect');
    const btn = document.querySelector('button[onclick="detectarDispositivos()"]');
    
    // Simular detección de dispositivos (en producción esto sería una llamada al backend)
    setTimeout(() => {
        // Limpiar opciones anteriores
        select.innerHTML = '<option value="">Seleccionar dispositivo...</option>';
        
        // Detectar sistema operativo y simular dispositivos apropiados
        const isWindows = navigator.platform.indexOf('Win') > -1;
        
        let dispositivos = [];
        
        if (isWindows) {
            // Dispositivos para Windows con información SMART
            dispositivos = [
                { 
                    ruta: '\\\\.\\PhysicalDrive0', 
                    nombre: 'Disco Principal C: (1TB)', 
                    tipo: 'HDD', 
                    tamano: '1 TB',
                    marca: 'Western Digital',
                    modelo: 'WD10EZEX-00BN5A0',
                    smart: {
                        estado: 'OK',
                        horasEncendido: '8760',
                        temperatura: '35°C',
                        sectoresReasignados: '0',
                        sectoresPendientes: '0',
                        erroresLectura: '0',
                        ciclosEncendido: '1200'
                    }
                },
                { 
                    ruta: '\\\\.\\PhysicalDrive1', 
                    nombre: 'Disco D: (500GB)', 
                    tipo: 'SSD', 
                    tamano: '500 GB',
                    marca: 'Samsung',
                    modelo: 'SSD 980 PRO 500GB',
                    smart: {
                        estado: 'OK',
                        horasEncendido: '4320',
                        temperatura: '42°C',
                        sectoresReasignados: '0',
                        sectoresPendientes: '0',
                        erroresLectura: '0',
                        ciclosEscritura: '1500',
                        vidaUtil: '95%',
                        ciclosEncendido: '800'
                    }
                },
                { 
                    ruta: '\\\\.\\PhysicalDrive2', 
                    nombre: 'USB Kingston (32GB)', 
                    tipo: 'USB', 
                    tamano: '32 GB',
                    marca: 'Kingston',
                    modelo: 'DataTraveler 3.0',
                    smart: {
                        estado: 'OK',
                        ciclosEscritura: '500',
                        vidaUtil: '98%',
                        temperatura: 'N/A'
                    }
                },
                { 
                    ruta: '\\\\.\\PhysicalDrive3', 
                    nombre: 'Tarjeta SD (16GB)', 
                    tipo: 'SD', 
                    tamano: '16 GB',
                    marca: 'SanDisk',
                    modelo: 'Ultra SDHC',
                    smart: {
                        estado: 'OK',
                        ciclosEscritura: '200',
                        vidaUtil: '99%',
                        temperatura: 'N/A'
                    }
                },
                { 
                    ruta: 'E:', 
                    nombre: 'Unidad Óptica', 
                    tipo: 'CD/DVD', 
                    tamano: 'N/A',
                    marca: 'LG',
                    modelo: 'GH24NSD0',
                    smart: {
                        estado: 'N/A',
                        tipo: 'Óptica'
                    }
                },
                { 
                    ruta: 'F:', 
                    nombre: 'USB SanDisk (64GB)', 
                    tipo: 'USB', 
                    tamano: '64 GB',
                    marca: 'SanDisk',
                    modelo: 'Ultra USB 3.0',
                    smart: {
                        estado: 'OK',
                        ciclosEscritura: '800',
                        vidaUtil: '97%',
                        temperatura: 'N/A'
                    }
                }
            ];
        } else {
            // Dispositivos para Linux/Unix con información SMART
            dispositivos = [
                { 
                    ruta: '/dev/sda', 
                    nombre: 'Disco Principal (500GB)', 
                    tipo: 'HDD', 
                    tamano: '500 GB',
                    marca: 'Seagate',
                    modelo: 'ST500DM002-1BD142',
                    smart: {
                        estado: 'OK',
                        horasEncendido: '12000',
                        temperatura: '38°C',
                        sectoresReasignados: '0',
                        sectoresPendientes: '0',
                        erroresLectura: '0',
                        ciclosEncendido: '2000'
                    }
                },
                { 
                    ruta: '/dev/sdb', 
                    nombre: 'USB Kingston (32GB)', 
                    tipo: 'USB', 
                    tamano: '32 GB',
                    marca: 'Kingston',
                    modelo: 'DataTraveler 3.0',
                    smart: {
                        estado: 'OK',
                        ciclosEscritura: '500',
                        vidaUtil: '98%',
                        temperatura: 'N/A'
                    }
                },
                { 
                    ruta: '/dev/sdc', 
                    nombre: 'Tarjeta SD (16GB)', 
                    tipo: 'SD', 
                    tamano: '16 GB',
                    marca: 'SanDisk',
                    modelo: 'Ultra SDHC',
                    smart: {
                        estado: 'OK',
                        ciclosEscritura: '200',
                        vidaUtil: '99%',
                        temperatura: 'N/A'
                    }
                },
                { 
                    ruta: '/dev/sdd', 
                    nombre: 'Disco Externo (1TB)', 
                    tipo: 'HDD', 
                    tamano: '1 TB',
                    marca: 'Western Digital',
                    modelo: 'WD Elements 1TB',
                    smart: {
                        estado: 'OK',
                        horasEncendido: '5000',
                        temperatura: '40°C',
                        sectoresReasignados: '0',
                        sectoresPendientes: '0',
                        erroresLectura: '0',
                        ciclosEncendido: '500'
                    }
                }
            ];
        }
        
        dispositivos.forEach(dispositivo => {
            const option = document.createElement('option');
            option.value = dispositivo.ruta;
            option.textContent = `${dispositivo.nombre} (${dispositivo.tipo}) - ${dispositivo.tamano}`;
            option.dataset.dispositivo = JSON.stringify(dispositivo);
            select.appendChild(option);
        });
        
        // Restaurar botón
        btn.innerHTML = '<i class="fas fa-search me-2"></i>Detectar';
        btn.disabled = false;
        
        // Mostrar información
        mostrarInfoDispositivos(dispositivos.length, isWindows);
        
    }, 2000);
}

function mostrarInfoDispositivos(cantidad, isWindows) {
    // Remover información anterior
    const infoAnterior = document.querySelector('.alert-info.dispositivos');
    if (infoAnterior) {
        infoAnterior.remove();
    }
    
    // Crear nueva información
    const info = document.createElement('div');
    info.className = 'alert alert-info dispositivos mt-2';
    
    const sistemaOperativo = isWindows ? 'Windows' : 'Linux/Unix';
    const nomenclatura = isWindows ? '\\\\.\\PhysicalDriveX' : '/dev/sdX';
    
    info.innerHTML = `
        <div class="d-flex align-items-center mb-2">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Dispositivos detectados: ${cantidad} dispositivos encontrados</strong>
        </div>
        <div class="row">
            <div class="col-md-6">
                <small class="text-muted">
                    <i class="fas fa-desktop me-1"></i>
                    <strong>Sistema:</strong> ${sistemaOperativo}
                </small>
            </div>
            <div class="col-md-6">
                <small class="text-muted">
                    <i class="fas fa-code me-1"></i>
                    <strong>Nomenclatura:</strong> ${nomenclatura}
                </small>
            </div>
        </div>
        <div class="mt-2">
            <small class="text-muted">
                <i class="fas fa-mouse-pointer me-1"></i>
                Seleccione un dispositivo de la lista o ingrese la ruta manualmente
            </small>
        </div>
    `;
    
    // Insertar después del input group
    document.getElementById('dispositivoSelect').parentNode.parentNode.appendChild(info);
}

// Evento para cuando se selecciona un dispositivo
document.addEventListener('DOMContentLoaded', function() {
    const select = document.getElementById('dispositivoSelect');
    const input = document.getElementById('rutaDispositivo');
    const formatoSelect = document.getElementById('formatoImagen');
    const compresionCheck = document.getElementById('compresion');
    
    select.addEventListener('change', function() {
        if (this.value) {
            input.value = this.value;
        }
    });
    
    // Controlar disponibilidad de compresión según formato
    formatoSelect.addEventListener('change', function() {
        const formato = this.value;
        const compresionLabel = compresionCheck.nextElementSibling;
        
        if (formato === 'e01' || formato === 'aff') {
            compresionCheck.disabled = false;
            compresionCheck.checked = true;
            compresionLabel.textContent = 'Comprimir imagen (recomendado para ' + formato.toUpperCase() + ')';
            compresionLabel.classList.remove('text-muted');
        } else {
            compresionCheck.disabled = true;
            compresionCheck.checked = false;
            compresionLabel.textContent = 'Comprimir imagen (no disponible para ' + formato.toUpperCase() + ')';
            compresionLabel.classList.add('text-muted');
        }
    });
    
    // Detectar dispositivos automáticamente al cargar la página
    detectarDispositivos();
    
    // Event listeners para el modal de destino
    document.getElementById('rutaDestinoModal').addEventListener('input', actualizarVistaPrevia);
    document.getElementById('nombreArchivoModal').addEventListener('input', actualizarVistaPrevia);
    document.getElementById('formatoImagen').addEventListener('change', function() {
        // Actualizar el modal si está abierto
        if (document.getElementById('modalDestino').classList.contains('show')) {
            actualizarVistaPrevia();
        }
    });
});

// ===== FUNCIONES DE ADQUISICIÓN FORENSE =====

async function iniciarAdquisicionConStackForense(dispositivo, formato, destino, verificacionHash, compresion, verificacionIntegridad) {
    try {
        const response = await fetch('http://192.168.1.93:5002/acquire-aff4', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer forensic_agent_2024'
            },
            body: JSON.stringify({
                device_path: dispositivo,
                output_name: destino.split('/').pop().split('\\').pop().replace(/\.[^/.]+$/, ''),
                case_id: 'CASE-' + Date.now()
            })
        });

        const data = await response.json();
        
        if (data.status === 'success') {
            agregarLog(`✅ Adquisición AFF4 iniciada con Stack Forense`);
            agregarLog(`📁 Archivo: ${data.output_path}`);
            agregarLog(`🆔 Operación: ${data.operation_id}`);
            
            // Monitorear progreso
            monitorearProgresoStackForense(data.operation_id);
        } else {
            agregarLog(`❌ Error: ${data.error}`);
            simularAdquisicion();
        }
    } catch (error) {
        agregarLog(`❌ Error de conexión con Stack Forense: ${error.message}`);
        simularAdquisicion();
    }
}

async function iniciarAdquisicionConAgente(dispositivo, formato, destino, verificacionHash, compresion) {
    // Generar nombre único para la operación
    const operationId = `caso_${Date.now()}`;
    const nombreArchivo = destino.split('\\').pop().split('.')[0];
    
    // Preparar datos para el agente
    const datosAdquisicion = {
        device_id: dispositivo,
        format: formato.toUpperCase(),
        output_name: nombreArchivo,
        case_id: operationId
    };
    
    let log = document.getElementById('logAdquisicion').value;
    log += `[${new Date().toLocaleTimeString()}] Conectando con Agente Windows...\n`;
    log += `[${new Date().toLocaleTimeString()}] Operación ID: ${operationId}\n`;
    document.getElementById('logAdquisicion').value = log;
    
    // Iniciar adquisición en el agente
    const response = await fetch('http://localhost:5001/acquire', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer forensic_agent_2024'
        },
        body: JSON.stringify(datosAdquisicion)
    });
    
    const resultado = await response.json();
    
    if (resultado.status === 'success') {
        log += `[${new Date().toLocaleTimeString()}] Adquisición iniciada en el agente\n`;
        log += `[${new Date().toLocaleTimeString()}] Archivo destino: ${resultado.output_path}\n`;
        document.getElementById('logAdquisicion').value = log;
        
        // Monitorear progreso
        await monitorearProgresoAgente(operationId);
    } else {
        throw new Error(resultado.error || 'Error iniciando adquisición en el agente');
    }
}

async function monitorearProgresoStackForense(operationId) {
    const interval = setInterval(async () => {
        try {
            const response = await fetch(`http://192.168.1.93:5002/acquire/${operationId}/status`, {
                headers: {
                    'Authorization': 'Bearer forensic_agent_2024'
                }
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                const progress = data.progress || 0;
                const agentStatus = data.agent_status || 'unknown';
                
                // Actualizar barra de progreso
                document.getElementById('progresoAdquisicion').style.width = `${progress}%`;
                document.getElementById('progresoAdquisicion').textContent = `${progress}%`;
                
                // Actualizar log
                if (data.operation && data.operation.progress !== undefined) {
                    agregarLog(`📊 Progreso: ${progress}% - Estado: ${agentStatus}`);
                }
                
                // Verificar si terminó
                if (agentStatus === 'completed') {
                    clearInterval(interval);
                    agregarLog(`✅ Adquisición AFF4 completada`);
                    if (data.operation && data.operation.hashes) {
                        agregarLog(`🔐 Hashes generados:`);
                        agregarLog(`   MD5: ${data.operation.hashes.md5}`);
                        agregarLog(`   SHA1: ${data.operation.hashes.sha1}`);
                        agregarLog(`   SHA256: ${data.operation.hashes.sha256}`);
                    }
                    finalizarAdquisicion();
                } else if (agentStatus === 'error') {
                    clearInterval(interval);
                    agregarLog(`❌ Error en adquisición: ${data.operation?.error || 'Error desconocido'}`);
                    finalizarAdquisicion();
                } else if (agentStatus === 'cancelled') {
                    clearInterval(interval);
                    agregarLog(`⏹️ Adquisición cancelada`);
                    finalizarAdquisicion();
                }
            }
        } catch (error) {
            agregarLog(`❌ Error monitoreando progreso: ${error.message}`);
        }
    }, 2000);
}

async function monitorearProgresoAgente(operationId) {
    let log = document.getElementById('logAdquisicion').value;
    
    while (adquisicionEnProgreso) {
        try {
            const response = await fetch(`http://localhost:5001/acquire/${operationId}/status`, {
                headers: {
                    'Authorization': 'Bearer forensic_agent_2024'
                }
            });
            
            const estado = await response.json();
            
            if (estado.status === 'success') {
                const progreso = estado.progress || 0;
                const operacion = estado.operation;
                
                // Actualizar barra de progreso
                document.getElementById('barraProgreso').style.width = `${progreso}%`;
                document.getElementById('porcentajeProgreso').textContent = `${progreso}%`;
                
                // Calcular tiempo estimado
                const tiempoEstimado = Math.max(0, (100 - progreso) * 0.5);
                document.getElementById('tiempoEstimado').textContent = `Tiempo estimado: ${tiempoEstimado.toFixed(1)} min`;
                
                // Actualizar log
                if (operacion && operacion.start_time) {
                    const tiempoTranscurrido = Math.round((Date.now() - new Date(operacion.start_time).getTime()) / 1000 / 60);
                    log += `[${new Date().toLocaleTimeString()}] Progreso: ${progreso}% - Tiempo transcurrido: ${tiempoTranscurrido} min\n`;
                }
                
                document.getElementById('logAdquisicion').value = log;
                document.getElementById('logAdquisicion').scrollTop = document.getElementById('logAdquisicion').scrollHeight;
                
                // Verificar si completó
                if (estado.agent_status === 'completed') {
                    log += `\n=== ADQUISICIÓN COMPLETADA ===\n`;
                    log += `[${new Date().toLocaleTimeString()}] Estado: EXITOSO\n`;
                    
                    if (operacion && operacion.success) {
                        log += `[${new Date().toLocaleTimeString()}] Archivo: ${operacion.output_path}\n`;
                        log += `[${new Date().toLocaleTimeString()}] Tamaño: ${(operacion.file_size / (1024*1024*1024)).toFixed(2)} GB\n`;
                        
                        if (operacion.hashes) {
                            log += `[${new Date().toLocaleTimeString()}] MD5: ${operacion.hashes.md5}\n`;
                            log += `[${new Date().toLocaleTimeString()}] SHA1: ${operacion.hashes.sha1}\n`;
                            log += `[${new Date().toLocaleTimeString()}] SHA256: ${operacion.hashes.sha256}\n`;
                        }
                    }
                    
                    document.getElementById('logAdquisicion').value = log;
                    document.getElementById('barraProgreso').style.width = '100%';
                    document.getElementById('porcentajeProgreso').textContent = '100%';
                    document.getElementById('tiempoEstimado').textContent = 'Completado';
                    
                    adquisicionEnProgreso = false;
                    document.getElementById('detenerBtn').disabled = true;
                    document.getElementById('copiarLogBtn').disabled = false;
                    document.getElementById('exportarLogBtn').disabled = false;
                    break;
                } else if (estado.agent_status === 'error') {
                    log += `\n[${new Date().toLocaleTimeString()}] ERROR: ${operacion?.error || 'Error desconocido'}\n`;
                    document.getElementById('logAdquisicion').value = log;
                    adquisicionEnProgreso = false;
                    document.getElementById('detenerBtn').disabled = true;
                    break;
                }
            }
            
        } catch (error) {
            log += `[${new Date().toLocaleTimeString()}] Error monitoreando progreso: ${error.message}\n`;
            document.getElementById('logAdquisicion').value = log;
        }
        
        // Esperar antes del siguiente check
        await new Promise(resolve => setTimeout(resolve, 2000));
    }
}

function seleccionarDestino() {
    // Obtener el formato seleccionado
    const formato = document.getElementById('formatoImagen').value;
    const formatoNombres = {
        'dd': 'Raw Image (DD)',
        'e01': 'Expert Witness Format (E01)',
        'aff': 'Advanced Forensics Format (AFF)',
        'img': 'Generic Image (IMG)'
    };
    
    // Actualizar el modal con el formato actual
    document.getElementById('formatoSeleccionado').textContent = formatoNombres[formato];
    
    // Actualizar la vista previa
    actualizarVistaPrevia();
    
    // Mostrar el modal
    const modal = new bootstrap.Modal(document.getElementById('modalDestino'));
    modal.show();
}

function seleccionarCarpetaDestino() {
    // Crear un input de tipo file para seleccionar carpeta
    const input = document.createElement('input');
    input.type = 'file';
    input.webkitdirectory = true;
    input.multiple = true;
    input.style.display = 'none';
    
    input.onchange = function(e) {
        if (e.target.files.length > 0) {
            // Obtener la ruta de la carpeta seleccionada
            const rutaCompleta = e.target.files[0].webkitRelativePath;
            const rutaCarpeta = rutaCompleta.split('/')[0];
            
            // Construir la ruta completa de la carpeta
            // En un navegador real, esto sería más complejo
            // Por ahora usamos una aproximación
            const rutaBase = 'C:\\Evidencia\\'; // Ruta base simulada
            const rutaFinal = rutaBase + rutaCarpeta + '\\';
            
            // Actualizar el campo
            document.getElementById('rutaDestinoModal').value = rutaFinal;
            
            // Actualizar la vista previa
            actualizarVistaPrevia();
            
            // Mostrar información de la carpeta seleccionada
            mostrarInfoCarpetaDestino(rutaFinal, e.target.files.length);
        }
    };
    
    input.click();
}

function mostrarInfoCarpetaDestino(rutaCarpeta, cantidadArchivos) {
    // Remover información anterior
    const infoAnterior = document.querySelector('.alert-info.carpeta-destino');
    if (infoAnterior) {
        infoAnterior.remove();
    }
    
    // Crear nueva información
    const info = document.createElement('div');
    info.className = 'alert alert-info carpeta-destino mt-2';
    info.innerHTML = `
        <div class="d-flex align-items-center mb-2">
            <i class="fas fa-folder-open me-2"></i>
            <strong>Carpeta de destino seleccionada</strong>
        </div>
        <div class="mb-2">
            <code class="bg-light p-2 rounded d-block">${rutaCarpeta}</code>
        </div>
        <div class="row">
            <div class="col-md-6">
                <small class="text-muted">
                    <i class="fas fa-folder me-1"></i>
                    <strong>Ubicación:</strong> ${rutaCarpeta}
                </small>
            </div>
            <div class="col-md-6">
                <small class="text-muted">
                    <i class="fas fa-check-circle me-1"></i>
                    Lista para guardar imagen forense
                </small>
            </div>
        </div>
    `;
    
    // Insertar después del campo de ruta
    document.getElementById('rutaDestinoModal').parentNode.parentNode.appendChild(info);
}

function actualizarVistaPrevia() {
    const ruta = document.getElementById('rutaDestinoModal').value;
    const nombre = document.getElementById('nombreArchivoModal').value;
    const formato = document.getElementById('formatoImagen').value;
    
    // Asegurar que la ruta termine con \
    const rutaFinal = ruta.endsWith('\\') ? ruta : ruta + '\\';
    
    // Construir el nombre completo con extensión
    const extension = '.' + formato;
    const nombreCompleto = nombre + extension;
    
    const rutaCompleta = rutaFinal + nombreCompleto;
    document.getElementById('vistaPreviaArchivo').textContent = rutaCompleta;
}

function confirmarDestino() {
    const ruta = document.getElementById('rutaDestinoModal').value;
    const nombre = document.getElementById('nombreArchivoModal').value;
    const formato = document.getElementById('formatoImagen').value;
    
    if (!ruta || !nombre) {
        alert('Por favor, complete la ruta de destino y el nombre del archivo.');
        return;
    }
    
    // Construir la ruta final
    const rutaFinal = ruta.endsWith('\\') ? ruta : ruta + '\\';
    const extension = '.' + formato;
    const nombreCompleto = nombre + extension;
    const rutaCompleta = rutaFinal + nombreCompleto;
    
    // Actualizar el campo principal
    document.getElementById('rutaDestino').value = rutaCompleta;
    
    // Mostrar información
    mostrarInfoDestino(nombreCompleto, 0);
    
    // Cerrar el modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('modalDestino'));
    modal.hide();
}

function mostrarInfoDestino(nombreArchivo, tamano) {
    // Remover información anterior
    const infoAnterior = document.querySelector('.alert-info.destino');
    if (infoAnterior) {
        infoAnterior.remove();
    }
    
    // Crear nueva información
    const info = document.createElement('div');
    info.className = 'alert alert-info destino mt-2';
    info.innerHTML = `
        <div class="d-flex align-items-center mb-2">
            <i class="fas fa-file-export me-2"></i>
            <strong>Archivo de destino seleccionado</strong>
        </div>
        <div class="mb-2">
            <code class="bg-light p-2 rounded d-block">${nombreArchivo}</code>
        </div>
        <small class="text-muted">
            <i class="fas fa-folder me-1"></i>
            Ubicación seleccionada para guardar la imagen forense
        </small>
    `;
    
    // Insertar después del input group
    document.getElementById('rutaDestino').parentNode.parentNode.appendChild(info);
}

async function iniciarAdquisicion() {
    const dispositivo = document.getElementById('dispositivoOrigen').value;
    const rutaDispositivo = document.getElementById('rutaDispositivo').value;
    const formato = document.getElementById('formatoImagen').value;
    const rutaDestino = document.getElementById('rutaDestino').value;
    const verificacionHash = document.getElementById('verificacionHash').checked;
    const compresion = document.getElementById('compresion').checked;
    const verificacionIntegridad = document.getElementById('verificacionIntegridad').checked;
    
    if (!dispositivo || !rutaDispositivo || !rutaDestino) {
        alert('Por favor, complete todos los campos requeridos.\n\n- Seleccione el tipo de dispositivo\n- Seleccione o ingrese la ruta del dispositivo\n- Ingrese la ruta de destino');
        return;
    }
    
    adquisicionEnProgreso = true;
    document.getElementById('detenerBtn').disabled = false;
    
    // Limpiar log anterior
    document.getElementById('logAdquisicion').value = '';
    document.getElementById('copiarLogBtn').disabled = true;
    document.getElementById('exportarLogBtn').disabled = true;
    
    // Obtener información del usuario actual
    const usuarioActual = obtenerUsuarioActual();
    
    // Iniciar log
    let log = `=== INICIO DE ADQUISICIÓN FORENSE ===\n`;
    log += `Fecha: ${new Date().toISOString()}\n`;
    log += `Usuario: ${usuarioActual.nombre || 'Sistema'}\n`;
    log += `Dispositivo: ${dispositivo} (${rutaDispositivo})\n`;
    log += `Formato: ${formato.toUpperCase()}\n`;
    log += `Destino: ${rutaDestino}\n`;
    
    // Determinar agente según usuario y formato
    if (usuarioActual && usuarioActual.agente_instalado) {
        log += `Agente: Local (${usuarioActual.nombre})\n`;
        await iniciarAdquisicionConAgenteLocal(usuarioActual, rutaDispositivo, formato, rutaDestino, verificacionHash, compresion, verificacionIntegridad);
    } else {
        log += `Agente: Stack Forense Central\n`;
        await iniciarAdquisicionConStackForense(rutaDispositivo, formato, rutaDestino, verificacionHash, compresion, verificacionIntegridad);
    }
    
    log += `Verificación Hash: ${verificacionHash ? 'Sí' : 'No'}\n`;
    log += `Compresión: ${compresion ? 'Sí' : 'No'}\n`;
    log += `Verificación Integridad: ${verificacionIntegridad ? 'Sí' : 'No'}\n\n`;
    
    document.getElementById('logAdquisicion').value = log;
    
    // Intentar usar Agente Windows primero
    try {
        await iniciarAdquisicionConAgente(rutaDispositivo, formato, rutaDestino, verificacionHash, compresion);
    } catch (error) {
        console.warn('Error con Agente Windows, usando simulación:', error);
        await simularAdquisicion();
    }
}

async function simularAdquisicion() {
    let progreso = 0;
    let log = document.getElementById('logAdquisicion').value;
    
    // Simular proceso de adquisición
    const pasos = [
        'Conectando con dispositivo...',
        'Verificando integridad del dispositivo...',
        'Iniciando lectura sector por sector...',
        'Procesando sectores dañados...',
        'Generando hash de verificación...',
        'Comprimiendo imagen...',
        'Verificando integridad de la imagen...',
        'Finalizando adquisición...'
    ];
    
    for (let i = 0; i < pasos.length; i++) {
        if (!adquisicionEnProgreso) break;
        
        // Simular tiempo de procesamiento
        await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 2000));
        
        progreso = Math.min(100, (i + 1) * 12.5);
        
        // Actualizar progreso
        document.getElementById('barraProgreso').style.width = `${progreso}%`;
        document.getElementById('porcentajeProgreso').textContent = `${Math.round(progreso)}%`;
        
        // Calcular tiempo estimado
        const tiempoEstimado = Math.max(0, (100 - progreso) * 0.5);
        document.getElementById('tiempoEstimado').textContent = `Tiempo estimado: ${tiempoEstimado.toFixed(1)} min`;
        
        // Agregar al log
        log += `[${new Date().toLocaleTimeString()}] ${pasos[i]}\n`;
        if (i === 2) {
            log += `[${new Date().toLocaleTimeString()}] Tamaño del dispositivo: 500 GB\n`;
            log += `[${new Date().toLocaleTimeString()}] Sectores totales: 976,773,168\n`;
        }
        if (i === 4) {
            log += `[${new Date().toLocaleTimeString()}] MD5: A1B2C3D4E5F678901234567890123456\n`;
            log += `[${new Date().toLocaleTimeString()}] SHA-1: 1234567890ABCDEF1234567890ABCDEF12345678\n`;
            log += `[${new Date().toLocaleTimeString()}] SHA-256: 1234567890ABCDEF1234567890ABCDEF1234567890ABCDEF1234567890ABCDEF\n`;
        }
        if (i === 6) {
            log += `[${new Date().toLocaleTimeString()}] Verificación exitosa - Imagen íntegra\n`;
        }
        
        document.getElementById('logAdquisicion').value = log;
        document.getElementById('logAdquisicion').scrollTop = document.getElementById('logAdquisicion').scrollHeight;
    }
    
    if (adquisicionEnProgreso) {
        // Completar adquisición
        const tiempoTotal = Math.round(Math.random() * 30 + 15);
        const tamanoFinal = '450 GB';
        const hashMD5 = 'A1B2C3D4E5F678901234567890123456';
        
        log += `\n=== ADQUISICIÓN COMPLETADA ===\n`;
        log += `[${new Date().toLocaleTimeString()}] Imagen forense creada exitosamente\n`;
        log += `[${new Date().toLocaleTimeString()}] Tamaño final: ${tamanoFinal} (compresión: 10%)\n`;
        log += `[${new Date().toLocaleTimeString()}] Tiempo total: ${tiempoTotal} minutos\n`;
        log += `[${new Date().toLocaleTimeString()}] Estado: EXITOSO\n`;
        
        document.getElementById('logAdquisicion').value = log;
        document.getElementById('barraProgreso').style.width = '100%';
        document.getElementById('porcentajeProgreso').textContent = '100%';
        document.getElementById('tiempoEstimado').textContent = 'Completado';
        
        // Generar y guardar log en archivo TXT
        generarLogAdquisicion(tiempoTotal, tamanoFinal, hashMD5);
        
        adquisicionEnProgreso = false;
        document.getElementById('detenerBtn').disabled = true;
        document.getElementById('copiarLogBtn').disabled = false;
        document.getElementById('exportarLogBtn').disabled = false;
    }
}

function generarLogAdquisicion(tiempoTotal, tamanoFinal, hashMD5) {
    const dispositivo = document.getElementById('dispositivoOrigen').value;
    const rutaDispositivo = document.getElementById('rutaDispositivo').value;
    const formato = document.getElementById('formatoImagen').value;
    const rutaDestino = document.getElementById('rutaDestino').value;
    const verificacionHash = document.getElementById('verificacionHash').checked;
    const compresion = document.getElementById('compresion').checked;
    const verificacionIntegridad = document.getElementById('verificacionIntegridad').checked;
    
    // Obtener información SMART del dispositivo seleccionado
    const selectDispositivo = document.getElementById('dispositivoSelect');
    const optionSeleccionada = selectDispositivo.options[selectDispositivo.selectedIndex];
    let infoDispositivo = null;
    if (optionSeleccionada && optionSeleccionada.dataset.dispositivo) {
        infoDispositivo = JSON.parse(optionSeleccionada.dataset.dispositivo);
    }
    
    const fecha = new Date();
    const fechaFormateada = fecha.toLocaleString('es-ES', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
    
    // Obtener el nombre del archivo sin extensión
    const rutaDestinoFormateada = rutaDestino.replace(/\\/g, '/');
    const nombreArchivo = rutaDestinoFormateada.split('/').pop().split('.')[0];
    const directorioDestino = rutaDestinoFormateada.substring(0, rutaDestinoFormateada.lastIndexOf('/'));
    
    // Generar nombre del archivo de log
    const nombreLog = `${nombreArchivo}_adquisicion_log.txt`;
    const rutaLog = `${directorioDestino}/${nombreLog}`;
    
    // Generar información SMART para el log
    let infoSmart = '';
    if (infoDispositivo && infoDispositivo.smart) {
        const smart = infoDispositivo.smart;
        infoSmart = `
INFORMACIÓN DEL DISPOSITIVO:
- Marca: ${infoDispositivo.marca || 'N/A'}
- Modelo: ${infoDispositivo.modelo || 'N/A'}
- Tipo: ${infoDispositivo.tipo}
- Tamaño: ${infoDispositivo.tamano}
- Ruta: ${rutaDispositivo}

DATOS SMART/DIAGNÓSTICOS:
- Estado SMART: ${smart.estado || 'N/A'}
${smart.horasEncendido ? `- Horas de Encendido: ${smart.horasEncendido} horas` : ''}
${smart.temperatura ? `- Temperatura: ${smart.temperatura}` : ''}
${smart.sectoresReasignados !== undefined ? `- Sectores Reasignados: ${smart.sectoresReasignados}` : ''}
${smart.sectoresPendientes !== undefined ? `- Sectores Pendientes: ${smart.sectoresPendientes}` : ''}
${smart.erroresLectura !== undefined ? `- Errores de Lectura: ${smart.erroresLectura}` : ''}
${smart.ciclosEncendido ? `- Ciclos de Encendido: ${smart.ciclosEncendido}` : ''}
${smart.ciclosEscritura ? `- Ciclos de Escritura: ${smart.ciclosEscritura}` : ''}
${smart.vidaUtil ? `- Vida Útil: ${smart.vidaUtil}` : ''}
${smart.tipo ? `- Tipo de Dispositivo: ${smart.tipo}` : ''}

`;
    } else {
        infoSmart = `
INFORMACIÓN DEL DISPOSITIVO:
- Dispositivo: ${dispositivo}
- Ruta: ${rutaDispositivo}
- Información SMART: No disponible

`;
    }

    const logContent = `========================================
LOG DE ADQUISICIÓN FORENSE
========================================

INFORMACIÓN GENERAL:
- Fecha y Hora: ${fechaFormateada}
- Operador: ${document.querySelector('.navbar-brand').textContent || 'Sistema Forense'}
- Herramienta: Adquisición Forense Digital v1.0

${infoSmart}CONFIGURACIÓN DE ADQUISICIÓN:
- Formato de Imagen: ${formato.toUpperCase()}
- Archivo Destino: ${rutaDestino}
- Verificación de Hash: ${verificacionHash ? 'SÍ' : 'NO'}
- Compresión: ${compresion ? 'SÍ' : 'NO'}
- Verificación de Integridad: ${verificacionIntegridad ? 'SÍ' : 'NO'}

RESULTADOS DE LA ADQUISICIÓN:
- Estado: COMPLETADA EXITOSAMENTE
- Duración: ${tiempoTotal} minutos
- Tamaño de Imagen: ${tamanoFinal}
- Hash MD5: ${hashMD5}
- Archivo de Log: ${rutaLog}

VERIFICACIÓN DE INTEGRIDAD:
- Hash Verificado: ${verificacionHash ? '✓ VERIFICADO' : '✗ NO VERIFICADO'}
- Integridad: ${verificacionIntegridad ? '✓ INTACTA' : '✗ NO VERIFICADA'}
- Estado del Archivo: ✓ COMPLETO

NOTAS TÉCNICAS:
- Método de Adquisición: Volcado bit a bit
- Algoritmo de Hash: MD5
- Sistema Operativo: ${navigator.platform}
- Navegador: ${navigator.userAgent}

========================================
FIN DEL LOG
========================================`;

    // Simular guardado del log (en una aplicación real, esto se enviaría al servidor)
    console.log('Log generado:', logContent);
    console.log('Ruta del log:', rutaLog);
    
    // Mostrar información del log en la interfaz
    mostrarInfoLog(nombreLog, rutaLog);
    
    return {
        nombre: nombreLog,
        ruta: rutaLog,
        contenido: logContent
    };
}

function mostrarInfoLog(nombreLog, rutaLog) {
    // Remover información anterior del log
    const infoAnterior = document.querySelector('.alert-success.log-generado');
    if (infoAnterior) {
        infoAnterior.remove();
    }
    
    // Crear nueva información del log
    const info = document.createElement('div');
    info.className = 'alert alert-success log-generado mt-3';
    info.innerHTML = `
        <div class="d-flex align-items-center mb-2">
            <i class="fas fa-file-alt me-2"></i>
            <strong>Log de Adquisición Generado</strong>
        </div>
        <div class="mb-2">
            <code class="bg-light p-2 rounded d-block">${rutaLog}</code>
        </div>
        <div class="row">
            <div class="col-md-6">
                <small class="text-muted">
                    <i class="fas fa-file-text me-1"></i>
                    <strong>Archivo:</strong> ${nombreLog}
                </small>
            </div>
            <div class="col-md-6">
                <small class="text-muted">
                    <i class="fas fa-check-circle me-1"></i>
                    Guardado en el mismo destino
                </small>
            </div>
        </div>
    `;
    
    // Insertar después del log de adquisición
    document.getElementById('logAdquisicion').parentNode.appendChild(info);
}

async function detenerAdquisicion() {
    if (adquisicionEnProgreso) {
        // Intentar cancelar en el agente si está disponible
        try {
            const operationId = `caso_${Date.now()}`; // Esto debería ser el ID real de la operación
            const formato = document.getElementById('formatoImagen').value;
            let url;
            
            if (formato === 'aff4') {
                // Cancelar en Stack Forense
                url = `http://192.168.1.93:5002/acquire/${operationId}/cancel`;
            } else {
                // Cancelar en Agente Windows
                url = `http://192.168.1.96:5001/acquire/${operationId}/cancel`;
            }
            
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer forensic_agent_2024'
                }
            });
            
            if (response.ok) {
                let log = document.getElementById('logAdquisicion').value;
                log += `[${new Date().toLocaleTimeString()}] Cancelación enviada al agente\n`;
                document.getElementById('logAdquisicion').value = log;
            }
        } catch (error) {
            console.warn('No se pudo cancelar en el agente:', error);
        }
        
        adquisicionEnProgreso = false;
        document.getElementById('detenerBtn').disabled = true;
        
        let log = document.getElementById('logAdquisicion').value;
        log += `\n[${new Date().toLocaleTimeString()}] ADQUISICIÓN DETENIDA POR EL USUARIO\n`;
        log += `[${new Date().toLocaleTimeString()}] Estado: INTERRUMPIDO\n`;
        
        document.getElementById('logAdquisicion').value = log;
        document.getElementById('copiarLogBtn').disabled = false;
        document.getElementById('exportarLogBtn').disabled = false;
    }
}

function copiarLog() {
    const log = document.getElementById('logAdquisicion').value;
    navigator.clipboard.writeText(log).then(() => {
        const btn = document.getElementById('copiarLogBtn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check me-2"></i>Copiado!';
        btn.classList.remove('btn-success');
        btn.classList.add('btn-outline-success');
        
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('btn-outline-success');
            btn.classList.add('btn-success');
        }, 2000);
    });
}

function exportarLog() {
    const log = document.getElementById('logAdquisicion').value;
    const blob = new Blob([log], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `adquisicion_forense_${new Date().toISOString().split('T')[0]}.log`;
    a.click();
    window.URL.revokeObjectURL(url);
}

    // ===== FUNCIONES DE ADQUISICIÓN CON AGENTE LOCAL =====

    async function iniciarAdquisicionConAgenteLocal(usuario, dispositivo, formato, destino, verificacionHash, compresion, verificacionIntegridad) {
        try {
            const agenteUrl = usuario.agente_url || 'http://localhost:5001';
            const apiKey = usuario.agente_api_key || 'forensic_agent_2024';
            
            // Determinar endpoint según formato
            let endpoint = '/acquire';
            if (formato === 'aff4') {
                endpoint = '/acquire-aff4';
            } else if (formato === 'e01') {
                endpoint = '/acquire-e01';
            } else if (formato === 'dd') {
                endpoint = '/acquire-dd';
            }
            
            const response = await fetch(`${agenteUrl}${endpoint}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    device_path: dispositivo,
                    output_name: destino.split('/').pop().split('\\').pop().replace(/\.[^/.]+$/, ''),
                    case_id: `CASE-${usuario.id || 'USER'}-${Date.now()}`
                })
            });

            const data = await response.json();
            
            if (data.success || data.status === 'success') {
                agregarLog(`✅ Adquisición ${formato.toUpperCase()} iniciada con Agente Local (${usuario.nombre})`);
                agregarLog(`📁 Archivo: ${data.output_path}`);
                agregarLog(`🆔 Operación: ${data.operation_id}`);
                
                // Monitorear progreso
                monitorearProgresoAgenteLocal(usuario, data.operation_id);
            } else {
                agregarLog(`❌ Error: ${data.error}`);
                // Fallback al stack forense
                await iniciarAdquisicionConStackForense(dispositivo, formato, destino, verificacionHash, compresion, verificacionIntegridad);
            }
        } catch (error) {
            agregarLog(`❌ Error de conexión con Agente Local: ${error.message}`);
            // Fallback al stack forense
            await iniciarAdquisicionConStackForense(dispositivo, formato, destino, verificacionHash, compresion, verificacionIntegridad);
        }
    }

    async function monitorearProgresoAgenteLocal(usuario, operationId) {
        const agenteUrl = usuario.agente_url || 'http://localhost:5001';
        const apiKey = usuario.agente_api_key || 'forensic_agent_2024';
        
        const interval = setInterval(async () => {
            try {
                const response = await fetch(`${agenteUrl}/acquire/${operationId}/status`, {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    }
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    const progress = data.progress || 0;
                    const agentStatus = data.agent_status || 'unknown';
                    
                    // Actualizar barra de progreso
                    document.getElementById('progresoAdquisicion').style.width = `${progress}%`;
                    document.getElementById('progresoAdquisicion').textContent = `${progress}%`;
                    
                    // Actualizar log
                    if (data.operation && data.operation.progress !== undefined) {
                        agregarLog(`📊 Progreso: ${progress}% - Estado: ${agentStatus}`);
                    }
                    
                    // Verificar si terminó
                    if (agentStatus === 'completed') {
                        clearInterval(interval);
                        agregarLog(`✅ Adquisición completada con Agente Local`);
                        if (data.operation && data.operation.hashes) {
                            agregarLog(`🔐 Hashes generados:`);
                            agregarLog(`   MD5: ${data.operation.hashes.md5}`);
                            agregarLog(`   SHA1: ${data.operation.hashes.sha1}`);
                            agregarLog(`   SHA256: ${data.operation.hashes.sha256}`);
                        }
                        finalizarAdquisicion();
                    } else if (agentStatus === 'error') {
                        clearInterval(interval);
                        agregarLog(`❌ Error en adquisición: ${data.operation?.error || 'Error desconocido'}`);
                        finalizarAdquisicion();
                    } else if (agentStatus === 'cancelled') {
                        clearInterval(interval);
                        agregarLog(`⏹️ Adquisición cancelada`);
                        finalizarAdquisicion();
                    }
                }
            } catch (error) {
                agregarLog(`❌ Error monitoreando progreso: ${error.message}`);
            }
        }, 2000);
    }
</script>
{% endblock %}
