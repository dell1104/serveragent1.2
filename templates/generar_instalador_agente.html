<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generar Instalador de Agente - Sistema Forense</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .hero-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 60px 0;
        }
        .card {
            border: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border-radius: 15px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            font-weight: 600;
        }
        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            font-weight: 600;
        }
        .feature-icon {
            font-size: 3rem;
            color: #667eea;
            margin-bottom: 1rem;
        }
        .step-number {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 1rem;
        }
        .loading {
            display: none;
        }
        .success-message {
            display: none;
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 1rem;
            border-radius: 0.375rem;
            margin-top: 1rem;
        }
        .error-message {
            display: none;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 1rem;
            border-radius: 0.375rem;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div class="hero-section">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-8">
                    <h1 class="display-4 fw-bold mb-3">
                        <i class="fas fa-download me-3"></i>
                        Generar Instalador de Agente
                    </h1>
                    <p class="lead mb-4">
                        Crea un instalador personalizado para el agente forense que se ejecutará en la máquina del usuario.
                    </p>
                </div>
                <div class="col-lg-4 text-center">
                    <i class="fas fa-laptop-code feature-icon"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="container my-5">
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <div class="card">
                    <div class="card-header bg-white">
                        <h3 class="card-title mb-0">
                            <i class="fas fa-cog me-2"></i>
                            Configuración del Instalador
                        </h3>
                    </div>
                    <div class="card-body">
                        <form id="installerForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="user_id" class="form-label">
                                            <i class="fas fa-user me-2"></i>
                                            ID del Usuario
                                        </label>
                                        <input type="text" class="form-control" id="user_id" 
                                               value="{{ current_user.id }}" readonly>
                                        <div class="form-text">ID único del usuario actual</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="server_url" class="form-label">
                                            <i class="fas fa-server me-2"></i>
                                            URL del Servidor
                                        </label>
                                        <input type="text" class="form-control" id="server_url" 
                                               value="{{ request.host_url.strip('/') }}" readonly>
                                        <div class="form-text">URL del servidor principal</div>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="token" class="form-label">
                                    <i class="fas fa-key me-2"></i>
                                    Token de Registro
                                </label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="token" 
                                           placeholder="Token único para el registro">
                                    <button class="btn btn-outline-secondary" type="button" id="generateToken">
                                        <i class="fas fa-sync-alt"></i>
                                        Generar
                                    </button>
                                </div>
                                <div class="form-text">Token único para registrar el agente en el servidor</div>
                            </div>

                            <div class="mb-4">
                                <label class="form-label">
                                    <i class="fas fa-cogs me-2"></i>
                                    Tipo de Instalador
                                </label>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="installer_type" 
                                                   id="installer_bat" value="bat" checked>
                                            <label class="form-check-label" for="installer_bat">
                                                <i class="fas fa-file-code me-2"></i>
                                                Instalador BAT
                                                <small class="d-block text-muted">Archivo .bat con interfaz gráfica simulada</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="installer_type" 
                                                   id="installer_exe" value="exe">
                                            <label class="form-check-label" for="installer_exe">
                                                <i class="fas fa-file-archive me-2"></i>
                                                Instalador EXE
                                                <small class="d-block text-muted">Archivo .exe compilado con PyInstaller</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary btn-lg" id="generateBtn">
                                    <i class="fas fa-download me-2"></i>
                                    Generar Instalador
                                </button>
                            </div>
                        </form>

                        <div class="loading text-center mt-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Generando...</span>
                            </div>
                            <p class="mt-2">Generando instalador personalizado...</p>
                        </div>

                        <div class="success-message" id="successMessage">
                            <i class="fas fa-check-circle me-2"></i>
                            ¡Instalador generado exitosamente! La descarga comenzará automáticamente.
                        </div>

                        <div class="error-message" id="errorMessage">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <span id="errorText">Error generando el instalador.</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-5">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-header bg-white">
                        <h3 class="card-title mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            ¿Qué incluye el instalador?
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="d-flex align-items-start">
                                    <div class="step-number">1</div>
                                    <div>
                                        <h5>Verificación de Python</h5>
                                        <p class="text-muted">Verifica que Python 3.7+ esté instalado en la máquina del usuario.</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex align-items-start">
                                    <div class="step-number">2</div>
                                    <div>
                                        <h5>Instalación de Dependencias</h5>
                                        <p class="text-muted">Instala automáticamente Flask, psutil, wmi y otras dependencias necesarias.</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex align-items-start">
                                    <div class="step-number">3</div>
                                    <div>
                                        <h5>Configuración del Agente</h5>
                                        <p class="text-muted">Configura el agente con la URL del servidor y token personalizado.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-4">
                            <div class="col-md-4">
                                <div class="d-flex align-items-start">
                                    <div class="step-number">4</div>
                                    <div>
                                        <h5>Servidor Local</h5>
                                        <p class="text-muted">Crea un servidor Flask local para comunicación con la aplicación.</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex align-items-start">
                                    <div class="step-number">5</div>
                                    <div>
                                        <h5>Acceso Directo</h5>
                                        <p class="text-muted">Crea un acceso directo en el escritorio para iniciar el agente.</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex align-items-start">
                                    <div class="step-number">6</div>
                                    <div>
                                        <h5>Configuración de Firewall</h5>
                                        <p class="text-muted">Configura automáticamente el firewall para permitir la comunicación.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Generar token automáticamente
        function generateToken() {
            const token = 'AGENTE_' + Math.random().toString(36).substr(2, 9).toUpperCase();
            document.getElementById('token').value = token;
        }

        // Generar token al cargar la página
        document.addEventListener('DOMContentLoaded', function() {
            generateToken();
        });

        // Botón para generar nuevo token
        document.getElementById('generateToken').addEventListener('click', generateToken);

        // Manejar envío del formulario
        document.getElementById('installerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const form = e.target;
            const generateBtn = document.getElementById('generateBtn');
            const loading = document.querySelector('.loading');
            const successMessage = document.getElementById('successMessage');
            const errorMessage = document.getElementById('errorMessage');
            
            // Ocultar mensajes anteriores
            successMessage.style.display = 'none';
            errorMessage.style.display = 'none';
            
            // Mostrar loading
            generateBtn.disabled = true;
            loading.style.display = 'block';
            
            try {
                const formData = new FormData(form);
                const installerType = document.querySelector('input[name="installer_type"]:checked').value;
                
                let endpoint;
                if (installerType === 'bat') {
                    endpoint = '/api/installer-agente/generate';
                } else {
                    endpoint = '/api/installer-agente/generate-exe';
                }
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: document.getElementById('user_id').value,
                        server_url: document.getElementById('server_url').value,
                        token: document.getElementById('token').value
                    })
                });
                
                if (response.ok) {
                    // Descargar archivo
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Instalador_Agente_Forense_${document.getElementById('user_id').value}.${installerType === 'bat' ? 'zip' : 'exe'}`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    window.URL.revokeObjectURL(url);
                    
                    // Mostrar mensaje de éxito
                    successMessage.style.display = 'block';
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Error generando instalador');
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('errorText').textContent = error.message;
                errorMessage.style.display = 'block';
            } finally {
                // Ocultar loading
                generateBtn.disabled = false;
                loading.style.display = 'none';
            }
        });
    </script>
</body>
</html>
