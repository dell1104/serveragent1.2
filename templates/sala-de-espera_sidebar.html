{% extends "base_sidebar.html" %}

{% block title %}Sala de Espera - Sistema Forense{% endblock %}

{% block page_title %}{% endblock %}

{% block content %}
<div class="fade-in">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-clock me-2"></i>Sala de Espera de Firmas
                    </h4>
                    <p class="text-muted mb-0 small">Gestiona las firmas pendientes de los casos activos</p>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" class="form-control" id="searchInput" placeholder="Buscar por expediente o caso...">
                            </div>
                        </div>
                        <div class="col-md-6 text-end">
                            <button class="btn btn-outline-primary" onclick="fetchPendingDocuments()">
                                <i class="fas fa-sync-alt me-2"></i>Actualizar
                            </button>
                        </div>
                    </div>
                    
                    <div id="pending-list"></div>
                    <div id="status-message" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-2 text-muted">Buscando documentos pendientes...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='utils.js') }}}"></script>
<script>
    // --- L√≥gica Espec√≠fica de la Sala de Espera ---
    
    const pendingList = document.getElementById('pending-list');
    const statusMessage = document.getElementById('status-message');
    const searchInput = document.getElementById('searchInput');
    let allCases = [];

    async function fetchPendingDocuments() {
        try {
            // Mostrar indicador de carga
            statusMessage.style.display = 'block';
            statusMessage.innerHTML = `
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mt-2 text-muted">Buscando documentos pendientes...</p>
            `;
            
            // Primero obtenemos los casos activos
            const casosResponse = await fetch(`${API_URL}/casos`);
            if (!casosResponse.ok) {
                throw new Error(`Error al obtener casos: ${casosResponse.statusText}`);
            }
            const casosData = await casosResponse.json();
            
            // Luego obtenemos las firmas pendientes
            const firmasResponse = await fetch(`${API_URL}/get-pending-signatures`);
            if (!firmasResponse.ok) {
                throw new Error(`Error al obtener firmas: ${firmasResponse.statusText}`);
            }
            const firmasData = await firmasResponse.json();
            
            pendingList.innerHTML = '';
            allCases = [];
            
            if (casosData.resultados && casosData.resultados.length > 0) {
                statusMessage.style.display = 'none';
                
                casosData.resultados.forEach(caso => {
                    const tieneFirmaPendiente = firmasData[caso.sesion_id];
                    const estadoFirma = tieneFirmaPendiente ? 
                        '<span class="badge bg-warning">Firma Pendiente</span>' : 
                        '<span class="badge bg-secondary">Sin Firma</span>';
                    
                    const casoData = {
                        ...caso,
                        tieneFirmaPendiente,
                        estadoFirma
                    };
                    
                    allCases.push(casoData);
                });
                
                // Filtrar casos seg√∫n b√∫squeda
                const filteredCases = filterCases(allCases);
                displayCases(filteredCases);
            } else {
                statusMessage.style.display = 'block';
                statusMessage.innerHTML = `
                    <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
                    <p class="text-muted">No hay casos activos en el sistema.</p>
                `;
            }
        } catch (error) {
            console.error('Error en fetchPendingDocuments:', error);
            statusMessage.style.display = 'block';
            statusMessage.innerHTML = `
                <i class="fas fa-exclamation-triangle fa-2x text-danger mb-3"></i>
                <p class="text-danger">Error de conexi√≥n con el servidor.</p>
            `;
        }
    }
    
    function filterCases(cases) {
        const searchTerm = searchInput.value.toLowerCase();
        if (!searchTerm) return cases;
        
        return cases.filter(caso => 
            caso.nombre_caso.toLowerCase().includes(searchTerm) ||
            caso.expediente.toLowerCase().includes(searchTerm) ||
            caso.sesion_id.toLowerCase().includes(searchTerm)
        );
    }
    
    function displayCases(cases) {
        pendingList.innerHTML = '';
        
        if (cases.length === 0) {
            pendingList.innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-search fa-2x text-muted mb-3"></i>
                    <p class="text-muted">No se encontraron casos que coincidan con la b√∫squeda.</p>
                </div>
            `;
            return;
        }
        
        cases.forEach(caso => {
            const linkHTML = `
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="card-title mb-0">
                                    <i class="fas fa-folder me-2"></i>${caso.nombre_caso}
                                </h6>
                                ${caso.estadoFirma}
                            </div>
                            <p class="card-text text-muted mb-2 small">
                                <strong>Expediente:</strong> ${caso.expediente}
                            </p>
                            <p class="card-text text-muted mb-2 small">
                                <strong>ID de Sesi√≥n:</strong> ${caso.sesion_id}
                            </p>
                            <p class="card-text text-muted mb-3 small">
                                <strong>Creado:</strong> ${new Date(caso.fecha_creacion).toLocaleDateString()}
                            </p>
                            <div class="d-grid gap-2">
                                ${caso.tieneFirmaPendiente ? 
                                    `<a class="btn btn-primary btn-sm" href="/portal/${caso.sesion_id}?session=${Object.keys(firmasData).find(key => firmasData[key].displayName.includes(caso.expediente))}">
                                        <i class="fas fa-external-link-alt me-1"></i>Ir al Portal de Evidencias
                                    </a>` :
                                    `<a class="btn btn-primary btn-sm" href="/portal/${caso.sesion_id}">
                                        <i class="fas fa-external-link-alt me-1"></i>Ir al Portal de Evidencias
                                    </a>`
                                }
                                ${caso.tieneFirmaPendiente ? 
                                    `<button class="btn btn-outline-info btn-sm" onclick="verDetallesFirma('${caso.sesion_id}')">
                                        <i class="fas fa-eye me-1"></i>Ver Detalles de Firma
                                    </button>` : 
                                    `<button class="btn btn-outline-secondary btn-sm" onclick="solicitarFirma('${caso.sesion_id}', '${caso.expediente}')">
                                        <i class="fas fa-signature me-1"></i>Solicitar Firma
                                    </button>`
                                }
                            </div>
                        </div>
                    </div>
                </div>`;
            pendingList.insertAdjacentHTML('beforeend', linkHTML);
        });
    }
    
    // Funci√≥n para solicitar firma desde la sala de espera
    async function solicitarFirma(sesionId, expediente) {
        try {
            const sessionId = "acta-" + Date.now();
            const response = await fetch(`${API_URL}/register-for-signing`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    sessionId: sessionId, 
                    displayName: `Firma para: ${expediente}` 
                })
            });
            
            if (response.ok) {
                // Mostrar notificaci√≥n de √©xito
                showNotification(`‚úÖ Firma solicitada para el expediente: ${expediente}`, 'success');
                // Recargar la lista
                fetchPendingDocuments();
            } else {
                throw new Error('Error al solicitar firma');
            }
        } catch (error) {
            console.error('Error al solicitar firma:', error);
            showNotification(`‚ùå Error al solicitar firma: ${error.message}`, 'error');
        }
    }
    
    // Funci√≥n para ver detalles de firma
    function verDetallesFirma(sesionId) {
        showNotification(`üìã Detalles de firma para sesi√≥n: ${sesionId}\n\nLa firma est√° pendiente. La persona debe ir al portal de evidencias para completarla.`, 'info');
    }
    
    // Funci√≥n para mostrar notificaciones
    function showNotification(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} alert-dismissible fade show position-fixed`;
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 350px; max-width: 500px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); border: 2px solid; font-weight: 500;';
        
        if (type === 'success') {
            alertDiv.style.borderColor = '#28a745';
            alertDiv.style.backgroundColor = '#d4edda';
        } else if (type === 'error') {
            alertDiv.style.borderColor = '#dc3545';
            alertDiv.style.backgroundColor = '#f8d7da';
        } else {
            alertDiv.style.borderColor = '#17a2b8';
            alertDiv.style.backgroundColor = '#d1ecf1';
        }
        
        alertDiv.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(alertDiv);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.parentNode.removeChild(alertDiv);
            }
        }, 5000);
    }

    // --- Inicializaci√≥n ---
    document.addEventListener('DOMContentLoaded', () => {
        fetchPendingDocuments();
        setInterval(fetchPendingDocuments, 30000); // Polling cada 30 segundos
        
        // B√∫squeda en tiempo real
        searchInput.addEventListener('input', () => {
            if (allCases.length > 0) {
                const filteredCases = filterCases(allCases);
                displayCases(filteredCases);
            }
        });
    });
</script>
{% endblock %}
