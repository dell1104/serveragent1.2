# Dockerfile para el stack forense con Python 3.9
FROM python:3.9-slim-bullseye

# Instalar dependencias del sistema necesarias para herramientas forenses
RUN apt-get update && apt-get install -y \
    build-essential \
    gcc \
    g++ \
    make \
    cmake \
    pkg-config \
    libffi-dev \
    libssl-dev \
    libpq-dev \
    libewf-dev \
    ewf-tools \
    afflib-tools \
    libmagic1 \
    libfuse-dev \
    libfuse2 \
    libsqlite3-dev \
    libxml2-dev \
    libxslt1-dev \
    zlib1g-dev \
    libbz2-dev \
    liblzma-dev \
    libncurses5-dev \
    libreadline-dev \
    libgdbm-dev \
    libnss3-dev \
    libtsk3-dev \
    libaff4-dev \
    libbde-dev \
    libvhdi-dev \
    libvmdk-dev \
    dcfldd \
    dc3dd \
    wget \
    curl \
    git \
    && rm -rf /var/lib/apt/lists/*

# Instalar Rust para cryptography
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
ENV PATH="/root/.cargo/bin:${PATH}"

# Crear directorio de trabajo
WORKDIR /app

# Copiar requirements específicos para el stack forense
COPY requirements_forensic.txt .

# Instalar dependencias de Python para herramientas forenses
RUN pip install --no-cache-dir --upgrade pip setuptools wheel && \
    pip install --no-cache-dir -r requirements_forensic.txt

# Instalar dependencias específicas (sin pyewf ni pyaff4)
RUN pip install --no-cache-dir \
    dfvfs \
    dfimagetools \
    pytsk3 \
    pycryptodome \
    cryptography

# Crear directorios necesarios
RUN mkdir -p /app/forensic_data /app/logs /app/temp

# Exponer puerto
EXPOSE 5001

# Comando por defecto
CMD ["python", "forensic_agent.py"]
